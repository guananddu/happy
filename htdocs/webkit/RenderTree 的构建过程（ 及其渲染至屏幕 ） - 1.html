<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-12-18 03:05:12 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-19 07:01:56 +0000"/><title>RenderTree 的构建过程（ 及其渲染至屏幕 ） - 1</title></head><body><div>首先回顾一下理论基础知识（<a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#The_flow_of_constructing_the_tree">https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#The_flow_of_constructing_the_tree</a>）： </div><div><p style="color: rgb(85, 85, 85); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">在 DOM 树构建的同时，浏览器还会构建另一个树结构：呈现树。这是由可视化元素按照其显示顺序而组成的树，也是文档的可视化表示。它的作用是让您按照正确的顺序绘制内容。
</p><div><p style="color: rgb(85, 85, 85); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">Firefox 将呈现树中的元素称为“框架”。WebKit 使用的术语是呈现器或呈现对象。 <br/>呈现器知道如何布局并将自身及其子元素绘制出来。 <br/>WebKits RenderObject 类是所有呈现器的基类，其定义如下：
</p><pre style="font-family: &quot;Source Code Pro&quot;, monospace; font-size: 15px; white-space: pre-wrap; word-wrap: break-word; color: white; background-color: rgb(68, 68, 68); padding: 1em; border-radius: 2px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="color: rgb(226, 137, 100);">class</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderObject</span><span style="color: rgb(255, 255, 255);">{</span><span style="color: rgb(255, 255, 255);">
  </span><span style="color: rgb(226, 137, 100);">virtual</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">void</span><span style="color: rgb(255, 255, 255);"> layout</span><span style="color: rgb(255, 255, 255);">();</span><span style="color: rgb(255, 255, 255);">
  </span><span style="color: rgb(226, 137, 100);">virtual</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">void</span><span style="color: rgb(255, 255, 255);"> paint</span><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(137, 189, 255);">PaintInfo</span><span style="color: rgb(255, 255, 255);">);</span><span style="color: rgb(255, 255, 255);">
  </span><span style="color: rgb(226, 137, 100);">virtual</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">void</span><span style="color: rgb(255, 255, 255);"> rect repaintRect</span><span style="color: rgb(255, 255, 255);">();</span><span style="color: rgb(255, 255, 255);">
  </span><span style="color: rgb(137, 189, 255);">Node</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> node</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">  </span><span style="color: rgb(174, 174, 174); font-style: italic;">//the DOM node</span><span style="color: rgb(255, 255, 255);">
  </span><span style="color: rgb(137, 189, 255);">RenderStyle</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> style</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">  </span><span style="color: rgb(174, 174, 174); font-style: italic;">// the computed style</span><span style="color: rgb(255, 255, 255);">
  </span><span style="color: rgb(137, 189, 255);">RenderLayer</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> containgLayer</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(174, 174, 174); font-style: italic;">//the containing z-index layer</span><span style="color: rgb(255, 255, 255);"
/><span style="color: rgb(255, 255, 255);">}</span></pre><p style="color: rgb(85, 85, 85); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">每一个呈现器都代表了一个矩形的区域，通常对应于相关节点的 CSS 框，这一点在 CSS2 规范中有所描述。它包含诸如宽度、高度和位置等几何信息。 <br/>框的类型会受到与节点相关的“display”样式属性的影响（请参阅<a style="color: rgb(80, 139, 136); text-decoration: underline;" href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#style_computation">样式计算</a>章节）。下面这段 WebKit 代码描述了根据 display 属性的不同，针对同一个 DOM 节点应创建什么类型的呈现器。
</p><pre style="font-family: &quot;Source Code Pro&quot;, monospace; font-size: 15px; white-space: pre-wrap; word-wrap: break-word; color: white; background-color: rgb(68, 68, 68); padding: 1em; border-radius: 2px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="color: rgb(137, 189, 255);">RenderObject</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderObject</span><span style="color: rgb(255, 255, 255);">::</span><span style="color: rgb(255, 255, 255);">createObject</span><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(137, 189, 255);">Node</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> node</span><span style="color: rgb(255, 255, 255);">,</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderStyle</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> style</span><span style="color: rgb(255, 255, 255);">)</span><span style="color: rgb(255, 255, 255);"
/><span style="color: rgb(255, 255, 255);">{</span><span style="color: rgb(255, 255, 255);">
    </span><span style="color: rgb(137, 189, 255);">Document</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> doc </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);"> node</span><span style="color: rgb(255, 255, 255);">-&gt;</span><span style="color: rgb(255, 255, 255);">document</span><span style="color: rgb(255, 255, 255);">();</span><span style="color: rgb(255, 255, 255);">
    </span><span style="color: rgb(137, 189, 255);">RenderArena</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> arena </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);"> doc</span><span style="color: rgb(255, 255, 255);">-&gt;</span><span style="color: rgb(255, 255, 255);">renderArena</span><span style="color: rgb(255, 255, 255);">();</span><span style="color: rgb(255, 255, 255);">
    </span><span style="color: rgb(255, 255, 255);">...</span><span style="color: rgb(255, 255, 255);">
    </span><span style="color: rgb(137, 189, 255);">RenderObject</span><span style="color: rgb(255, 255, 255);">*</span><span style="color: rgb(255, 255, 255);"> o </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(51, 135, 204);">0</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">

    </span><span style="color: rgb(226, 137, 100);">switch</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">style</span><span style="color: rgb(255, 255, 255);">-&gt;</span><span style="color: rgb(255, 255, 255);">display</span><span style="color: rgb(255, 255, 255);">())</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(255, 255, 255);">{</span><span style="color: rgb(255, 255, 255);">
        </span><span style="color: rgb(226, 137, 100);">case</span><span style="color: rgb(255, 255, 255);"> NONE</span><span style="color: rgb(255, 255, 255);">:</span><span style="color: rgb(255, 255, 255);">
            </span><span style="color: rgb(226, 137, 100);">break</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">
        </span><span style="color: rgb(226, 137, 100);">case</span><span style="color: rgb(255, 255, 255);"> INLINE</span><span style="color: rgb(255, 255, 255);">:</span><span style="color: rgb(255, 255, 255);">
            o </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">new</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">arena</span><span style="color: rgb(255, 255, 255);">)</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderInline</span><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">node</span><span style="color: rgb(255, 255, 255);">);</span><span style="color: rgb(255, 255, 255);">
            </span><span style="color: rgb(226, 137, 100);">break</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">
        </span><span style="color: rgb(226, 137, 100);">case</span><span style="color: rgb(255, 255, 255);"> BLOCK</span><span style="color: rgb(255, 255, 255);">:</span><span style="color: rgb(255, 255, 255);">
            o </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">new</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">arena</span><span style="color: rgb(255, 255, 255);">)</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderBlock</span><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">node</span><span style="color: rgb(255, 255, 255);">);</span><span style="color: rgb(255, 255, 255);">
            </span><span style="color: rgb(226, 137, 100);">break</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">
        </span><span style="color: rgb(226, 137, 100);">case</span><span style="color: rgb(255, 255, 255);"> INLINE_BLOCK</span><span style="color: rgb(255, 255, 255);">:</span><span style="color: rgb(255, 255, 255);">
            o </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">new</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">arena</span><span style="color: rgb(255, 255, 255);">)</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderBlock</span><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">node</span><span style="color: rgb(255, 255, 255);">);</span><span style="color: rgb(255, 255, 255);">
            </span><span style="color: rgb(226, 137, 100);">break</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">
        </span><span style="color: rgb(226, 137, 100);">case</span><span style="color: rgb(255, 255, 255);"> LIST_ITEM</span><span style="color: rgb(255, 255, 255);">:</span><span style="color: rgb(255, 255, 255);">
            o </span><span style="color: rgb(255, 255, 255);">=</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(226, 137, 100);">new</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">arena</span><span style="color: rgb(255, 255, 255);">)</span><span style="color: rgb(255, 255, 255);" /><span style="color: rgb(137, 189, 255);">RenderListItem</span><span style="color: rgb(255, 255, 255);">(</span><span style="color: rgb(255, 255, 255);">node</span><span style="color: rgb(255, 255, 255);">);</span><span style="color: rgb(255, 255, 255);">
            </span><span style="color: rgb(226, 137, 100);">break</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);">
       </span><span style="color: rgb(255, 255, 255);">...</span><span style="color: rgb(255, 255, 255);">
    </span><span style="color: rgb(255, 255, 255);">}</span><span style="color: rgb(255, 255, 255);">

    </span><span style="color: rgb(226, 137, 100);">return</span><span style="color: rgb(255, 255, 255);"> o</span><span style="color: rgb(255, 255, 255);">;</span><span style="color: rgb(255, 255, 255);"
/><span style="color: rgb(255, 255, 255);">}</span></pre><span style="color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">元素类型也是考虑因素之一，例如表单控件和表格都对应特殊的框架。 </span><div><span style="color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">在 WebKit 中，如果一个元素需要创建特殊的呈现器，就会替换 </span><code style="font-family: &quot;Source Code Pro&quot;, monospace; font-size: 18px; color: rgb(85, 85, 85); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">createRenderer</code><span style="color: rgb(85, 85, 85); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;">方法。呈现器所指向的样式对象中包含了一些和几何无关的信息。</span></div><h5 style="font-size: 18.9px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;; font-weight: 600; clear: both; max-width: 85%; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">呈现树和 DOM 树的关系
</h5><span style="color: rgb(85, 85, 85); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;">呈现器是和 DOM 元素相对应的，但并非一一对应。非可视化的 DOM 元素不会插入呈现树中，例如“head”元素。如果元素的 display 属性值为“none”，那么也不会显示在呈现树中（但是 visibility 属性值为“hidden”的元素仍会显示）。</span><p style=" color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">有一些 DOM 元素对应多个可视化对象。它们往往是具有复杂结构的元素，无法用单一的矩形来描述。例如，“select”元素有 3 个呈现器：一个用于显示区域，一个用于下拉列表框，还有一个用于按钮。如果由于宽度不够，文本无法在一行中显示而分为多行，那么新的行也会作为新的呈现器而添加。 <br/>另一个关于多呈现器的例子是格式无效的 HTML。根据 CSS 规范，inline 元素只能包含 block 元素或 inline 元素中的一种。如果出现了混合内容，则应创建匿名的 block 呈现器，以包裹 inline 元素。
</p><p style=" color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">有一些呈现对象对应于 DOM 节点，但在树中所在的位置与 DOM 节点不同。浮动定位和绝对定位的元素就是这样，它们处于正常的流程之外，放置在树中的其他地方，并映射到真正的框架，而放在原位的是占位框架。
</p><img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%20%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93%E8%87%B3%E5%B1%8F%E5%B9%95%20%EF%BC%89%20-%201.resources/2CE5A044-5E85-4B3E-A61D-C439E363A001.png" height="396" width="731"/>图：呈现树及其对应的 DOM 树 (<a style="color: rgb(80, 139, 136); text-decoration: underline;" href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#3_1">3.1</a>)。初始容器 block 为“viewport”，而在 WebKit 中则为“RenderView”对象。<h5 style="font-size: 18.9px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;; font-weight: 600; clear: both; max-width: 85%; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">构建呈现树的流程
</h5><p style=" color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在 Firefox 中，系统会针对 DOM 更新注册展示层，作为侦听器。展示层将框架创建工作委托给 <code style="font-family: &quot;Source Code Pro&quot;, monospace; font-size: 0.9em; color: rgb(51, 51, 51);">FrameConstructor</code>，由该构造器解析样式（请参阅<a style="color: rgb(80, 139, 136); text-decoration: underline;" href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#style">样式计算</a>）并创建框架。
</p><p style=" color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在 WebKit 中，解析样式和创建呈现器的过程称为“附加”。每个 DOM 节点都有一个“attach”方法。附加是同步进行的，将节点插入 DOM 树需要调用新的节点“attach”方法。
</p><p style=" color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">处理 html 和 body 标记就会构建呈现树根节点。这个根节点呈现对象对应于 CSS 规范中所说的容器 block，这是最上层的 block，包含了其他所有 block。它的尺寸就是视口，即浏览器窗口显示区域的尺寸。Firefox 称之为 <code style="font-family: &quot;Source Code Pro&quot;, monospace; font-size: 0.9em; color: rgb(51, 51, 51);">ViewPortFrame</code>，而 WebKit 称之为 <code style="font-family: &quot;Source Code Pro&quot;, monospace; font-size: 0.9em; color: rgb(51, 51, 51);">RenderView</code>。这就是文档所指向的呈现对象。呈现树的其余部分以 DOM 树节点插入的形式来构建。
</p></div><p style=" color: rgb(85, 85, 85); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">请参阅<a style="color: rgb(80, 139, 136); text-decoration: underline;" href="http://www.w3.org/TR/CSS21/intro.html#processing-model">关于处理模型的 CSS2 规范</a>。
</p><hr/></div><div><br/></div><div>webkit 在什么时候开始创建 RenderView?来看断点：</div><div><br/></div><div><img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%20%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93%E8%87%B3%E5%B1%8F%E5%B9%95%20%EF%BC%89%20-%201.resources/27A9B578-6A41-4280-94D7-BDEE2C5D951D.png" height="1258" width="1446"/><br/></div><div>在接收到 data 的同时，开始创建 RenderViewTree：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#11     0x00000001070bd354 in WebCore::Document::createRenderTree() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:2225</font></div><div><br/><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void Document::createRenderTree()</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(!renderView());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(!m_inPageCache);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(!m_axObjectCache || this != &amp;topDocument());</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (m_isNonRenderedPlaceholder)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::HTMLDocument *     0x1171b6600     0x00000001171b6600</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_renderView     WebCore::RenderPtr&lt;WebCore::RenderView&gt;     </font></span></span><br/></font></span></div><div><span><span>    // 断点断到了这一步</span><br/></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // FIXME: It would be better if we could pass the resolved document style directly here.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    m_renderView = createRenderer&lt;RenderView&gt;(*this, RenderStyle::create());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    Node::setRenderer(m_renderView.get());</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    renderView()-&gt;setIsInWindow(true);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    recalcStyle(Style::Force);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div></div><div><hr/>CSS 解析为 CSSOM 的过程并没有找到，由于调试的是 Webkit1 架构的程序，所以模型比较简单，初步调试，是在 WebCore::Document::finishedParsing 方法中开始初始化 RenderTree：</div><div><img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%20%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93%E8%87%B3%E5%B1%8F%E5%B9%95%20%EF%BC%89%20-%201.resources/DA3A907F-2C26-480C-86FF-04722B600325.png" height="1280" width="1458"/><br/></div><div>因此接下来的章节将从此函数开始，一探究竟：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001070ca4d4 in WebCore::Document::finishedParsing() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:5017</font></div></div><div><br/></div><div>当执行至此函数中时，DOM 的构建已经完成，有几个有意思的时间及其事件触发节点：</div><div><img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%20%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93%E8%87%B3%E5%B1%8F%E5%B9%95%20%EF%BC%89%20-%201.resources/323F5077-C29A-4010-A5A3-69EE924373CC.png" height="598" width="1796"/><br/></div><div>这里记录了 domContentLoadedEventStart 和 domContentLoadedEventEnd 的两个时间节点。同时，在这里触发了 DOMContentLoadedEvent 事件，需要注意的是，在此事件触发时，页面中的外链形式的 css／js／image 都已经被加载好了，总之，这是一个简单的浏览器模型，并不和标准规范相匹配：</div><div><img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%20%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93%E8%87%B3%E5%B1%8F%E5%B9%95%20%EF%BC%89%20-%201.resources/2F893DE4-6757-4C93-9C5D-ABB44C79B0AF.png" height="218" width="1342"/><br/></div><div>标准的规范定义：</div><div><font style="font-size: 18px;"><span style="color: rgb(59, 60, 64); font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;">The </span><code style="padding: 0px; border: 0px; font-style: normal; font-weight: normal; font-family: Consolas, 'Liberation Mono', Courier, monospace; word-wrap: break-word; color: rgb(59, 60, 64); font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">DOMContentLoaded</code><span style="color: rgb(59, 60, 64); font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;"> event is fired when the initial HTML document has been completely loaded and parsed, without waiting for stylesheets, images, and subframes to finish loading. A very different event </span><a style="padding: 0px; border: 0px; color: rgb(33, 122, 192); text-decoration: none; font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" href="https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/load"><code style=" padding: 0px; border: 0px; font-style: inherit; font-weight: inherit; font-family: Consolas, 'Liberation Mono', Courier, monospace; word-wrap: break-word;">load</code></a><span style="color: rgb(59, 60, 64); font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;"> should be used only to detect a fully-loaded page. It is an incredibly popular mistake to use </span><a style="padding: 0px; border: 0px; color: rgb(33, 122, 192); text-decoration: none; font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" href="https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/load"><code style=" padding: 0px; border: 0px; font-style: inherit; font-weight: inherit; font-family: Consolas, 'Liberation Mono', Courier, monospace; word-wrap: break-word;">load</code></a><span style="color: rgb(59, 60, 64); font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> where </span><code style="padding: 0px; border: 0px; font-style: normal; font-weight: normal; font-family: Consolas, 'Liberation Mono', Courier, monospace; word-wrap: break-word; color: rgb(59, 60, 64); font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">DOMContentLoaded</code><span style="color: rgb(59, 60, 64); font-family: 'Open Sans', Arial, sans-serif; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;"> would be much more appropriate, so be cautious.</span></font></div><div>但是这里先不关心这些标准规范。</div><div><hr/></div><div>之后，开始第一次执行 updateStyleIfNeeded() 函数：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001070ca671 in WebCore::Document::finishedParsing() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:5041</font></div><div><br/></div><div><span>    . . .</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (RefPtr&lt;Frame&gt; f = frame()) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // FrameLoader::finishedParsing() might end up calling Document::implicitClose() if all</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // resource loads are complete. HTMLObjectElements can start loading their resources from</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // post attach callbacks triggered by recalcStyle().  This means if we parse out an &lt;object&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // tag and then reach the end of the document without updating styles, we might not have yet</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // started the resource load and might fire the window load event too early.  To avoid this</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // we force the styles to be up to date before calling FrameLoader::finishedParsing().</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // See https://bugs.webkit.org/show_bug.cgi?id=36864 starting around comment 35.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 断点进入这里</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        updateStyleIfNeeded();</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        f-&gt;loader().finishedParsing();</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        InspectorInstrumentation::domContentLoadedEventFired(*f);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font><br/></div><div><span>    . . .</span><br/></div></div><div><br/></div><div>最终进入：</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001070ba2be in WebCore::Document::recalcStyle(WebCore::Style::Change) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:1819</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// 此函数体比较长，只注意几个关键节点：</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// this     WebCore::HTMLDocument *     0x1170b4000     0x00000001170b4000</font><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// 标记置位</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_inStyleRecalc = true; // 标记说明 Document 已经开始样式计算过程</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">bool updatedCompositingLayers = false;</font><br/></div><div><font face="Monaco">// 进入块级作用域逻辑</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 这两个是神马玩意儿？</span><br/></font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    Style::PostResolutionCallbackDisabler disabler(*this);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    WidgetHierarchyUpdatesSuspensionScope suspendWidgetHierarchyUpdates;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">change     WebCore::Style::Change     Force</font></span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (m_pendingStyleRecalcShouldForce)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        change = Style::Force;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">change     WebCore::Style::Change     Force</font></span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (change == Style::Force) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // This may get set again during style resolve.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        m_hasNodesWithPlaceholderStyle = false;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>    <span>    // 这里需要注意一下</span></span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span><span><span>    <span>    // 开始为 document dom 元素创建样式对象</span></span><br/></span></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        auto documentStyle = Style::resolveForDocument(*this);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // Inserting the pictograph font at the end of the font fallback list is done by the</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // font selector, so set a font selector if needed.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (Settings* settings = this-&gt;settings()) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            if (settings-&gt;fontFallbackPrefersPictographs())</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">                documentStyle.fontCascade().update(&amp;fontSelector());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>    <span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">documentChange     WebCore::Style::Change     NoChange</font></span></span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        auto documentChange = Style::determineChange(documentStyle, m_renderView-&gt;style());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (documentChange != Style::NoChange)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            renderView()-&gt;setStyle(WTFMove(documentStyle));</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>    // ✨【重点突破点】✨</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    Style::TreeResolver resolver(*this);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto styleUpdate = resolver.resolve(change);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    clearNeedsStyleRecalc();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    clearChildNeedsStyleRecalc();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    unscheduleStyleRecalc();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    m_inStyleRecalc = false;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (styleUpdate) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        TemporaryChange&lt;bool&gt; inRenderTreeUpdate(m_inRenderTreeUpdate, true);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        RenderTreeUpdater updater(*this);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // ✨【重点突破点】<font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">最终进入这里开始循环遍历</font>✨</span></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        updater.commit(WTFMove(styleUpdate));</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    updatedCompositingLayers = frameView.updateCompositingLayersAfterStyleChange();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div></div><div><br/></div><div>🌟为 document 节点创建样式对象：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#1     0x00000001070ba4a8 in WebCore::Document::recalcStyle(WebCore::Style::Change) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:1864</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x0000000108be996b in WebCore::Style::resolveForDocument(WebCore::Document const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/style/StyleResolveForDocument.cpp:58</font></div><div><br/></div><div>// 可以理解，此函数应该为一个静态函数</div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">RenderStyle resolveForDocument(const Document&amp; document)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{<span>   </span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // 确保 document 有自己的 RenderView 对象</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(document.hasLivingRenderTree());</font></div><div><span>    // 获取 renderView 对象</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    RenderView&amp; renderView = *document.renderView();</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">documentStyle     WebCore::RenderStyle     </font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto documentStyle = RenderStyle::create();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 看起结构：</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">noninherited_flags     WebCore::RenderStyle::NonInheritedFlags     【新设置的值会写在这里】</font></span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">inherited_flags     WebCore::RenderStyle::InheritedFlags     【会继承一些默认属性值】</font></span><br/></font></span></span></font></div><div><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%20%E5%8F%8A%E5%85%B6%E6%B8%B2%E6%9F%93%E8%87%B3%E5%B1%8F%E5%B9%95%20%EF%BC%89%20-%201.resources/A629F842-D77C-4881-99DD-CE58DDE9D54B.png" height="232" width="647"/><br/></span><br/></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_flags     uint64_t     256</font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    documentStyle.setDisplay(BLOCK);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    documentStyle.setRTLOrdering(document.visuallyOrdered() ? VisualOrder : LogicalOrder);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 设置缩放级别</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    documentStyle.setZoom(!document.printing() ? renderView.frame().pageZoomFactor() : 1);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    . . .</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docElement     WebCore::HTMLHtmlElement *     0x124e3cd68     0x0000000124e3cd68</font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    Element* docElement = document.documentElement();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    RenderObject* docElementRenderer = docElement ? docElement-&gt;renderer() : nullptr;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docElementRenderer     WebCore::RenderObject *     NULL     0x0000000000000000</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (docElementRenderer) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">pagination     const WebCore::Pagination &amp;     0x00000001169f8110</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">mode     WebCore::Pagination::Mode     Unpaginated</font></span></span><br/></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    const Pagination&amp; pagination = renderView.frameView().pagination();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (pagination.mode != Pagination::Unpaginated) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">settings     const WebCore::Settings &amp;     0x00000001153c1000</font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    const Settings&amp; settings = renderView.frame().settings();</font></div><div><span>    // 以下为设置字体相关</span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    FontCascadeDescription fontDescription;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    fontDescription.setLocale(document.contentLanguage());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    fontDescription.setRenderingMode(settings.fontRenderingMode());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    fontDescription.setOneFamily(standardFamily);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    fontDescription.setKeywordSizeFromIdentifier(CSSValueMedium);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    int size = fontSizeForKeyword(CSSValueMedium, false, document);</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">size     int     16</font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    fontDescription.setSpecifiedSize(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 设置字体属性结束</span><br/></font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    documentStyle.setFontDescription(fontDescription);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    documentStyle.fontCascade().update(&amp;const_cast&lt;Document&amp;&gt;(document).fontSelector());</font></div><div><span>    // 最终将初始化好的 documentStyle 对象返回</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return documentStyle;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font></div><div><br/><br/></div></div><div><hr/>开始进入渲染树更新阶段：</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x000000010886f05d in WebCore::RenderTreeUpdater::commit(std::__1::unique_ptr&lt;WebCore::Style::Update, std::__1::default_delete&lt;WebCore::Style::Update&gt; &gt;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/style/RenderTreeUpdater.cpp:98</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void RenderTreeUpdater::commit(std::unique_ptr&lt;Style::Update&gt; styleUpdate)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(&amp;m_document == &amp;styleUpdate-&gt;document());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!m_document.shouldCreateRenderers() || !m_document.renderView())</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    m_styleUpdate = WTFMove(styleUpdate);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    for (auto* root : findRenderingRoots(*m_styleUpdate))</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 进入这里 </span></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">root     WebCore::HTMLDocument *     0x116f7f600     0x0000000116f7f600</font></span></span><br/></span></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        updateRenderTree(*root);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    m_styleUpdate = nullptr;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x000000010886f35c in WebCore::RenderTreeUpdater::updateRenderTree(WebCore::ContainerNode&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/style/RenderTreeUpdater.cpp:115</font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void RenderTreeUpdater::updateRenderTree(ContainerNode&amp; root)</font></font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::RenderTreeUpdater *     0x7fff5fbfce60     0x00007fff5fbfce60</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">root     WebCore::HTMLDocument &amp;     0x0000000116f7f600</font></span><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_parentStack     WTF::Vector&lt;WebCore::RenderTreeUpdater::Parent, 0, WTF::CrashOnOverflow, 16&gt;     </font></span><br/></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(root.renderer());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(m_parentStack.isEmpty());</font></div><div><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    m_parentStack.append(Parent(root));</font><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">. . .</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"/></div><div><br/></div><div>进入下一节再具体分析</div><div><br/></div></body></html>