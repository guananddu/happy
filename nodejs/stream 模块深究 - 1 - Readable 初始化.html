<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2016-12-29 13:24:52 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-01-04 03:13:32 +0000"/><title>stream æ¨¡å—æ·±ç©¶ - 1 - Readable åˆå§‹åŒ–</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>stream æ¨¡å—æ·±ç©¶ - 1 - Readable åˆå§‹åŒ–</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>ä»æœ¬èŠ‚å¼€å§‹å­¦ä¹  stream æ¨¡å—ç›¸å…³çš„å®ç°ç»†èŠ‚ï¼Œæœ¬èŠ‚å…ˆçœ‹ stream.Readable ç±»çš„å®ç°ç»†èŠ‚å’Œç”¨æ³•ã€‚å…ˆæ¥çœ‹æµ‹è¯•ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">const </span>fs = require( <span style="color:#6a8759;">'fs' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>path = require( <span style="color:#6a8759;">'path' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>stream = require( <span style="color:#6a8759;">'stream' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;font-weight:bold;">const </span>filePath = path.<span style="color:#ffc66d;">resolve</span>( __dirname<span style="color:#cc7832;">, </span><span style="color:#6a8759;">'bigfile.txt' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;font-weight:bold;">const </span>readable = fs.<span style="color:#ffc66d;">createReadStream</span>( filePath<span style="color:#cc7832;">, </span>{<br/>Â Â Â  <span style="color:#9876aa;">flags</span>: <span style="color:#6a8759;">'r'</span><span style="color:#cc7832;">,<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#9876aa;">encoding</span>: <span style="color:#6a8759;">'utf8'</span><span style="color:#cc7832;">,<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#9876aa;">fd</span>: <span style="color:#cc7832;font-weight:bold;">null</span><span style="color:#cc7832;">,<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#9876aa;">mode</span>: <span style="color:#6897bb;">0o666</span><span style="color:#cc7832;">,<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#9876aa;">autoClose</span>: <span style="color:#cc7832;font-weight:bold;">true</span><span style="color:#cc7832;">,<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#808080;">// Be aware that, unlike the default value set for highWaterMark on a<br/></span><span style="color:#808080;">Â Â Â  // readable stream (16 kb), the stream returned by this method has a<br/></span><span style="color:#808080;">Â Â Â  // default value of 64 kb for the same parameter.<br/></span><span style="color:#808080;">Â Â Â  </span><span style="color:#9876aa;">highWaterMark</span>: <span style="color:#6897bb;">20000<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">setEncoding</span>( <span style="color:#6a8759;">'utf8' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'open'</span><span style="color:#cc7832;">, </span>() =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`!readable: open event.` </span>)<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'readable'</span><span style="color:#cc7832;">, </span>() =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`!readable: readable event.` </span>)<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'data'</span><span style="color:#cc7832;">, </span>( chunk ) =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`readable: received </span>${chunk.<span style="color:#9876aa;">length</span>}<span style="color:#6a8759;"> bytes of data.` </span>)<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'close'</span><span style="color:#cc7832;">, </span>() =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`!readable: close` </span>)<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'end'</span><span style="color:#cc7832;">, </span>() =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`!readable: there will be no more data.` </span>)<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;<br/></span>
</pre></div><div>ä»£ç è¿è¡Œåçš„è¾“å‡ºä¸ºï¼š<br/></div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">!readable: open event.</font><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">readable: received 20000 bytes of data.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">readable: received 20000 bytes of data.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">readable: received 19798 bytes of data.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">!readable: readable event.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">!readable: there will be no more data.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">!readable: close</font><br/></div></div><div><br/></div><div>å¼€å§‹æ–­ç‚¹è°ƒè¯•ï¼Œé¦–å…ˆç•™æ„ fs.createReadStream å‡½æ•°ï¼Œfs æ¨¡å—ç»†èŠ‚å…ˆä¸æ·±ç©¶ï¼Œä¹‹åä¼šåˆ›å»ºæ–°çš„æ–‡ç« æ¥åˆ†æ fs æ¨¡å—å®ç°ã€‚fs.createReadStream å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨æ­¤ Readable Stream åˆ°åº•æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Œéƒ½æœ‰å“ªäº›ç»†èŠ‚ç‚¹ï¼š</div><div><br/></div><div>fs.createReadStream å‡½æ•°åœ¨å†…éƒ¨ç›´æ¥ return new ReadStream( path, optionsÂ )ï¼Œåœ¨ fs.js æ¨¡å—å†…éƒ¨ï¼ŒReadStream ç›´æ¥ç»§æ‰¿äº† Stream.Readableï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="background-color:#344134;">util</span>.inherits(ReadStream<span style="color:#cc7832;">, </span>Readable)<span style="color:#cc7832;">;<br/></span>fs.ReadStream = ReadStream<span style="color:#cc7832;">;</span>
</pre></div><div>åœ¨ fs.js ä¸­çš„ ReadStream æ„é€ å‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ªå…³äºÂ highWaterMark å‚æ•°çš„ç»†èŠ‚ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// a little bit bigger buffer and water marks by default<br/></span>options = Object.create(options)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">if </span>(options.highWaterMark === undefined)<br/>Â  options.highWaterMark = <span style="color:#6897bb;">64 </span>* <span style="color:#6897bb;">1024</span><span style="color:#cc7832;">;</span>
</pre></div><div>å³ï¼Œé»˜è®¤çš„ Readable çš„ highWaterMark ä¸º 64kb å¤§å°ã€‚æµ‹è¯•ä»£ç ä¼ å…¥çš„æ˜¯Â 20000 å­—èŠ‚å¤§å°ã€‚</div><div><br/></div><div>å†å¾€ä¸‹ï¼Œå°±ä¼šæœ‰ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="background-color:#344134;">Readable</span>.call(<span style="color:#cc7832;font-weight:bold;">this</span><span style="color:#cc7832;">, </span>options)<span style="color:#cc7832;">;</span>
</pre>çˆ¶ç±»æ„é€ å‡½æ•°çš„è°ƒç”¨ï¼Œæˆ‘ä»¬è·Ÿè¿›æ­¤å‡½æ•°è°ƒç”¨å†…ï¼Œæ­¤ Readable.call( this, optionsÂ ) çš„æ„é€ å‡½æ•°è°ƒç”¨ï¼Œçš„ä½ç½®åœ¨ï¼šnode/lib/_stream_readable.js ä¸­ï¼Œæ­¤æ„é€ å‡½æ•°æ¯”è¾ƒç®€ç•¥ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function Readable(options) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!(this instanceof Readable))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return new Readable(options);</font></div><div>Â  // æ­¤æ—¶çš„ options: { }</div><div><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">â€Œâ€ŒJSON.stringify(options.__proto__)</font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">â€Œ Â // {"flags":"r","encoding":"utf8","fd":null,"mode":438,"autoClose":true,"highWaterMark":20000}</font><span/><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ä» ReadableState å¯¹è±¡çš„æ„é€ æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ª<font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">ç”¨æ¥è®°å½•çŠ¶æ€çš„</font>å¤æ‚å¯¹è±¡</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this._readableState = new ReadableState(options, this);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // legacy</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.readable = true;</font></div><div><span>Â  // å¦‚æœæä¾›äº† options.read å‡½æ•°ï¼Œåˆ™ç”¨æ¥æ›¿ä»£ this._read å†…éƒ¨å‡½æ•°</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (options &amp;&amp; typeof options.read === 'function')</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this._read = options.read;</font></div><div><span>Â  // EE.call( this )ã€ç»§æ‰¿ EventEmitterã€‘å…³äº EventEmitter ä¹‹åä¸“é—¨å¼€è¾Ÿç« èŠ‚ä»‹ç»</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Stream.call(this);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>ReadableState å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œæ³¨æ„é‡Œé¢çš„ä¸€äº›æ³¨é‡Šï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function ReadableState(options, stream) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â options = options || {};</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // object stream flag. Used to make read(n) ignore n and to</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // make all the buffer merging and length checks go away</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.objectMode = !!options.objectMode;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (stream instanceof Stream.Duplex)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this.objectMode = this.objectMode || !!options.readableObjectMode;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // the point at which it stops calling _read() to fill the buffer</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Note: 0 is a valid value, means "don't call _read preemptively ever"</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var hwm = options.highWaterMark;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var defaultHwm = this.objectMode ? 16 : 16 * 1024;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.highWaterMark = (hwm || hwm === 0) ? hwm : defaultHwm;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // cast to ints.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.highWaterMark = ~~this.highWaterMark;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // A linked list is used to store data chunks instead of an array because the</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // linked list can remove elements from the beginning faster than</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // array.shift()</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è¿™é‡Œæ³¨æ„ ğŸŒŸ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.buffer = new BufferList();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.length = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.pipes = null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.pipesCount = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.flowing = null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.ended = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.endEmitted = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.reading = false;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // a flag to be able to tell if the onwrite cb is called immediately,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // or on a later tick.Â Â We set this to true at first, because any</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // actions that shouldn't happen until "later" should generally also</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // not happen before the first write call.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.sync = true;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // whenever we return null, then we set a flag to say</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // that we're awaiting a 'readable' event emission.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.needReadable = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.emittedReadable = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.readableListening = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.resumeScheduled = false;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Crypto is kind of old and crusty.Â Â Historically, its default string</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // encoding is 'binary' so we have to make this configurable.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Everything else in the universe uses 'utf8', though.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.defaultEncoding = options.defaultEncoding || 'utf8';</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // when piping, we only care about 'readable' events that happen</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // after read()ing all the bytes and not getting any pushback.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.ranOut = false;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // the number of writers that are awaiting a drain event in .pipe()s</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.awaitDrain = 0;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // if true, a maybeReadMore has been scheduled</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.readingMore = false;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.decoder = null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â this.encoding = null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (options.encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (!StringDecoder)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â StringDecoder = require('string_decoder').StringDecoder;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ğŸŒŸå…³äº StringDecoder çš„å®ç°ç»†èŠ‚è¯·çœ‹ç‹¬ç«‹ç« èŠ‚</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this.decoder = new StringDecoder(options.encoding);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this.encoding = options.encoding;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>fs.js ä¸­çš„ ReadStream æ„é€ å‡½æ•°åœ¨æ‰§è¡Œå®Œçˆ¶çº§æ„é€ å‡½æ•° Readable.call( this, optionsÂ ) ä¹‹åç»§ç»­å¾€åæ‰§è¡Œç›¸å…³åˆå§‹åŒ–ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">if </span>(<span style="color:#cc7832;font-weight:bold;">typeof this</span>.fd !== <span style="color:#6a8759;">'number'</span>)<br/>Â  <span style="color:#cc7832;font-weight:bold;">this</span>.open()<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;font-weight:bold;">this</span>.on(<span style="color:#6a8759;">'end'</span><span style="color:#cc7832;">, </span><span style="color:#cc7832;font-weight:bold;">function</span>() {<br/>Â  <span style="color:#cc7832;font-weight:bold;">if </span>(<span style="color:#cc7832;font-weight:bold;">this</span>.autoClose) {<br/>Â Â Â  <span style="color:#cc7832;font-weight:bold;">this</span>.destroy()<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â  </span>}<br/>})<span style="color:#cc7832;">;</span>
</pre>å› ä¸ºå¹¶æ²¡æœ‰ä¼ å…¥ this.fd å‚æ•°ï¼Œè¿™é‡Œçš„ this.fs == nullï¼Œæ‰€ä»¥è¿›å…¥ï¼šthis.open() å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">ReadStream.prototype.open = function() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var self = this;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è°ƒç”¨ fs.open å¼‚æ­¥æ–¹æ³•ï¼Œfs ä¸­çš„å…·ä½“æ–¹æ³•è°ƒç”¨åœ¨è¿™ä¸€èŠ‚å…ˆä¸è¯¦è¿°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â fs.open(this.path, this.flags, this.mode, function(er, fd) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (er) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  Â  // å‘ç”Ÿé”™è¯¯çš„æƒ…å†µ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  // é»˜è®¤çš„ self.autoClose == true</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â if (self.autoClose) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â self.destroy();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â self.emit('error', er);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â return;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><span>Â  Â  // æ­£ç¡®æ‰“å¼€æ–‡ä»¶ï¼Œå°†æ–‡ä»¶æè¿°ç¬¦è¿”å›å¹¶å­˜å‚¨</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â self.fd = fd;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // è§¦å‘ open äº‹ä»¶</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â self.emit('open', fd);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // start the flow of data.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â self.read();ğŸŒŸ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â });</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>é¡ºåˆ©æ‰“å¼€çš„æƒ…å†µä¸‹ï¼Œ`open` äº‹ä»¶åœ¨ç¬¬ä¸€æ—¶é—´è¢«è§¦å‘ï¼Œåé¢å†æ¥çœ‹å‡ ä¸ªäº‹ä»¶çš„è¯¦ç»†è§¦å‘æµç¨‹ã€‚<br/></div><div><br/></div><div>ä¹‹åï¼Œå¼€å§‹è°ƒç”¨ self.read() å‡½æ•°ï¼Œä¹‹åè¯¦è¿°ï¼Œæ•¬è¯·æœŸå¾…ï½</div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šWed Jan 04 2017 11:16:09 GMT+0800 (CST)</p>
</div></body></html>