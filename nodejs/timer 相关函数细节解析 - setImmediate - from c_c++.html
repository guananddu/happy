<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-11-11 08:01:30 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-11-14 03:51:59 +0000"/><title>timer 相关函数细节解析 - setImmediate - from c/c++</title></head><body><div>本节回答上一节最后的关键疑问</div><div>js层面的关键点在这里，在我们调用setImmediate函数的时候，会有此个逻辑：</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">if </span>(!<span style="color:#9876aa;">process</span>.<span style="color:#9876aa;">_needImmediateCallback</span>) {<br/>  <span style="color:#9876aa;">process</span>.<span style="color:#9876aa;">_needImmediateCallback </span>= <span style="color:#cc7832;font-weight:bold;">true</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">  </span><span style="color:#9876aa;">process</span>.<span style="color:#ffc66d;">_immediateCallback </span>= <span style="color:#ffc66d;">processImmediate</span><span style="color:#cc7832;">;<br/></span>}
</pre></div><div>在node的c/c++源代码：/Users/mrguan/work/build/node/node-6.6.0/src/node.cc:3230:      FIXED_ONE_BYTE_STRING(env-&gt;isolate(), "_needImmediateCallback”);的位置如下：</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">auto need_immediate_callback_string =</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    FIXED_ONE_BYTE_STRING(env-&gt;isolate(), "_needImmediateCallback”);</font></div><div><font face="Monaco">// 这里设置了process对象中，<font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">_needImmediateCallback属性被设置或者获取时候的回调函数</font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">CHECK(process-&gt;SetAccessor(env-&gt;context(), need_immediate_callback_string,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">                           NeedImmediateCallbackGetter,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <span>    <span>    <span>    <span>    <span>   // 我们主要关注setter</span></span></span></span></span></span></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">                           NeedImmediateCallbackSetter,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">                           env-&gt;as_external()).FromJust());</font><br/></div></div><div><br/></div><div>在js层次设置 process 的 _needImmediateCallback 属性的时候，NeedImmediateCallbackSetter就会被调用：</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">static void NeedImmediateCallbackSetter(</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    Local&lt;Name&gt; property,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    Local&lt;Value&gt; value,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    const PropertyCallbackInfo&lt;void&gt;&amp; info) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  Environment* env = Environment::GetCurrent(info);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 获取 immediate_check_handle</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  uv_check_t* immediate_check_handle = env-&gt;immediate_check_handle();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 检查此immediate_check_handle是否处于激活状态</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  bool active = uv_is_active(</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      reinterpret_cast&lt;const uv_handle_t*&gt;(immediate_check_handle));</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 判断继续的条件</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (active == value-&gt;BooleanValue())</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  uv_idle_t* immediate_idle_handle = env-&gt;immediate_idle_handle();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 如果已经处于激活状态的话，那么走到这里肯定是要结束</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (active) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv_check_stop(immediate_check_handle);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv_idle_stop(immediate_idle_handle);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  } else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 否则要继续开始，此处调试，先进入此分支</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv_check_start(immediate_check_handle, CheckImmediate);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Idle handle is needed only to stop the event loop from blocking in poll.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv_idle_start(immediate_idle_handle, IdleImmediateDummy);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div><div><font face="Monaco"><hr/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">int uv_is_active(const uv_handle_t* handle) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  return uv__is_active(handle);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div><div><font face="Monaco"><hr/></font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#define uv__is_active(h)                                                      \</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  (((h)-&gt;flags &amp; UV__HANDLE_ACTIVE) != 0)</font><font face="Monaco"><br/></font></div><div><font face="Monaco">// uv__is_active 是一个宏</font></div><div><font face="Monaco"/></div></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#ifndef _WIN32</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">enum {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 不同的标识位代表不同的含义</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  UV__HANDLE_INTERNAL = 0x8000, // 位15</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  UV__HANDLE_ACTIVE   = 0x4000, // 位14</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  UV__HANDLE_REF      = 0x2000, // 位13</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  UV__HANDLE_CLOSING  = 0 /* no-op on unix */</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#else</font><br/></div><div><font face="Monaco">...</font></div></div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">接着看宏：</div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">UV_LOOP_WATCHER_DEFINE(check, CHECK)</font><font style="font-size: 12px; color: rgb(51, 51, 51);" face="Monaco, Menlo, Consolas, Courier New, monospace">：</font></div><div><font><hr style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51); font-size: 12px;"/><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">#define UV_LOOP_WATCHER_DEFINE(name, type)                                    \<br/>  int uv_##name##_init(uv_loop_t* loop, uv_##name##_t* handle) {              \<br/>    uv__handle_init(loop, (uv_handle_t*)handle, UV_##type);                   \<br/>    handle-&gt;name##_cb = NULL;                                                 \<br/>    return </span><span style="font-family: Menlo; color: rgb(139, 132, 207); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">0</span><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">;                                                                 \<br/>  }                                                                           \<br/>                                                                              \<br/>  int uv_##name##_start(uv_##name##_t* handle, uv_##name##_cb cb) {           \</span></font></div><div><font><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><span>    // 先判断是不是已经处于激活状态，与上面相同</span><br/>    if (uv__is_active(handle)) return </span><span style="font-family: Menlo; color: rgb(139, 132, 207); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">0</span><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">;                                      \</span></font></div><div><font><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><span>    // 回调函数不能为空</span><br/>    if (cb == NULL) return -EINVAL;                                           \</span></font></div><div><font><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><span>    // 开始插入队列【仍旧是典型的双向链表结构是，将此节点插入至最新的位置】</span></span></font></div><div><font><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><span>    // &amp;handle-&gt;loop-&gt;check/idle_handles</span><br/>    QUEUE_INSERT_HEAD(&amp;handle-&gt;loop-&gt;name##_handles, &amp;handle-&gt;queue);         \</span></font></div><div><font><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><span>    // 设置回调函数</span><br/>    handle-&gt;name##_cb = cb;                                                   \</span></font></div><div><font><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><span>    // 开始标记为start</span><br/>    uv__handle_start(handle);                                                 \<br/>    return </span><span style="font-family: Menlo; color: rgb(139, 132, 207); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">0</span><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">;                                                                 \<br/>  }                                                                           \<br/>                                                                              \<br/>  int uv_##name##_stop(uv_##name##_t* handle) {                               \<br/>    if (!uv__is_active(handle)) return </span><span style="font-family: Menlo; color: rgb(139, 132, 207); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">0</span><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">;                                     \<br/>    QUEUE_REMOVE(&amp;handle-&gt;queue);                                             \<br/>    uv__handle_stop(handle);                                                  \<br/>    return </span><span style="font-family: Menlo; color: rgb(139, 132, 207); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">0</span><span style="font-family: Menlo; color: rgb(210, 143, 90); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;">;                                                                 \<br/>  }                                                                           \<br/>                                                                              \<br/>  void uv__run_##name(uv_loop_t* loop) {                                      \<br/>    uv_##name##_t* h;                                                         \<br/>    QUEUE queue;                                                              \<br/>    QUEUE* q;                                                                 \<br/>    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;queue);                                \<br/>    while (!QUEUE_EMPTY(&amp;queue)) {                                            \<br/>      q = QUEUE_HEAD(&amp;queue);                                                 \<br/>      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \<br/>      QUEUE_REMOVE(q);                                                        \<br/>      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \<br/>      h-&gt;name##_cb(h);                                                        \<br/>    }                                                                         \<br/>  }                                                                           \<br/>                                                                              \<br/>  void uv__##name##_close(uv_##name##_t* handle) {                            \<br/>    uv_##name##_stop(handle);                                                 \<br/>  }<br/>
</span><span style="font-family: Menlo; color: rgb(255, 255, 255); font-size: 18px; font-style: normal; font-variant-caps: normal; font-weight: normal; font-variant-ligatures: no-common-ligatures;"><br/></span><font style="color: rgb(210, 143, 90); font-family: Menlo;">UV_LOOP_WATCHER_DEFINE(prepare, PREPARE)</font></font></div><div><font style="color: rgb(210, 143, 90); font-family: Menlo;">UV_LOOP_WATCHER_DEFINE(check, CHECK)</font></div><div><font style="color: rgb(210, 143, 90); font-family: Menlo;">UV_LOOP_WATCHER_DEFINE(idle, IDLE)</font><font><br/></font></div><div><font style="color: rgb(210, 143, 90); font-family: Menlo;"><hr/><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">#define uv__handle_start(h)                                                   \<br/>  do {                                                                        \<br/>    assert(((h)-&gt;flags &amp; UV__HANDLE_CLOSING) == </span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #8b84cf">0</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">);                           \<br/>    if (((h)-&gt;flags &amp; UV__HANDLE_ACTIVE) != </span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #8b84cf">0</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">) break;                         \<br/>    (h)-&gt;flags |= UV__HANDLE_ACTIVE;                                          \</span></font></div><div><font style="color: rgb(210, 143, 90); font-family: Menlo;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    // 这个作用是什么？</span><br/>    if (((h)-&gt;flags &amp; UV__HANDLE_REF) != </span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #8b84cf">0</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">) uv__active_handle_add(h);         \<br/>  }                                                                           \<br/>  while (</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #8b84cf">0</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">)</span><br/></font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);" face="Monaco, Menlo, Consolas, Courier New, monospace"/></div></div><div><br/></div><div>总之，NeedImmediateCallbackSetter的作用就是，通过js层级的相关调用：</div><div>如果为active：则将相关check/idle的handle节点插入uv_loop的handles中，并将插入的节点标记为活动状态；</div><div>如果为unactive：则将相关check/idle的handle节点从uv_loop中的handles链表中移除节点，并将节点置为非活动状态。</div><div>形象点比喻，就是将节点放入/移除至循环链条中。</div><div><hr/>来看这两个callback回调：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 否则要继续开始，此处调试，先进入此分支</span><br/></font></div><div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv_check_start(immediate_check_handle, CheckImmediate);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Idle handle is needed only to stop the event loop from blocking in poll.</font></div></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv_idle_start(immediate_idle_handle, IdleImmediateDummy);</font></div></div></div><div><br/></div><div>我们将这两个CheckImmediate和IdleImmediateDummy分别打入断点，然后结束NeedImmediateCallbackSetter的调用，发现首先进入IdleImmediateDummy的回调，如下调用栈：</div><div><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setImmediate%20-%20from%20c_c++.resources/F18860B1-C4BA-4E23-A6E3-526C56CEE3DE.png" height="326" width="594"/><br/></div><div>仍旧是node的run_loop：</div><div><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setImmediate%20-%20from%20c_c++.resources/1C2E3791-8322-42F9-A5D6-B9A514EC120D.png" height="884" width="2546"/><br/></div><div>最终进入重要的 lib_uv 的核心逻辑，uv_run：</div><div><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setImmediate%20-%20from%20c_c++.resources/E96AF41A-BB0B-436F-8995-F079A68B2D13.png" height="896" width="2556"/><br/></div><div>可以看到，在uv__run_timers之后，则开始uv__run_idle(loop)，而究竟是怎么run起来的，则要继续看此节上文的宏定义：</div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">  void uv__run_##name(uv_loop_t* loop) {                                      \<br/>    uv_##name##_t* h;                                                         \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    // 开始申请新双向链表头</span><br/>    QUEUE queue;                                                              \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    // 节点</span><br/>    QUEUE* q;                                                                 \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    // 将&amp;loop-&gt;idle_handles双向链表“抽离出来”，让新的queue指向此链表</span></span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">    QUEUE_MOVE(&amp;loop-&gt;name##_handles, &amp;queue);                                \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    // 开始循环queue链表</span><br/>    while (!QUEUE_EMPTY(&amp;queue)) {                                            \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    <span>  // 取到表头元素</span></span><br/>      q = QUEUE_HEAD(&amp;queue);                                                 \<br/>      h = QUEUE_DATA(q, uv_##name##_t, queue);                                \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    <span>  // 将此节点从queue中移除</span></span><br/>      QUEUE_REMOVE(q);                                                        \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    <span>  // 将此节点重新插入至loop-&gt;idle_handles链表中去</span></span><br/>      QUEUE_INSERT_TAIL(&amp;loop-&gt;name##_handles, q);                            \</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><span>    <span>  // 🌟🌟🌟开始调用回调函数【在这里调入具体的回调函数中去】</span></span><br/>      h-&gt;name##_cb(h);                                                        \<br/>    }                                                                         \<br/>  }                                                                           \</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a"><br/></span></div><div><font face="Menlo" color="#d28f5a" size="4">注意此处的QUEUE_MOVE宏：</font></div><div><font face="Menlo" color="#d28f5a" size="4"><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">#define QUEUE_SPLIT(h, q, n)                                                  \<br/>  do {                                                                        \<br/>    QUEUE_PREV(n) = QUEUE_PREV(h);                                            \<br/>    QUEUE_PREV_NEXT(n) = (n);                                                 \<br/>    QUEUE_NEXT(n) = (q);                                                      \<br/>    QUEUE_PREV(h) = QUEUE_PREV(q);                                            \<br/>    QUEUE_PREV_NEXT(h) = (h);                                                 \<br/>    QUEUE_PREV(q) = (n);                                                      \<br/>  }                                                                           \<br/>  while (</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #8b84cf">0</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">)<br/>
</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #ffffff"><br/>
</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">#define QUEUE_MOVE(h, n)                                                      \<br/>  do {                                                                        \<br/>    if (QUEUE_EMPTY(h))                                                       \<br/>      QUEUE_INIT(n);                                                          \<br/>    else {                                                                    \<br/>      QUEUE* q = QUEUE_HEAD(h);                                               \<br/>      QUEUE_SPLIT(h, q, n);                                                   \<br/>    }                                                                         \<br/>  }                                                                           \<br/>  while (</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #8b84cf">0</span><span style="font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d28f5a">)</span><br/></font></div></div><div><br/></div><div>QUEUE_MOVE的详细操作见：</div><div><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setImmediate%20-%20from%20c_c++.resources/6821BDDC-A47C-48EF-90A1-636774D3F051.png" height="960" width="1280"/><br/></div><div>总结其功能，就是，让原始链表头（loop-&gt;idle_handles）指向自身（置空），然后给此链表设置新的表头，便于接下来处理。</div><div>此时调入了：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x000000010002e528 in node::IdleImmediateDummy(uv_idle_s*) at /Users/mrguan/work/build/node/node-6.6.0/src/node.cc:285</font></div><div>这个位置：</div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">static void IdleImmediateDummy(uv_idle_t* handle) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // idle的回调函数并没有做什么</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // Do nothing. Only for maintaining event loop.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // TODO(bnoordhuis) Maybe make libuv accept nullptr idle callbacks.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div></div><div><br/></div><div><hr/>再来看 uv_run 函数中的：uv__run_check(loop) 环节：</div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#2     0x0000000101017d68 in uv_run at /Users/mrguan/work/build/node/node-6.6.0/deps/uv/src/unix/core.c:355</font></div><div style="color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  while (r != 0 &amp;&amp; loop-&gt;stop_flag == 0) {</font></font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__update_time(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__run_timers(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ran_pending = uv__run_pending(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__run_idle(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__run_prepare(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    timeout = 0;</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      timeout = uv_backend_timeout(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__io_poll(loop, timeout);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 🌟🌟🌟看这里哦 line 355</span><br/></font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__run_check(loop);</font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    uv__run_closing_handles(loop);</font><font face="Monaco"><br/></font></div><div style="color: rgb(51, 51, 51); font-size: 12px;"><font face="Monaco">...</font></div></div><div><br/></div><div>同上面的分析，会走入 uv__run_check( loop ) 【宏定义重的逻辑】函数调用，以此调用 &amp;loop-&gt;check_handles 链表中的回调函数：</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x000000010002e47c in node::CheckImmediate(uv_check_s*) at /Users/mrguan/work/build/node/node-6.6.0/src/node.cc:275</font></div><div><font face="Monaco">// 终于调入了重中之重的函数</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">static void CheckImmediate(uv_check_t* handle) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  Environment* env = Environment::from_immediate_check_handle(handle);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  HandleScope scope(env-&gt;isolate());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  Context::Scope context_scope(env-&gt;context());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 最终走入这里</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>  // env-&gt;process_object() 即为 process 对象；</span><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>  // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">V(immediate_callback_string, "_immediateCallback") </font></span><br/></span></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 在js层面，process的<font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">_immediateCallback属性指向js层级的回调函数</font></span><br/></font></span></span></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><span>  // 此MakeCallback函数比较复杂，暂不深究</span><br/></font></span></font></span></span></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  MakeCallback(env, env-&gt;process_object(), env-&gt;immediate_callback_string());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div></div><div><br/></div><div>MakeCallback最终调用了js层级的：</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">if </span>(!<span style="color:#9876aa;">process</span>.<span style="color:#9876aa;">_needImmediateCallback</span>) {<br/>  <span style="color:#9876aa;">process</span>.<span style="color:#9876aa;">_needImmediateCallback </span>= <span style="color:#cc7832;font-weight:bold;">true</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">  </span><span style="color:#9876aa;">process</span>.<span style="color:#ffc66d;">_immediateCallback </span>= <span style="color:#ffc66d;">processImmediate</span><span style="color:#cc7832;">;<br/></span>}
</pre>process._immediateCallback 函数，此函数再进一步调用js层级的immediate双向链表中的回调函数，最终调用至用户回调。</div><div><br/></div><div><hr/>补充一下，在分析完整体逻辑以后，clear的逻辑就很简单了【一眼就明了了】：</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#9876aa;">exports</span>.<span style="background-color:#40332b;">clearImmediate</span> = <span style="color:#cc7832;font-weight:bold;">function</span>(immediate) {<br/>  <span style="color:#cc7832;font-weight:bold;">if </span>(!immediate) <span style="color:#cc7832;font-weight:bold;">return</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;">  </span>immediate.<span style="color:#9876aa;">_onImmediate </span>= undefined<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;">  </span>L.<span style="color:#ffc66d;">remove</span>(immediate)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;">  </span><span style="color:#cc7832;font-weight:bold;">if </span>(L.<span style="color:#ffc66d;">isEmpty</span>(immediateQueue)) {<br/>    <span style="color:#9876aa;">process</span>.<span style="color:#9876aa;">_needImmediateCallback </span>= <span style="color:#cc7832;font-weight:bold;">false</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">  </span>}<br/>}<span style="color:#cc7832;">;</span></pre></div><div><br/></div></body></html>