<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-11-09 14:38:34 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-24 06:48:08 +0000"/><title>JS 层面的 Native 模块加载和用户模块加载</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>JS 层面的 Native 模块加载和用户模块加载</h2>
<p class="title-p">版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p class="title-p">文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>废了九牛二虎之力，终于搭配好了一个好的调试debug环境：</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/81AF77A0-E5F6-4C45-A0CE-ABBB166E74F1.png" height="auto" width="100%"/><br/></div><div><br/></div><div>此节开始分析如题所说的内容，测试文件都已经在happy中配置好，直接进入正题：</div><div><br/></div><div>首先看经过node处理过的mod.js文件：</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/2879A9DC-2B8E-4A2E-880B-4A937C7BE713.png" height="auto" width="100%"/><br/></div><div><br/></div><div>头部已经被包装成了这个样子，在真正开始之前，我们先行了解一下在，bootstrap_node.js 中最后部分书写的关于：NativeModule 的概念：</div><div><br/></div><div>node源码中的lib文件夹里面的所有js模块，均为native模块，被抽象为NativeModule的概念，NativeModule拥有构造函数，静态属性，原型方法等。它主要负责，从c／c++中获取js源代码，包装好头和尾，并且通过runInThisContext方法执行其逻辑，返回module的工厂函数，并传入相关参数，这些参数作为用户在书写逻辑时直接可用的变量。NativeModule同时负责native模块的缓存工作。</div><div><br/></div><div>来看看关键源码：</div><div><br/></div><div/><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">NativeModule.wrapper = [</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 这里就是自动包装的头和尾，已经对应的变量</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  '(function (exports, require, module, __filename, __dirname) { ',</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  '\n});'</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">];</font></div><div><br/></div><div>// 每一个native module都会被new出来一个实例</div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">NativeModule.prototype.compile = function() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 从c/c++头中获取源码（ASCII编码）</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var source = NativeModule.getSource(this.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 如上包装</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  source = NativeModule.wrap(source);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  this.loading = true;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  try {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 获取工厂方法</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    var fn = runInThisContext(source, {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      filename: this.filename,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      lineOffset: 0,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      displayErrors: true</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    });</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 对应与wrapper里面的变量名称／可以发觉，其实真对nativemodule模块，少了__dirname变量</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    fn(this.exports, NativeModule.require, this, this.filename);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    this.loaded = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  } finally {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    this.loading = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div></div><div><br/></div><div>再来看测试文件，测试用的文件是用户的自定义文件，所以可能不会走上述的native module加载逻辑，来看看：</div><div><br/></div><div>测试逻辑的入口文件是一个main.js文件（第一个被包裹和加载运行的文件 ）：</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/E7D59449-418A-444F-8000-CF9CA7E08634.png" height="auto" width="100%"/><br/></div><div><br/></div><div><br/></div><div/><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// main.js 作为整体测试文件入口<br/></span><span style="color:#808080;"><br/></span><span style="color:#808080;">// 🌟测试native模块和自定义模块的require过程<br/></span>require( <span style="color:#6a8759;">'./module/mod' </span>)<span style="color:#cc7832;">;</span></pre>main.js</div></div><div><br/></div><div><br/></div><div/><div/><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">debugger</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#808080;">// test for require native<br/></span><span style="color:#cc7832;font-weight:bold;">var </span>path = require( <span style="color:#6a8759;">'path' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">var </span>fs   = require( <span style="color:#6a8759;">'fs' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#808080;">// test for require custom module<br/></span><span style="color:#cc7832;font-weight:bold;">var </span>a = require( <span style="color:#6a8759;">'./a' </span>)<span style="color:#cc7832;">;</span></pre>mod.js</div></div><div><br/></div><div>这里又个小细节需要注意，mod.js 中的require和NativeModule中的require逻辑是不一样的，看如何走入 require( ‘path’ )，此处（也就是大部分用户逻辑）的require在这里作为入口：</div><div><br/></div><div/><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">internal/module.js:</font><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">(function (exports, require, module, __filename, __dirname) { 'use strict';</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports = module.exports = {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  makeRequireFunction,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  stripBOM,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  addBuiltinLibsToObject</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">// 一个静态变量，用来存储被require的深度</div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports.requireDepth = 0;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Invoke with makeRequireFunction.call(module) where |module| is the</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Module object to use as the context for the require() function.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">function makeRequireFunction() {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  const Module = this.constructor;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  const self = this;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  function require(path) {</font></div><div><font><font face="Monaco" color="#333333"><span style="font-size: 12px;">    // path: ‘path'</span></font><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    try {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>  // exports 即为次internal/module模块的产出对象</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span> <span> // 深度+1</span></span></span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      exports.requireDepth += 1;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>  // self 为 Module 当前的实例，截图见下：</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>  // 最终掉入 Module 的 require</span></span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      return self.require(path);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    } finally {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>  // 注意这里的分支，最终其requireDepth会回复-1</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      exports.requireDepth -= 1;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"/></div></div><div><br/></div><div>self 截图：</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/1A4A49DA-81A5-4087-98E6-7DE20367CFEC.png" height="auto" width="100%"/><br/></div><div><br/></div><div>最终会进入 Module._load 函数：</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">此函数位置就在 lib/module.js</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// load规则见注释</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Check the cache for the requested file.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 1. If a module already exists in the cache: return its exports object.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 2. If the module is native: call `NativeModule.require()` with the</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//    filename and return the result.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 3. Otherwise, create a new module for the file and save it to the cache.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//    Then have it load  the file contents before returning its exports</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//    object.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._load = function(request, parent, isMain) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (parent) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    debug('Module._load REQUEST %s parent: %s', request, parent.id);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 下面的一大段分析了此函数的执行细节</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var filename = Module._resolveFilename(request, parent, isMain);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 检查缓存中是否存在</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var cachedModule = Module._cache[filename];</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (cachedModule) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return cachedModule.exports;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 检查是不是nativemodule，规则就是：其id存在于NativeModule._source中，并且不是在lib/internal中</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (NativeModule.nonInternalExists(filename)) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>   <span> // 此处引用path会进入此处分支</span></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    debug('load native module %s', request);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 进入NativeModule的require函数，见下</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return NativeModule.require(filename);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/B0F6C134-9E2B-49DF-93C0-91864889DBC7.png" height="auto" width="100%"/><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 开始构造一个新的module对象，细节见上</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var module = new Module(filename, parent);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (isMain) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    process.mainModule = module;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    module.id = '.';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 最终将其缓存入库【注意缓存的是module实例】</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  Module._cache[filename] = module;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/08C244F9-89E9-48D7-880E-5D873DF922AA.png" height="auto" width="100%"/><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 开始加载和执行module，入口函数见上</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>  // 上述的module.load函数见此节最后分析</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  tryModuleLoad(module, filename);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  return module.exports;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font face="Monaco">进入此函数的变量截图见：</font></div><div><font face="Monaco"><br/></font></div><div><font face="Monaco"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/5731DE85-DAC2-42AD-9E30-BFB11958939B.png" height="auto" width="100%"/><br/></font></div><div><font face="Monaco"><br/></font></div></div><div><br/></div><div>进入NativeModule函数的require：</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">NativeModule.require = function(id) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (id == 'native_module') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return NativeModule;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var cached = NativeModule.getCached(id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (cached &amp;&amp; (cached.loaded || cached.loading)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return cached.exports;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (!NativeModule.exists(id)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    throw new Error(`No such native module ${id}`);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  process.moduleLoadList.push(`NativeModule ${id}`);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var nativeModule = new NativeModule(id);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  nativeModule.cache();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  nativeModule.compile();</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  return nativeModule.exports;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>path模块的加载分析结束，其主要是以来NativeModule.require来加载的。fs类似，不再赘述。</div><div><br/></div><div><hr/><br/></div><div>进入require(‘.a’)的自定义模块加载：<br/></div><div><br/></div><div>同样是先由：<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true-evernote-highlight:true">internal/module.js </span>中的require进入逻辑 -&gt;</div><div><br/></div><div>Module( lib/module.js )实例自己的require方法 -&gt;</div><div><br/></div><div>Module._load 方法 -&gt;</div><div><br/></div><div>🌟_load 中的一个重要函数调用：Module._resolveFilename</div><div><br/></div><div>🌟继续进入： Module._resolveLookupPaths函数 -&gt; （从名字来看应该是属于路径查找）先来看其调用切面：</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 'index.' character codes</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var indexChars = [ 105, 110, 100, 101, 120, 46 ]; // i, n, d, e, x, .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var indexLen = indexChars.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._resolveLookupPaths = function(request, parent) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (NativeModule.nonInternalExists(request)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return [request, []];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><span>  <img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/47F675ED-9217-4BF6-AD82-4A4073D6003A.png" height="auto" width="100%"/><br/></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var reqLen = request.length; // 3</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // Check for relative path 先检查相对路径，这里就是相对路径</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 并没有走入此分支</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (reqLen &lt; 2 ||</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      request.charCodeAt(0) !== 46/*.*/ ||</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      (request.charCodeAt(1) !== 46/*.*/ &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">       request.charCodeAt(1) !== 47/*/*/)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  <img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/AD38DB4C-A674-4B66-8AA9-3DC7CB2AA2CB.png" height="auto" width="100%"/><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    var paths = modulePaths;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (parent) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (!parent.paths)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        paths = parent.paths = [];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      else</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        paths = parent.paths.concat(paths);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Maintain backwards compat with certain broken uses of require('.')</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // by putting the module's directory in front of the lookup paths.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (request === '.') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (parent &amp;&amp; parent.filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        paths.unshift(path.dirname(parent.filename));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        paths.unshift(path.resolve(request));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return [request, paths];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // with --eval, parent.id is not set and parent.filename is null</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (!parent || !parent.id || !parent.filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // make require('./path/to/foo') work - normally the path is taken</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // from realpath(__filename) but with eval there is no filename</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    var mainPaths = ['.'].concat(Module._nodeModulePaths('.'), modulePaths);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return [request, mainPaths];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // Is the parent an index module?</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // We can assume the parent has a valid extension,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // as it already has been accepted as a module.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // base: “mod.js"</font><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  const base = path.basename(parent.filename);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var parentIdPath;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // indexLen == 6</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (base.length &gt; indexLen) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    var i = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    for (; i &lt; indexLen; ++i) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (indexChars[i] !== base.charCodeAt(i))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        break;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (i === indexLen) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      // We matched 'index.', let's validate the rest</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      for (; i &lt; base.length; ++i) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        const code = base.charCodeAt(i);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (code !== 95/*_*/ &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            (code &lt; 48/*0*/ || code &gt; 57/*9*/) &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            (code &lt; 65/*A*/ || code &gt; 90/*Z*/) &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            (code &lt; 97/*a*/ || code &gt; 122/*z*/))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          break;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (i === base.length) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // Is an index module</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        parentIdPath = parent.id;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // Not an index module</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        parentIdPath = path.dirname(parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      // Not an index module</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      parentIdPath = path.dirname(parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>   <span> // 走入这里</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Not an index module</font><span style="font-family: Monaco;"> </span></div><div><span style="font-family: Monaco;"><br/></span></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/683E402D-8B63-408E-B677-800275295C27.png" height="auto" width="100%"/><br/></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    parentIdPath = path.dirname(parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/1B77B1DC-EBAB-4C47-B3E2-B3D6AF434C94.png" height="auto" width="100%"/><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 拿到最终id</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var id = path.resolve(parentIdPath, request);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // make sure require('./path') and require('path') get distinct ids, even</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // when called from the toplevel js file</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (parentIdPath === '.' &amp;&amp; id.indexOf('/') === -1) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    id = './' + id;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  debug('RELATIVE: requested: %s set ID to: %s from %s', request, id,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><span>  <img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/FA1763AD-725B-486A-9B6B-8037C3EF5983.png" height="auto" width="100%"/><br/></span></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  return [id, [path.dirname(parent.filename)]];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>🌟lookUp函数执行完毕，获取到了真正的module路径</div><div><br/></div><div>✨进入Module._findPath函数：</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var warned = false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._findPath = function(request, paths, isMain) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/5607DD44-866D-4E12-815B-9C5A03959919.png" height="auto" width="100%"/><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (path.isAbsolute(request)) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    paths = [''];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  } else if (!paths || paths.length === 0) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="orphans: 2; widows: 2;"><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span style="font-size: 12px;">  // </span></font><span style="font-variant-ligatures: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; float: none;"><font face="Menlo, monospace" color="#303942"><span style="font-size: 12px; white-space: pre-wrap;">cacheKey: "{"request":"./a","paths":["/Users/mrguan/work/git/happy/test-nodejs/module”]}"</span></font></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  const cacheKey = JSON.stringify({request: request, paths: paths});</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 检查缓存中是否存在</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (Module._pathCache[cacheKey]) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return Module._pathCache[cacheKey];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var exts;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  const trailingSlash = request.length &gt; 0 &amp;&amp;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">                        request.charCodeAt(request.length - 1) === 47/*/*/;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // For each path</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  for (var i = 0; i &lt; paths.length; i++) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Don't search further if path doesn't exist</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    const curPath = paths[i];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (curPath &amp;&amp; stat(curPath) &lt; 1) continue;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    var basePath = path.resolve(curPath, request);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    var filename;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!trailingSlash) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>  // 调试过程这里为-2【应该为不存在，因为a本来就不存在；存在的是a.js】</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      const rc = stat(basePath);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (rc === 0) {  // File.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (preserveSymlinks &amp;&amp; !isMain) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          filename = path.resolve(basePath);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        } else {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          filename = fs.realpathSync(basePath);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      } else if (rc === 1) {  // Directory.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          exts = Object.keys(Module._extensions);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        filename = tryPackage(basePath, exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>    <span>  // 走入此分支</span></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (!filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // try it with each of the extensions</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/6E473A63-76F1-4454-AC47-3A7D68AE929E.png" height="auto" width="100%"/><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <span>  // 按照.js／.json／.node的加载顺序逐一猜测</span></span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          exts = Object.keys(Module._extensions);
</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 这里开始逐一测试后缀名称</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/D7EB1FDF-37F6-470A-BB69-0A2E7EB7D886.png" height="auto" width="100%"/><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    // 得到了filename</span></span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>    <span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">filename: "/Users/mrguan/work/git/happy/test-nodejs/module/a.js"</font></span></span><br/></span></span></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        filename = tryExtensions(basePath, exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>    // 因此下方的逻辑不再走</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        exts = Object.keys(Module._extensions);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      filename = tryPackage(basePath, exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      // try it with each of the extensions at "index"</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        exts = Object.keys(Module._extensions);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      filename = tryExtensions(path.resolve(basePath, 'index'), exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>    // 走入这里</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      // Warn once if '.' resolved outside the module dir</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (request === '.' &amp;&amp; i &gt; 0) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        warned = internalUtil.printDeprecationMessage(</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          'warning: require(\'.\') resolved outside the package ' +</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          'directory. This functionality is deprecated and will be removed ' +</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          'soon.', warned);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>    <span>  // 写入路径缓存</span></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      Module._pathCache[cacheKey] = filename;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      return filename;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  return false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>🌟最终Module._resolveFilename函数执行完毕，找到了要require的实际文件名称和路径，并且将实际路径也缓存了起来，且最终返回文件的真实路径。【注意这里的真对文件名后缀的尝试加载工作：.js &gt; .json &gt; .node】</div><div><br/></div><div>Module._pathCache 中缓存了对引用模块到真实路径的缓存映射；Module._cache 则缓存了对引用模块的对象映射；</div><div><br/></div><div><hr/><br/></div><div>来分析 Module.prototype.load 函数：</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Given a file name, pass it to the proper extension handler.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module.prototype.load = function(filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  debug('load %j for module %j', filename, this.id);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  assert(!this.loaded);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  this.filename = filename;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // Module._nodeModulePaths的主要作用就是根据当前文件的具体filename，生成与之对应的node_modules引用目录金字塔结构：</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/76E7BDFF-692A-4FC9-8812-D287A2BFBB85.png" height="auto" width="100%"/><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  this.paths = Module._nodeModulePaths(path.dirname(filename));</font></div><div><span>  // .js</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var extension = path.extname(filename) || '.js’;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 来看下，每种文件其实对应着不同的打开方式：</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/9790CAFB-2AA8-434B-BD56-9F1D50F09CA2.png" height="auto" width="100%"/><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (!Module._extensions[extension]) extension = '.js';</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  Module._extensions[extension](this, filename);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  this.loaded = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>.js module文件的加载：</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Native extension for .js</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._extensions['.js'] = function(module, filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 同步读入内容</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var content = fs.readFileSync(filename, 'utf8’);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/D1A4F886-65E2-421F-9219-2C89C042CC61.png" height="auto" width="100%"/><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 最终进入module._compile函数</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  module._compile(internalModule.stripBOM(content), filename);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>module._compile 函数细节：</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Run the file contents in the correct scope or sandbox. Expose</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// the correct helper variables (require, module, exports) to</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// the file.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Returns exception, if any.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module.prototype._compile = function(content, filename) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // Remove shebang</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 去掉文件上面的 #!/xxxxx</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var contLen = content.length;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (contLen &gt;= 2) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (content.charCodeAt(0) === 35/*#*/ &amp;&amp;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        content.charCodeAt(1) === 33/*!*/) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (contLen === 2) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // Exact match</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        content = '';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      } else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        // Find end of shebang line and slice it off</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        var i = 2;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        for (; i &lt; contLen; ++i) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          var code = content.charCodeAt(i);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          if (code === 10/*\n*/ || code === 13/*\r*/)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            break;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (i === contLen)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          content = '';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          // Note that this actually includes the newline character(s) in the</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          // new output. This duplicates the behavior of the regular expression</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          // that was previously used to replace the shebang line</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">          content = content.slice(i);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  // create wrapper function</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>  // 这里的Module.wrap函数直接引用NativeWrapper.wrap</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/089C743D-0414-445B-9179-8468F59CE637.png" height="auto" width="100%"/><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var wrapper = Module.wrap(content);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var compiledWrapper = vm.runInThisContext(wrapper, {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    filename: filename,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    lineOffset: 0,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    displayErrors: true</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  });</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (process._debugWaitConnect) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!resolvedArgv) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      // we enter the repl if we're not given a filename argument.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      if (process.argv[1]) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        resolvedArgv = Module._resolveFilename(process.argv[1], null);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      } else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        resolvedArgv = 'repl';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Set breakpoint on module start</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (filename === resolvedArgv) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      delete process._debugWaitConnect;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      const Debug = vm.runInDebugContext('Debug');</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">      Debug.setBreakPoint(compiledWrapper, 0, 0);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var dirname = path.dirname(filename);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/4380E6C1-6551-4BF9-B950-F2391276A0F7.png" height="auto" width="100%"/><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font face="Monaco">  // 这里比较复杂！给require附加了很多方法和属性／用户自定义逻辑中的require都是这个函数入口</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var require = internalModule.makeRequireFunction.call(this);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var args = [this.exports, require, this, filename, dirname];</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var depth = internalModule.requireDepth;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (depth === 0) stat.cache = new Map();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  var result = compiledWrapper.apply(this.exports, args);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  if (depth === 0) stat.cache = null;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">  return result;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>下面给出main.js执行到此的截图和mod.js执行到此的截图：</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/06498EC3-4561-4C4A-9AE9-822B85825E0D.png" height="auto" width="100%"/><br/></div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/F015C721-D23C-4D41-A729-35A15324552B.png" height="auto" width="100%"/><br/></div><div><br/></div><div>最终，用户自定义模块引入完毕！</div><div><br/></div><div>TODO：关于depth的理解欠缺</div><div/><div/><div/><div/><div/><div/><div/>

<hr class="tail-hr">
<div class="tail-licenses">
<p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>更新日期：Sat Dec 24 2016 16:09:09 GMT+0800 (CST)</p>
</div></body></html>