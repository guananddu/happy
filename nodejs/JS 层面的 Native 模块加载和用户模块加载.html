<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2016-11-09 14:38:34 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-24 06:48:08 +0000"/><title>JS å±‚é¢çš„ Native æ¨¡å—åŠ è½½å’Œç”¨æˆ·æ¨¡å—åŠ è½½</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>JS å±‚é¢çš„ Native æ¨¡å—åŠ è½½å’Œç”¨æˆ·æ¨¡å—åŠ è½½</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>åºŸäº†ä¹ç‰›äºŒè™ä¹‹åŠ›ï¼Œç»ˆäºæ­é…å¥½äº†ä¸€ä¸ªå¥½çš„è°ƒè¯•debugç¯å¢ƒï¼š</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/81AF77A0-E5F6-4C45-A0CE-ABBB166E74F1.png" height="auto" width="100%"/><br/></div><div><br/></div><div>æ­¤èŠ‚å¼€å§‹åˆ†æå¦‚é¢˜æ‰€è¯´çš„å†…å®¹ï¼Œæµ‹è¯•æ–‡ä»¶éƒ½å·²ç»åœ¨happyä¸­é…ç½®å¥½ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜ï¼š</div><div><br/></div><div>é¦–å…ˆçœ‹ç»è¿‡nodeå¤„ç†è¿‡çš„mod.jsæ–‡ä»¶ï¼š</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/2879A9DC-2B8E-4A2E-880B-4A937C7BE713.png" height="auto" width="100%"/><br/></div><div><br/></div><div>å¤´éƒ¨å·²ç»è¢«åŒ…è£…æˆäº†è¿™ä¸ªæ ·å­ï¼Œåœ¨çœŸæ­£å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¡Œäº†è§£ä¸€ä¸‹åœ¨ï¼Œbootstrap_node.js ä¸­æœ€åéƒ¨åˆ†ä¹¦å†™çš„å…³äºï¼šNativeModule çš„æ¦‚å¿µï¼š</div><div><br/></div><div>nodeæºç ä¸­çš„libæ–‡ä»¶å¤¹é‡Œé¢çš„æ‰€æœ‰jsæ¨¡å—ï¼Œå‡ä¸ºnativeæ¨¡å—ï¼Œè¢«æŠ½è±¡ä¸ºNativeModuleçš„æ¦‚å¿µï¼ŒNativeModuleæ‹¥æœ‰æ„é€ å‡½æ•°ï¼Œé™æ€å±æ€§ï¼ŒåŸå‹æ–¹æ³•ç­‰ã€‚å®ƒä¸»è¦è´Ÿè´£ï¼Œä»cï¼c++ä¸­è·å–jsæºä»£ç ï¼ŒåŒ…è£…å¥½å¤´å’Œå°¾ï¼Œå¹¶ä¸”é€šè¿‡runInThisContextæ–¹æ³•æ‰§è¡Œå…¶é€»è¾‘ï¼Œè¿”å›moduleçš„å·¥å‚å‡½æ•°ï¼Œå¹¶ä¼ å…¥ç›¸å…³å‚æ•°ï¼Œè¿™äº›å‚æ•°ä½œä¸ºç”¨æˆ·åœ¨ä¹¦å†™é€»è¾‘æ—¶ç›´æ¥å¯ç”¨çš„å˜é‡ã€‚NativeModuleåŒæ—¶è´Ÿè´£nativeæ¨¡å—çš„ç¼“å­˜å·¥ä½œã€‚</div><div><br/></div><div>æ¥çœ‹çœ‹å…³é”®æºç ï¼š</div><div><br/></div><div/><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">NativeModule.wrapper = [</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // è¿™é‡Œå°±æ˜¯è‡ªåŠ¨åŒ…è£…çš„å¤´å’Œå°¾ï¼Œå·²ç»å¯¹åº”çš„å˜é‡</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â '(function (exports, require, module, __filename, __dirname) { ',</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â '\n});'</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">];</font></div><div><br/></div><div>// æ¯ä¸€ä¸ªnativeÂ moduleéƒ½ä¼šè¢«newå‡ºæ¥ä¸€ä¸ªå®ä¾‹</div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">NativeModule.prototype.compile = function() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // ä»c/c++å¤´ä¸­è·å–æºç ï¼ˆASCIIç¼–ç ï¼‰</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var source = NativeModule.getSource(this.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // å¦‚ä¸ŠåŒ…è£…</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â source = NativeModule.wrap(source);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â this.loading = true;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â try {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // è·å–å·¥å‚æ–¹æ³•</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â var fn = runInThisContext(source, {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â filename: this.filename,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â lineOffset: 0,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â displayErrors: true</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â });</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // å¯¹åº”ä¸wrapperé‡Œé¢çš„å˜é‡åç§°ï¼å¯ä»¥å‘è§‰ï¼Œå…¶å®çœŸå¯¹nativemoduleæ¨¡å—ï¼Œå°‘äº†__dirnameå˜é‡</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â fn(this.exports, NativeModule.require, this, this.filename);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â this.loaded = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â } finally {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â this.loading = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div></div><div><br/></div><div>å†æ¥çœ‹æµ‹è¯•æ–‡ä»¶ï¼Œæµ‹è¯•ç”¨çš„æ–‡ä»¶æ˜¯ç”¨æˆ·çš„è‡ªå®šä¹‰æ–‡ä»¶ï¼Œæ‰€ä»¥å¯èƒ½ä¸ä¼šèµ°ä¸Šè¿°çš„native moduleåŠ è½½é€»è¾‘ï¼Œæ¥çœ‹çœ‹ï¼š</div><div><br/></div><div>æµ‹è¯•é€»è¾‘çš„å…¥å£æ–‡ä»¶æ˜¯ä¸€ä¸ªmain.jsæ–‡ä»¶ï¼ˆç¬¬ä¸€ä¸ªè¢«åŒ…è£¹å’ŒåŠ è½½è¿è¡Œçš„æ–‡ä»¶ ï¼‰ï¼š</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/E7D59449-418A-444F-8000-CF9CA7E08634.png" height="auto" width="100%"/><br/></div><div><br/></div><div><br/></div><div/><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// main.js ä½œä¸ºæ•´ä½“æµ‹è¯•æ–‡ä»¶å…¥å£<br/></span><span style="color:#808080;"><br/></span><span style="color:#808080;">// ğŸŒŸæµ‹è¯•nativeæ¨¡å—å’Œè‡ªå®šä¹‰æ¨¡å—çš„requireè¿‡ç¨‹<br/></span>require( <span style="color:#6a8759;">'./module/mod' </span>)<span style="color:#cc7832;">;</span></pre>main.js</div></div><div><br/></div><div><br/></div><div/><div/><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">debugger</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#808080;">// test for require native<br/></span><span style="color:#cc7832;font-weight:bold;">var </span>path = require( <span style="color:#6a8759;">'path' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">var </span>fsÂ Â  = require( <span style="color:#6a8759;">'fs' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#808080;">// test for require custom module<br/></span><span style="color:#cc7832;font-weight:bold;">var </span>a = require( <span style="color:#6a8759;">'./a' </span>)<span style="color:#cc7832;">;</span></pre>mod.js</div></div><div><br/></div><div>è¿™é‡Œåˆä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œmod.js ä¸­çš„requireå’ŒNativeModuleä¸­çš„requireé€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ï¼Œçœ‹å¦‚ä½•èµ°å…¥ require( â€˜pathâ€™ )ï¼Œæ­¤å¤„ï¼ˆä¹Ÿå°±æ˜¯å¤§éƒ¨åˆ†ç”¨æˆ·é€»è¾‘ï¼‰çš„requireåœ¨è¿™é‡Œä½œä¸ºå…¥å£ï¼š</div><div><br/></div><div/><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">internal/module.js:</font><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">(function (exports, require, module, __filename, __dirname) { 'use strict';</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports = module.exports = {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â makeRequireFunction,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â stripBOM,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â addBuiltinLibsToObject</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">// ä¸€ä¸ªé™æ€å˜é‡ï¼Œç”¨æ¥å­˜å‚¨è¢«requireçš„æ·±åº¦</div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports.requireDepth = 0;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Invoke with makeRequireFunction.call(module) where |module| is the</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Module object to use as the context for the require() function.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">function makeRequireFunction() {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â const Module = this.constructor;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â const self = this;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â function require(path) {</font></div><div><font><font face="Monaco" color="#333333"><span style="font-size: 12px;">Â  Â  // path:Â â€˜path'</span></font><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â try {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // exports å³ä¸ºæ¬¡internal/moduleæ¨¡å—çš„äº§å‡ºå¯¹è±¡</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>Â Â  Â <span>Â <span>Â // æ·±åº¦+1</span></span></span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â exports.requireDepth += 1;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // self ä¸º Module å½“å‰çš„å®ä¾‹ï¼Œæˆªå›¾è§ä¸‹ï¼š</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>Â Â  Â <span>Â  // æœ€ç»ˆæ‰å…¥ Module çš„ require</span></span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â return self.require(path);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â } finally {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // æ³¨æ„è¿™é‡Œçš„åˆ†æ”¯ï¼Œæœ€ç»ˆå…¶requireDepthä¼šå›å¤-1</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â exports.requireDepth -= 1;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">...</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"/></div></div><div><br/></div><div>self æˆªå›¾ï¼š</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/1A4A49DA-81A5-4087-98E6-7DE20367CFEC.png" height="auto" width="100%"/><br/></div><div><br/></div><div>æœ€ç»ˆä¼šè¿›å…¥ Module._load å‡½æ•°ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">æ­¤å‡½æ•°ä½ç½®å°±åœ¨ lib/module.js</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// loadè§„åˆ™è§æ³¨é‡Š</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Check the cache for the requested file.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 1. If a module already exists in the cache: return its exports object.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 2. If the module is native: call `NativeModule.require()` with the</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//Â Â Â Â filename and return the result.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 3. Otherwise, create a new module for the file and save it to the cache.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//Â Â Â Â Then have it loadÂ Â the file contents before returning its exports</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//Â Â Â Â object.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._load = function(request, parent, isMain) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (parent) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â debug('Module._load REQUEST %s parent: %s', request, parent.id);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // ä¸‹é¢çš„ä¸€å¤§æ®µåˆ†æäº†æ­¤å‡½æ•°çš„æ‰§è¡Œç»†èŠ‚</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var filename = Module._resolveFilename(request, parent, isMain);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var cachedModule = Module._cache[filename];</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (cachedModule) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return cachedModule.exports;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // æ£€æŸ¥æ˜¯ä¸æ˜¯nativemoduleï¼Œè§„åˆ™å°±æ˜¯ï¼šå…¶idå­˜åœ¨äºNativeModule._sourceä¸­ï¼Œå¹¶ä¸”ä¸æ˜¯åœ¨lib/internalä¸­</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (NativeModule.nonInternalExists(filename)) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â <span>Â // æ­¤å¤„å¼•ç”¨pathä¼šè¿›å…¥æ­¤å¤„åˆ†æ”¯</span></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â debug('load native module %s', request);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // è¿›å…¥NativeModuleçš„requireå‡½æ•°ï¼Œè§ä¸‹</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return NativeModule.require(filename);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/B0F6C134-9E2B-49DF-93C0-91864889DBC7.png" height="auto" width="100%"/><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // å¼€å§‹æ„é€ ä¸€ä¸ªæ–°çš„moduleå¯¹è±¡ï¼Œç»†èŠ‚è§ä¸Š</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var module = new Module(filename, parent);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (isMain) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â process.mainModule = module;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â module.id = '.';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // æœ€ç»ˆå°†å…¶ç¼“å­˜å…¥åº“ã€æ³¨æ„ç¼“å­˜çš„æ˜¯moduleå®ä¾‹ã€‘</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Module._cache[filename] = module;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/08C244F9-89E9-48D7-880E-5D873DF922AA.png" height="auto" width="100%"/><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // å¼€å§‹åŠ è½½å’Œæ‰§è¡Œmoduleï¼Œå…¥å£å‡½æ•°è§ä¸Š</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // ä¸Šè¿°çš„module.loadå‡½æ•°è§æ­¤èŠ‚æœ€ååˆ†æ</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â tryModuleLoad(module, filename);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â return module.exports;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font face="Monaco">è¿›å…¥æ­¤å‡½æ•°çš„å˜é‡æˆªå›¾è§ï¼š</font></div><div><font face="Monaco"><br/></font></div><div><font face="Monaco"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/5731DE85-DAC2-42AD-9E30-BFB11958939B.png" height="auto" width="100%"/><br/></font></div><div><font face="Monaco"><br/></font></div></div><div><br/></div><div>è¿›å…¥NativeModuleå‡½æ•°çš„requireï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">NativeModule.require = function(id) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (id == 'native_module') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return NativeModule;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var cached = NativeModule.getCached(id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (cached &amp;&amp; (cached.loaded || cached.loading)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return cached.exports;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (!NativeModule.exists(id)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â throw new Error(`No such native module ${id}`);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â process.moduleLoadList.push(`NativeModule ${id}`);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var nativeModule = new NativeModule(id);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â nativeModule.cache();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â nativeModule.compile();</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â return nativeModule.exports;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>pathæ¨¡å—çš„åŠ è½½åˆ†æç»“æŸï¼Œå…¶ä¸»è¦æ˜¯ä»¥æ¥NativeModule.requireæ¥åŠ è½½çš„ã€‚fsç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚</div><div><br/></div><div><hr/><br/></div><div>è¿›å…¥require(â€˜.aâ€™)çš„è‡ªå®šä¹‰æ¨¡å—åŠ è½½ï¼š<br/></div><div><br/></div><div>åŒæ ·æ˜¯å…ˆç”±ï¼š<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true-evernote-highlight:true">internal/module.js </span>ä¸­çš„requireè¿›å…¥é€»è¾‘ -&gt;</div><div><br/></div><div>Module( lib/module.jsÂ )å®ä¾‹è‡ªå·±çš„requireæ–¹æ³• -&gt;</div><div><br/></div><div>Module._load æ–¹æ³• -&gt;</div><div><br/></div><div>ğŸŒŸ_load ä¸­çš„ä¸€ä¸ªé‡è¦å‡½æ•°è°ƒç”¨ï¼šModule._resolveFilename</div><div><br/></div><div>ğŸŒŸç»§ç»­è¿›å…¥ï¼š Module._resolveLookupPathså‡½æ•° -&gt; ï¼ˆä»åå­—æ¥çœ‹åº”è¯¥æ˜¯å±äºè·¯å¾„æŸ¥æ‰¾ï¼‰å…ˆæ¥çœ‹å…¶è°ƒç”¨åˆ‡é¢ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// 'index.' character codes</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var indexChars = [ 105, 110, 100, 101, 120, 46 ]; // i, n, d, e, x, .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var indexLen = indexChars.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._resolveLookupPaths = function(request, parent) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (NativeModule.nonInternalExists(request)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return [request, []];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><span>Â Â <img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/47F675ED-9217-4BF6-AD82-4A4073D6003A.png" height="auto" width="100%"/><br/></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var reqLen = request.length; // 3</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // Check for relative path å…ˆæ£€æŸ¥ç›¸å¯¹è·¯å¾„ï¼Œè¿™é‡Œå°±æ˜¯ç›¸å¯¹è·¯å¾„</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // å¹¶æ²¡æœ‰èµ°å…¥æ­¤åˆ†æ”¯</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (reqLen &lt; 2 ||</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â request.charCodeAt(0) !== 46/*.*/ ||</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â (request.charCodeAt(1) !== 46/*.*/ &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â request.charCodeAt(1) !== 47/*/*/)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  <img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/AD38DB4C-A674-4B66-8AA9-3DC7CB2AA2CB.png" height="auto" width="100%"/><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â var paths = modulePaths;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (parent) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (!parent.paths)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â paths = parent.paths = [];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â else</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â paths = parent.paths.concat(paths);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // Maintain backwards compat with certain broken uses of require('.')</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // by putting the module's directory in front of the lookup paths.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (request === '.') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (parent &amp;&amp; parent.filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â paths.unshift(path.dirname(parent.filename));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â paths.unshift(path.resolve(request));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return [request, paths];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // with --eval, parent.id is not set and parent.filename is null</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (!parent || !parent.id || !parent.filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // make require('./path/to/foo') work - normally the path is taken</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // from realpath(__filename) but with eval there is no filename</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â var mainPaths = ['.'].concat(Module._nodeModulePaths('.'), modulePaths);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return [request, mainPaths];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // Is the parent an index module?</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // We can assume the parent has a valid extension,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // as it already has been accepted as a module.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  // base: â€œmod.js"</font><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â const base = path.basename(parent.filename);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var parentIdPath;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // indexLen == 6</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (base.length &gt; indexLen) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â var i = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â for (; i &lt; indexLen; ++i) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (indexChars[i] !== base.charCodeAt(i))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â break;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (i === indexLen) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â // We matched 'index.', let's validate the rest</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â for (; i &lt; base.length; ++i) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â const code = base.charCodeAt(i);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â if (code !== 95/*_*/ &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â Â Â (code &lt; 48/*0*/ || code &gt; 57/*9*/) &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â Â Â (code &lt; 65/*A*/ || code &gt; 90/*Z*/) &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â Â Â (code &lt; 97/*a*/ || code &gt; 122/*z*/))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â break;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (i === base.length) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â // Is an index module</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â parentIdPath = parent.id;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â // Not an index module</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â parentIdPath = path.dirname(parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â // Not an index module</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â parentIdPath = path.dirname(parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â <span>Â // èµ°å…¥è¿™é‡Œ</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // Not an index module</font><span style="font-family: Monaco;">Â </span></div><div><span style="font-family: Monaco;"><br/></span></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/683E402D-8B63-408E-B677-800275295C27.png" height="auto" width="100%"/><br/></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â parentIdPath = path.dirname(parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/1B77B1DC-EBAB-4C47-B3E2-B3D6AF434C94.png" height="auto" width="100%"/><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // æ‹¿åˆ°æœ€ç»ˆid</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var id = path.resolve(parentIdPath, request);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // make sure require('./path') and require('path') get distinct ids, even</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // when called from the toplevel js file</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (parentIdPath === '.' &amp;&amp; id.indexOf('/') === -1) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â id = './' + id;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â debug('RELATIVE: requested: %s set ID to: %s from %s', request, id,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â parent.id);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><span>Â Â <img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/FA1763AD-725B-486A-9B6B-8037C3EF5983.png" height="auto" width="100%"/><br/></span></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â return [id, [path.dirname(parent.filename)]];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>ğŸŒŸlookUpå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œè·å–åˆ°äº†çœŸæ­£çš„moduleè·¯å¾„</div><div><br/></div><div>âœ¨è¿›å…¥Module._findPathå‡½æ•°ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var warned = false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._findPath = function(request, paths, isMain) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/5607DD44-866D-4E12-815B-9C5A03959919.png" height="auto" width="100%"/><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (path.isAbsolute(request)) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â paths = [''];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â } else if (!paths || paths.length === 0) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="orphans: 2; widows: 2;"><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span style="font-size: 12px;">Â  //Â </span></font><span style="font-variant-ligatures: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; float: none;"><font face="Menlo, monospace" color="#303942"><span style="font-size: 12px; white-space: pre-wrap;">cacheKey: "{"request":"./a","paths":["/Users/mrguan/work/git/happy/test-nodejs/moduleâ€]}"</span></font></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â const cacheKey = JSON.stringify({request: request, paths: paths});</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (Module._pathCache[cacheKey]) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â return Module._pathCache[cacheKey];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var exts;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â const trailingSlash = request.length &gt; 0 &amp;&amp;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â request.charCodeAt(request.length - 1) === 47/*/*/;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // For each path</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â for (var i = 0; i &lt; paths.length; i++) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // Don't search further if path doesn't exist</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â const curPath = paths[i];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (curPath &amp;&amp; stat(curPath) &lt; 1) continue;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â var basePath = path.resolve(curPath, request);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â var filename;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (!trailingSlash) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // è°ƒè¯•è¿‡ç¨‹è¿™é‡Œä¸º-2ã€åº”è¯¥ä¸ºä¸å­˜åœ¨ï¼Œå› ä¸ºaæœ¬æ¥å°±ä¸å­˜åœ¨ï¼›å­˜åœ¨çš„æ˜¯a.jsã€‘</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â const rc = stat(basePath);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (rc === 0) {Â Â // File.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â if (preserveSymlinks &amp;&amp; !isMain) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â filename = path.resolve(basePath);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â } else {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â filename = fs.realpathSync(basePath);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â } else if (rc === 1) {Â Â // Directory.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â exts = Object.keys(Module._extensions);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â filename = tryPackage(basePath, exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â Â  Â <span>Â  // èµ°å…¥æ­¤åˆ†æ”¯</span></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (!filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â // try it with each of the extensions</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/6E473A63-76F1-4454-AC47-3A7D68AE929E.png" height="auto" width="100%"/><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â Â  Â <span>Â  // æŒ‰ç…§.jsï¼.jsonï¼.nodeçš„åŠ è½½é¡ºåºé€ä¸€çŒœæµ‹</span></span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â exts = Object.keys(Module._extensions);
</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  Â  // è¿™é‡Œå¼€å§‹é€ä¸€æµ‹è¯•åç¼€åç§°</span></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/D7EB1FDF-37F6-470A-BB69-0A2E7EB7D886.png" height="auto" width="100%"/><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>Â Â  Â <span>Â  Â  // å¾—åˆ°äº†filename</span></span><br/></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>Â Â  Â <span>Â  Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">filename: "/Users/mrguan/work/git/happy/test-nodejs/module/a.js"</font></span></span><br/></span></span></span></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â filename = tryExtensions(basePath, exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  Â  // å› æ­¤ä¸‹æ–¹çš„é€»è¾‘ä¸å†èµ°</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (!filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â exts = Object.keys(Module._extensions);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â filename = tryPackage(basePath, exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (!filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â // try it with each of the extensions at "index"</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (exts === undefined)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â exts = Object.keys(Module._extensions);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â filename = tryExtensions(path.resolve(basePath, 'index'), exts, isMain);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  Â  // èµ°å…¥è¿™é‡Œ</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (filename) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â // Warn once if '.' resolved outside the module dir</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (request === '.' &amp;&amp; i &gt; 0) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â warned = internalUtil.printDeprecationMessage(</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â 'warning: require(\'.\') resolved outside the package ' +</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â 'directory. This functionality is deprecated and will be removed ' +</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â 'soon.', warned);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â Â  Â <span>Â  // å†™å…¥è·¯å¾„ç¼“å­˜</span></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Module._pathCache[cacheKey] = filename;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â return filename;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â return false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>ğŸŒŸæœ€ç»ˆModule._resolveFilenameå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œæ‰¾åˆ°äº†è¦requireçš„å®é™…æ–‡ä»¶åç§°å’Œè·¯å¾„ï¼Œå¹¶ä¸”å°†å®é™…è·¯å¾„ä¹Ÿç¼“å­˜äº†èµ·æ¥ï¼Œä¸”æœ€ç»ˆè¿”å›æ–‡ä»¶çš„çœŸå®è·¯å¾„ã€‚ã€æ³¨æ„è¿™é‡Œçš„çœŸå¯¹æ–‡ä»¶ååç¼€çš„å°è¯•åŠ è½½å·¥ä½œï¼š.js &gt; .json &gt;Â .nodeã€‘</div><div><br/></div><div>Module._pathCache ä¸­ç¼“å­˜äº†å¯¹å¼•ç”¨æ¨¡å—åˆ°çœŸå®è·¯å¾„çš„ç¼“å­˜æ˜ å°„ï¼›Module._cache åˆ™ç¼“å­˜äº†å¯¹å¼•ç”¨æ¨¡å—çš„å¯¹è±¡æ˜ å°„ï¼›</div><div><br/></div><div><hr/><br/></div><div>æ¥åˆ†æ Module.prototype.load å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Given a file name, pass it to the proper extension handler.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module.prototype.load = function(filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â debug('load %j for module %j', filename, this.id);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â assert(!this.loaded);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â this.filename = filename;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // Module._nodeModulePathsçš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®å½“å‰æ–‡ä»¶çš„å…·ä½“filenameï¼Œç”Ÿæˆä¸ä¹‹å¯¹åº”çš„node_moduleså¼•ç”¨ç›®å½•é‡‘å­—å¡”ç»“æ„ï¼š</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/76E7BDFF-692A-4FC9-8812-D287A2BFBB85.png" height="auto" width="100%"/><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  this.paths = Module._nodeModulePaths(path.dirname(filename));</font></div><div><span>Â  // .js</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var extension = path.extname(filename) || '.jsâ€™;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // æ¥çœ‹ä¸‹ï¼Œæ¯ç§æ–‡ä»¶å…¶å®å¯¹åº”ç€ä¸åŒçš„æ‰“å¼€æ–¹å¼ï¼š</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/9790CAFB-2AA8-434B-BD56-9F1D50F09CA2.png" height="auto" width="100%"/><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (!Module._extensions[extension]) extension = '.js';</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Module._extensions[extension](this, filename);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â this.loaded = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>.js moduleæ–‡ä»¶çš„åŠ è½½ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Native extension for .js</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module._extensions['.js'] = function(module, filename) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // åŒæ­¥è¯»å…¥å†…å®¹</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var content = fs.readFileSync(filename, 'utf8â€™);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/D1A4F886-65E2-421F-9219-2C89C042CC61.png" height="auto" width="100%"/><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // æœ€ç»ˆè¿›å…¥module._compileå‡½æ•°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â module._compile(internalModule.stripBOM(content), filename);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>module._compile å‡½æ•°ç»†èŠ‚ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Run the file contents in the correct scope or sandbox. Expose</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// the correct helper variables (require, module, exports) to</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// the file.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Returns exception, if any.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Module.prototype._compile = function(content, filename) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // Remove shebang</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // å»æ‰æ–‡ä»¶ä¸Šé¢çš„ #!/xxxxx</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var contLen = content.length;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (contLen &gt;= 2) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (content.charCodeAt(0) === 35/*#*/ &amp;&amp;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â content.charCodeAt(1) === 33/*!*/) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (contLen === 2) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â // Exact match</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â content = '';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â } else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â // Find end of shebang line and slice it off</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â var i = 2;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â for (; i &lt; contLen; ++i) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â var code = content.charCodeAt(i);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â if (code === 10/*\n*/ || code === 13/*\r*/)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â Â Â break;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â if (i === contLen)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â content = '';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â // Note that this actually includes the newline character(s) in the</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â // new output. This duplicates the behavior of the regular expression</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â // that was previously used to replace the shebang line</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â content = content.slice(i);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // create wrapper function</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // è¿™é‡Œçš„Module.wrapå‡½æ•°ç›´æ¥å¼•ç”¨NativeWrapper.wrap</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/089C743D-0414-445B-9179-8468F59CE637.png" height="auto" width="100%"/><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><br/></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var wrapper = Module.wrap(content);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var compiledWrapper = vm.runInThisContext(wrapper, {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â filename: filename,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â lineOffset: 0,</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â displayErrors: true</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â });</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (process._debugWaitConnect) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (!resolvedArgv) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â // we enter the repl if we're not given a filename argument.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (process.argv[1]) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â resolvedArgv = Module._resolveFilename(process.argv[1], null);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â } else {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â resolvedArgv = 'repl';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // Set breakpoint on module start</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (filename === resolvedArgv) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â delete process._debugWaitConnect;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â const Debug = vm.runInDebugContext('Debug');</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Debug.setBreakPoint(compiledWrapper, 0, 0);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var dirname = path.dirname(filename);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/4380E6C1-6551-4BF9-B950-F2391276A0F7.png" height="auto" width="100%"/><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font face="Monaco">Â  // è¿™é‡Œæ¯”è¾ƒå¤æ‚ï¼ç»™requireé™„åŠ äº†å¾ˆå¤šæ–¹æ³•å’Œå±æ€§ï¼ç”¨æˆ·è‡ªå®šä¹‰é€»è¾‘ä¸­çš„requireéƒ½æ˜¯è¿™ä¸ªå‡½æ•°å…¥å£</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var require = internalModule.makeRequireFunction.call(this);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var args = [this.exports, require, this, filename, dirname];</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var depth = internalModule.requireDepth;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (depth === 0) stat.cache = new Map();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var result = compiledWrapper.apply(this.exports, args);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (depth === 0) stat.cache = null;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â return result;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>ä¸‹é¢ç»™å‡ºmain.jsæ‰§è¡Œåˆ°æ­¤çš„æˆªå›¾å’Œmod.jsæ‰§è¡Œåˆ°æ­¤çš„æˆªå›¾ï¼š</div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/06498EC3-4561-4C4A-9AE9-822B85825E0D.png" height="auto" width="100%"/><br/></div><div><br/></div><div><img src="JS%20%E5%B1%82%E9%9D%A2%E7%9A%84%20Native%20%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.resources/F015C721-D23C-4D41-A729-35A15324552B.png" height="auto" width="100%"/><br/></div><div><br/></div><div>æœ€ç»ˆï¼Œç”¨æˆ·è‡ªå®šä¹‰æ¨¡å—å¼•å…¥å®Œæ¯•ï¼</div><div><br/></div><div>TODOï¼šå…³äºdepthçš„ç†è§£æ¬ ç¼º</div><div/><div/><div/><div/><div/><div/><div/>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šSat Dec 24 2016 16:09:09 GMT+0800 (CST)</p>
</div></body></html>