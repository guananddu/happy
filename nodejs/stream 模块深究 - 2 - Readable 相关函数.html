<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2017-01-04 09:13:49 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-01-05 08:39:44 +0000"/><title>stream æ¨¡å—æ·±ç©¶ - 2 - Readable ç›¸å…³å‡½æ•°</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>stream æ¨¡å—æ·±ç©¶ - 2 - Readable ç›¸å…³å‡½æ•°</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>é€šè¿‡å®˜æ–¹æ‰‹å†Œå’Œç›¸å…³èµ„æ–™ï¼Œå…ˆæ¥å›é¡¾ä¸€ä¸‹ Readable Stream çš„ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œç½‘ä¸Šæœ‰ä¸€äº›é’ˆå¯¹ Stream çš„å­¦ä¹ èµ„æ–™ï¼Œè§ï¼š<a href="http://tech.meituan.com/stream-internals.html">http://tech.meituan.com/stream-internals.html</a>ï¼Œä»é‡Œé¢æŠ½å–ä¸¤å¼  Readable Stream çš„è¿è¡Œæµç¨‹ï¼š</div><div><br/></div><div><img src="stream%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%202%20-%20Readable%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0.resources/0C0C86DB-3088-437B-8068-458B0BD062E0.png" height="auto" width="100%"/><br/></div><div><br/></div><div>å…³äº read å‡½æ•°çš„è°ƒç”¨ï¼š</div><div><br/></div><div><img src="stream%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%202%20-%20Readable%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0.resources/01E4AEB7-200D-47AC-B33F-8BE91F5E0BF4.png" height="auto" width="100%"/><br/></div><div><br/></div><div>å®˜æ–¹çš„æ–‡æ¡£åˆ™ç»™å‡ºäº†â€œä¸¤ç§è¿è¡Œæ¨¡å¼ï¼ä¸‰ç§å†…éƒ¨çŠ¶æ€â€çš„é˜è¿°ï¼ˆéå¸¸é‡è¦ï¼‰ï¼Œè§ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Two Modes#ã€ä¸¤ç§è¿è¡Œæ¨¡å¼ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Readable streams effectively operate in one of two modes: flowing and paused.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">When in flowing mode, data is read from the underlying system automatically and provided to an application as quickly as possible using events via the EventEmitter interface.ã€flowing æ¨¡å¼ä¸‹ï¼Œè‡ªåŠ¨è¯»å–æ•°æ®å¹¶é€šè¿‡ EventEmitter è§¦å‘ data äº‹ä»¶æ¥ä¼ é€’å¯æ¶ˆè´¹æ•°æ®èµ„æºã€‘</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">In paused mode, the stream.read() method must be called explicitly to read chunks of data from the stream.ã€è€Œ paused æ¨¡å¼ä¸‹ï¼Œåˆ™éœ€è¦æ˜ç¡®çš„è°ƒç”¨ read() å‡½æ•°æ¥è·å–å¯æ¶ˆè´¹çš„æ•°æ®èµ„æºã€‘</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">All Readable streams begin in paused mode but can be switched to flowing mode in one of the following ways:</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Adding a 'data' event handler.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Calling the stream.resume() method.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Calling the stream.pipe() method to send the data to a Writable.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The Readable can switch back to paused mode using one of the following:</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">If there are no pipe destinations, by calling the stream.pause() method.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">If there are pipe destinations, by removing any 'data' event handlers, and removing all pipe destinations by calling the stream.unpipe() method.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The important concept to remember is that a Readable will not generate data until a mechanism for either consuming or ignoring that data is provided. If the consuming mechanism is disabled or taken away, the Readable will attempt to stop generating the data.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Three States#ã€ä¸‰ç§å†…éƒ¨çŠ¶æ€ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The "two modes" of operation for a Readable stream are a simplified abstraction for the more complicated internal state management that is happening within the Readable stream implementation.ã€ä½œä¸º Readable Stream å®ç°çš„åº•å±‚é€»è¾‘ï¼Œåˆ™ç”¨ä¸‰ç§å†…éƒ¨çŠ¶æ€æ¥ä¸ºä¸Šå±‚çš„â€œä¸¤ç§è¿è¡Œæ¨¡å¼â€æä¾›æ”¯æŒÂ ã€‘</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Specifically, at any given point in time, every Readable is in one of three possible states:</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">readable._readableState.flowing = null</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">readable._readableState.flowing = false</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">readable._readableState.flowing = true</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">When readable._readableState.flowing is null, no mechanism for consuming the streams data is provided so the stream will not generate its data.ã€null è¯´æ˜å¹¶æ²¡æœ‰æŒ‚è½½æ•°æ®èµ„æºæ¶ˆè´¹è€…ã€‘</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Attaching a listener for the 'data' event, calling the readable.pipe() method, or calling the readable.resume() method will switch readable._readableState.flowing to true, causing the Readable to begin actively emitting events as data is generated.ã€true åˆ™è¯´æ˜å¯ä»¥æŒç»­äº§ç”Ÿå¯æ¶ˆè´¹æ•°æ®ã€‘</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Calling readable.pause(), readable.unpipe(), or receiving "back pressure" will cause the readable._readableState.flowing to be set as false, temporarily halting the flowing of events but not halting the generation of data.ã€false ä»£è¡¨æ¶ˆè´¹æ•°æ®ä»æ—§å­˜åœ¨äº internal bufferï¼Œä½†æ˜¯ä¸å†è§¦å‘ data äº‹ä»¶ã€‘</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">While readable._readableState.flowing is false, data may be accumulating within the streams internal buffer.ã€åœ¨ false çš„çŠ¶æ€ä¸‹ï¼Œäº§ç”Ÿçš„å¯æ¶ˆè´¹æ•°æ®è¢«ä¿æŒåœ¨å†…éƒ¨çš„ buffer ä¸­ï¼Œç­‰å¾…æ¶ˆè´¹ã€‘</font><br/></div></div><div><br/></div><div>å¤§ä½“ä¸Šæœ‰ä¸ªäº†è§£ä»¥åï¼Œä»ä¸‹é¢çš„æµ‹è¯•ä»£ç è¿›å…¥å®ç°æµç¨‹ï¼Œæ¥ä¸€æ¢ç©¶ç«Ÿï¼š<br/></div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">const </span>readable = fs.<span style="color:#ffc66d;">createReadStream</span>( filePath<span style="color:#cc7832;">, </span>{<br/>Â Â Â  <span style="color:#9876aa;">highWaterMark</span>: <span style="color:#6897bb;">20000<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'data'</span><span style="color:#cc7832;">, </span>( chunk ) =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`readable on data: received </span>${chunk.<span style="color:#9876aa;">length</span>}<span style="color:#6a8759;"> bytes of data.` </span>)<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;</span>
</pre>ä¸Šé¢çš„ä»£ç ï¼Œé€šè¿‡ fs.createReadStream å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµï¼Œç´§æ¥ç€é€šè¿‡ç›‘å¬ data äº‹ä»¶ï¼Œè¿›å…¥ on å‡½æ•°æ¥çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// set up data events if they are asked for</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// Ensure readable listeners eventually get something</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Readable.prototype.on = function(ev, fn) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const res = Stream.prototype.on.call(this, ev, fn);</font></div><div><span>Â  // ev å¦‚æœå…¨ç­‰ `data`</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (ev === 'data') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // Start flowing on next tick if stream isn't explicitly paused</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // é»˜è®¤æ–°åˆ›å»ºçš„ readstream çš„ _readableState.flowing æ˜¯ nullï¼Œå› ä¸ºè¿˜æ²¡æœ‰æŒ‚è½½ä»»ä½•æ¶ˆè´¹æœºåˆ¶</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  // æ‰€ä»¥ä¸‹åˆ—åˆ¤æ–­æ˜¯æ­£ç¡®çš„</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (this._readableState.flowing !== false)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â this.resume(); // èµ°å…¥è¿™é‡Œ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else if (ev === 'readable') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return res;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>æ¥çœ‹è¿›å…¥ this.resume() ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// pause() and resume() are remnants of the legacy readable stream API</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// If the user uses them, then switch into old mode.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Readable.prototype.resume = function() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var state = this._readableState;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // å¦‚æœ state.flowing ä¸ä¸º null å’Œ false</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!state.flowing) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â debug('resume');</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.flowing = true; // åˆ‡æ¢çŠ¶æ€</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â resume(this, state);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return this;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>èµ°å…¥å†…éƒ¨ç§æœ‰å‡½æ•° resume( this, stateÂ )ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function resume(stream, state) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // åˆå§‹åŒ–æ—¶ï¼Œ<font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">state.resumeScheduled ä¸ºÂ <font style="font-size: 12px; color: rgb(51, 51, 51);">false</font></font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!state.resumeScheduled) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.resumeScheduled = true; // æ›´æ–°çŠ¶æ€</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â process.nextTick(resume_, stream, state);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>å†æ¥çœ‹ process.nextTick ä¸­çš„ resume_ å‡½æ•°æ„æˆï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function resume_(stream, state) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // åˆå§‹åŒ–çš„ state.reading ä¸º false</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!state.reading) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â debug('resume read 0â€™);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â stream.read(0); // èµ°å…¥ read å‡½æ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div>Â  // æ¢å¤çŠ¶æ€</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â state.resumeScheduled = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â state.awaitDrain = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â stream.emit('resumeâ€™); // è§¦å‘ resume äº‹ä»¶</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â flow(stream); // flow å‡½æ•°è§ä¸‹</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.flowing &amp;&amp; !state.reading)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â stream.read(0);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>flow å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function flow(stream) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const state = stream._readableState;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â debug('flow', state.flowing);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // å¦‚æœ state.flowing ä¸º true ï¼Œä¸” stream.read() çš„è¿”å›å€¼ä¸ä¸ºç©ºï¼Œåˆ™æŒç»­ä¸‹å»</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â while (state.flowing &amp;&amp; stream.read() !== null);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>ä» resume åˆ° process.nextTick çš„ resume_ å’Œ flow ï¼Œéƒ½å°‘ä¸äº† stream çš„ read å‡½æ•°è°ƒç”¨ï¼Œå¯è§ï¼Œé€šè¿‡ç›‘å¬ data äº‹ä»¶ï¼Œå®ç°äº†å¯è¯»æµçš„â€œå…¨è‡ªåŠ¨åŒ–â€ï¼Œæ¥ä¸‹æ¥åˆ†æ read å‡½æ•°è°ƒç”¨ã€‚</div><div><br/></div><div><hr/></div><div><br/></div><div>åˆ†æ read å‡½æ•°ï¼Œåˆ™ä¸éœ€è¦å¼€å¯ data äº‹ä»¶ç›‘å¬ï¼Œå› ä¸ºæ–°å»ºçš„ Readable Stream ä¼šè‡ªåŠ¨è¿›å…¥ paused çŠ¶æ€ï¼Œè§æµ‹è¯•ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">const </span>readable = fs.<span style="color:#ffc66d;">createReadStream</span>( filePath<span style="color:#cc7832;">, </span>{<br/>Â Â Â  <span style="color:#9876aa;">highWaterMark</span>: <span style="color:#6897bb;">20000<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>readable.<span style="color:#ffc66d;">on</span>( <span style="color:#6a8759;">'readable'</span><span style="color:#cc7832;">, </span>() =&gt; {<br/>Â Â Â  <span style="color:#cc7832;font-weight:bold;">var </span>chunk<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#cc7832;font-weight:bold;">while </span>( <span style="color:#cc7832;font-weight:bold;">null </span>!== ( chunk = readable.<span style="color:#ffc66d;">read</span>() ) ) {<br/>Â Â Â Â Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`Received </span>${chunk.<span style="color:#9876aa;">length</span>}<span style="color:#6a8759;"> bytes of data.` </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>}<br/>} )<span style="color:#cc7832;">;</span>
</pre>é€šè¿‡ç›‘å¬ readable äº‹ä»¶ï¼Œæ¥æ˜ç¡®è°ƒç”¨ read å‡½æ•°è·å–æ•°æ®ï¼Œæ¥çœ‹ä¸‹ on å‡½æ•°å¦‚ä½•å¤„ç† readable äº‹ä»¶ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// set up data events if they are asked for</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// Ensure readable listeners eventually get something</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Readable.prototype.on = function(ev, fn) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const res = Stream.prototype.on.call(this, ev, fn);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (ev === 'data') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else if (ev === 'readable') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â const state = this._readableState;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (!state.endEmitted &amp;&amp; !state.readableListening) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  Â  // ä¸€äº›åˆ—çŠ¶æ€å˜æ›´</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â state.readableListening = state.needReadable = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â state.emittedReadable = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â if (!state.reading) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  Â  // èµ°å…¥è¿™é‡Œï¼Œåœ¨ nextTick æ‰§è¡Œå†…éƒ¨å‡½æ•°ï¼šnReadingNextTick</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â process.nextTick(nReadingNextTick, this);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â } else if (state.length) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â emitReadable(this, state);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return res;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>nReadingNextTick å‡½æ•°ä¹Ÿå¾ˆç®€å•ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function nReadingNextTick(self) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â debug('readable nexttick read 0');</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â self.read(0); // åŒæ ·æ˜¯è°ƒç”¨äº† read() å‡½æ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>ç”±æ­¤ï¼Œå½“è¿›å…¥ readable äº‹ä»¶å›è°ƒå‡½æ•°æ—¶ï¼Œå·²ç»æ‰§è¡Œè¿‡ä¸€æ¬¡ self.read() å‡½æ•°è°ƒç”¨ï¼ŒStream å†…éƒ¨çš„ buffer å·²ç»å­˜æœ‰æ•°æ®ã€‚read å‡½æ•°çš„è°ƒç”¨ç»†èŠ‚ï¼Œè¿›å…¥ readable.read() ã€ä¸å¸¦å‚æ•°ã€‘ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// you can override either this method, or the async _read(n) below.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Readable.prototype.read = function(n) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ readable äº‹ä»¶å›è°ƒä¸­è¿›å…¥ read() å‡½æ•°è°ƒç”¨ä¹‹å‰ï¼Œå·²ç»åœ¨ nReadingNextTick ä¸­æ‰§è¡Œè¿‡ä¸€é self.read(0)</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  // æ‰€ä»¥ internal buffer ä¸­ï¼Œå·²ç»æœ‰äº†æ•°æ®</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span>Â <span>Â // ä¸‹é¢çš„æ–­ç‚¹å˜é‡åˆ†æåŸºäº readable å›è°ƒå‡½æ•°ä¸­çš„ read() è°ƒç”¨é˜¶æ®µ</span></span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span><span><span>Â  // æ­¤æ—¶çš„ n === undefined</span><br/></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â debug('read', n);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â n = parseInt(n, 10); // n =&gt; NaN</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var state = this._readableState;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var nOrig = n;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (n !== 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.emittedReadable = false;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // if we're doing read(0) to trigger a readable event, but we</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // already have a bunch of data in the buffer, then just trigger</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // the 'readable' event and move on.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (n === 0 &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â state.needReadable &amp;&amp;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â (state.length &gt;= state.highWaterMark || state.ended)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â debug('read: emitReadable', state.length, state.ended);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (state.length === 0 &amp;&amp; state.ended)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â endReadable(this); // æ»¡è¶³ç¬¦åˆ end äº‹ä»¶çš„è§¦å‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â else</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â emitReadable(this); // è§¦å‘ readable äº‹ä»¶</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><span>Â  // n:<font style="font-size: 12px; color: rgb(51, 51, 51);">NaN | state:<font style="font-size: 12px; color: rgb(51, 51, 51);">ReadableState</font></font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <span>è§ä¸‹åˆ†æï¼Œè¿”å›Â <font style="font-size: 12px; color: rgb(51, 51, 51);">20000</font></span></span><br/></font></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â n = howMuchToRead(n, state);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // if we've ended, and we're now clear, then finish it up. æ£€æŸ¥æ˜¯ä¸æ˜¯å·²ç»ç»“æŸ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (n === 0 &amp;&amp; state.ended) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (state.length === 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â endReadable(this);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><span>Â Â </span><br/></div><div><span>Â  // æ³¨æ„è¿™é‡Œçš„æ³¨é‡Š</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // All the actual chunk generation logic needs to be</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // *below* the call to _read.Â Â The reason is that in certain</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // synthetic stream cases, such as passthrough streams, _read</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // may be a completely synchronous operation which may change</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // the state of the read buffer, providing enough data when</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // before there was *not* enough.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â //</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // So, the steps are:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // 1. Figure out what the state of things will be after we do</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // a read from the buffer.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â //</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // 2. If that resulting state will trigger a _read, then call _read.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Note that this may be asynchronous, or synchronous.Â Â Yes, it is</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // deeply ugly to write APIs this way, but that still doesn't mean</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // that the Readable class should behave improperly, as streams are</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // designed to be sync/async agnostic.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Take note if the _read call is sync or async (ie, if the read call</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // has returned yet), so that we know whether or not it's safe to emit</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // 'readableâ€™ etc.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â //</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // 3. Actually pull the requested chunks out of the buffer and return.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // if we need a readable event, then we need to do some reading.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var doRead = state.needReadable;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â debug('need readable', doRead);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // if we currently have less than the highWaterMark, then also read some</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // å¦‚æ³¨é‡Šæ‰€è¯´</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.length === 0 || state.length - n &lt; state.highWaterMark) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â doRead = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â debug('length less than watermark', doRead);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // however, if we've ended, then there's no point, and if we're already</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // reading, then it's unnecessary.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.ended || state.reading) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â doRead = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â debug('reading or ended', doRead);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else if (doRead) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // èµ°å…¥æ­¤åˆ†æ”¯</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â debug('do read');</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.reading = true; // read è¿›è¡Œä¸­çš„æ ‡è¯†</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.sync = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ğŸŒŸæ³¨æ„è‹¥æ­¤æ—¶çš„ state.length === 0 åˆ™éœ€è¦è§¦å‘ä¸€ä¸ª readable äº‹ä»¶</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // if the length is currently zero, then we *need* a readable event.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // state.length === 20000</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (state.length === 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â state.needReadable = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // call internal read method ğŸŒŸğŸŒŸğŸŒŸæ‰å…¥çœŸæ­£çš„å®ç°å±‚ _read å‡½æ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // å› ä¸ºæ­¤èŠ‚é‡‡ç”¨ fs æ¨¡å—çš„ createReadStream æ¥åšå®éªŒï¼Œå…·ä½“è§ä¸‹åˆ†æ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this._read(state.highWaterMark); // å¼€å§‹è¯»å–æ•°æ®ã€é»˜è®¤å¼‚æ­¥ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // å®ç°å±‚æ¬¡çš„ this._read é»˜è®¤æ˜¯ä¸ªå¼‚æ­¥å‡½æ•°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.sync = false; // é»˜è®¤å¼‚æ­¥</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // If _read pushed data synchronously, then `reading` will be false,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // and we need to re-evaluate how much data we can return to the user.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (!state.reading) // å¦‚æœæ˜¯åŒæ­¥</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â n = howMuchToRead(nOrig, state);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><span>Â  // æŒ‰ç…§å¸¸è§„çš„å¼‚æ­¥å®ç°ï¼Œåœ¨ä½¿ç”¨ fs.read çš„åº•å±‚çº¿ç¨‹æ± è¯»å–æ–‡ä»¶æ•°æ®çš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹çš„é€»è¾‘ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var ret;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (n &gt; 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // è¿›å…¥ fromList å‡½æ•°ï¼Œè§ä¸‹åˆ†æ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  // æœ€ç»ˆæ‹¿åˆ°ä¸Šä¸€æ¬¡è°ƒç”¨ read( 0 ) æ—¶è¯»å–çš„æ•°æ®</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â ret = fromList(n, state);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â else</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â ret = null;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (ret === null) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.needReadable = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â n = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // æ‰§è¡Œå®Œ fromList åï¼Œå·²ç»æ‹¿åˆ°ç»“æœï¼Œstate.length å‡å» n çš„å¤§å°</span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  // å› ä¸º n çš„å¤§å°çš„æ•°æ®èµ„æºå·²ç»â€œå‡†å¤‡æ‹¿å»æ¶ˆè´¹â€ã€‚ã€‚ã€‚</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span>Â  Â  // state.length è®°å½•æ‰€æœ‰å¯æ¶ˆè´¹çš„æ•°æ®èµ„æºæ€»é•¿</span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.length -= n;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.length === 0) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // If we have nothing in the buffer, then we want to know</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // as soon as we *do* get something into the buffer.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (!state.ended)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â state.needReadable = true;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // If we tried to read() past the EOF, then emit end on the next tick.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (nOrig !== n &amp;&amp; state.ended)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â endReadable(this);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (ret !== null)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ç»ˆäºè§¦å‘äº† data äº‹ä»¶ï¼ŒæŠŠç¬¬ä¸€æ¬¡çš„ read( 0 ) æ‹¿åˆ°çš„æ•°æ®è¿”å›</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this.emit('data', ret);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return ret;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>å…³äº howMuchToRead( n, stateÂ ) å‡½æ•°è°ƒç”¨ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// This function is designed to be inlinable, so please take care when making</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// changes to the function body.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function howMuchToRead(n, state) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // n:<font style="font-size: 12px; color: rgb(51, 51, 51);">NaN</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (n &lt;= 0 || (state.length === 0 &amp;&amp; state.ended)) // å¦‚æœè¾¾åˆ° end é˜¶æ®µ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.objectMode) // å¦‚æœæ˜¯ objectMode</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return 1; // ç›´æ¥è¿”å› 1</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // å¦‚æœè°ƒç”¨æ˜¯ read() å³ n ä¸º NaN</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (n !== n) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // Only flow one buffer at a time</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // å¦‚æœ Readable Stream æ˜¯ flowing çŠ¶æ€</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  // ä¸Šè¿°æµ‹è¯•ä»£ç ç¤ºä¾‹ä¸º paused çŠ¶æ€ã€å› ä¸ºå¹¶æ²¡æœ‰ç»‘å®š data äº‹ä»¶ã€‘</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span>Â  Â  // ä¸” internal buffer è‹¥æ²¡æœ‰æ•°æ®åˆ™ state.length == 0</span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span><span>Â  Â  // ä½†æ˜¯ï¼æ­¤æ¬¡æ–­ç‚¹è°ƒè¯•ï¼Œå·²ç»ç»è¿‡ä¸€æ¬¡ read( 0 )ï¼Œæ‰èƒ½è¿›å…¥ readable çš„å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ state.length å·²ç»æœ‰å€¼</span><br/></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span><span><span>Â  Â  // æ­¤æ—¶ï¼state.length == 20000( highWaterMark == 20000 )</span><br/></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span><span><span><span>Â  Â  // ä¸”ï¼state.buffer( <font style="font-size: 12px; color: rgb(51, 51, 51);">BufferList</font>Â ) =&gt; head( data:<font style="font-size: 12px; color: rgb(51, 51, 51);">Uint8Array[20000];next:<font style="font-size: 12px; color: rgb(51, 51, 51);">null</font></font> ) å·²æœ‰å…ƒç´ </span><br/></span></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (state.flowing &amp;&amp; state.length)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â return state.buffer.head.data.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â else</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  // æ‰€ä»¥æ­¤æ¬¡ï¼Œç›´æ¥è¿”å›ç›®å‰ buffer ä¸­å·²æœ‰çš„æ•°æ®é•¿åº¦</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â return state.length; //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">20000 ï¼ˆä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ read( 0 ) æ—¶çš„ç»“æœï¼‰</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>å…³äº fs.createReadStream ä¸­çš„ ReadStream.prototype._read åº•å±‚å‡½æ•°å®ç°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">ReadStream.prototype._read = function(n) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // n === 20000</span><br/></font></div><div><span>Â  // è¿™é‡Œçš„ pool ä½œä¸ºæ•°æ®ç¼“å­˜æ± ï¼Œå› ä¸ºå·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡ read( 0 )ï¼Œæ•… pool ä¸­å·²æœ‰æ•°æ®</span><br/></div><div><span><span>Â  // pool( <font style="font-size: 12px; color: rgb(51, 51, 51);">Uint8Array[20000], pool.length:<font style="font-size: 12px; color: rgb(51, 51, 51);">20000, pool.used:<font style="font-size: 12px; color: rgb(51, 51, 51);">20000</font></font></font>Â )</span><br/></span></div><div><span><span><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">const kMinPoolSpace = 128; 2^8ï¼2</font></span><br/></span></span></div><div><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è‹¥ pool å‰©ä½™ç©ºé—´ä¸è¶³ï¼Œåˆ™é‡æ–°å¼€è¾Ÿç©ºé—´</span><br/></font></span></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!pool || pool.length - pool.used &lt; kMinPoolSpace) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // discard the old pool.ã€æŠ›å¼ƒæ—§æ•°æ®ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â pool = null;</font></div><div><span>Â  Â  // æ­¤å‡½æ•°çš„ä¸¤éƒ¨æ“ä½œï¼š</span><br/></div><div><span><span>Â  Â  //<font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â pool = Buffer.allocUnsafe(poolSize); // Buffer çš„çŸ¥è¯†ç‚¹è¯·æŸ¥çœ‹ç›¸å…³ç« èŠ‚</font></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â <span>Â  // Â </span>pool.used = 0;</font><span><span/><br/></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â allocNewPool(this._readableState.highWaterMark);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Grab another reference to the pool in the case that while we're</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // in the thread pool another read() finishes up the pool, and</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // allocates a new one.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var thisPool = pool;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ç®—å‡ºæœ¬æ¬¡éœ€è¦è¯»å–å¤šå°‘æ•°æ®Â <font style="font-size: 12px; color: rgb(51, 51, 51);">20000</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var toRead = Math.min(pool.length - pool.used, n);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var start = pool.used; // 0</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (this.pos !== undefined)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â toRead = Math.min(this.end - this.pos + 1, toRead);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // already read everything we were supposed to read!</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // treat as EOF.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (toRead &lt;= 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return this.push(null); // ç»“æŸçš„æ ‡è¯†</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // the actual read.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var self = this;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ğŸŒŸğŸŒŸğŸŒŸ çœŸæ­£å¼€å§‹è¯»å–æ–‡ä»¶æ•°æ®</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  // å‡½æ•°è¯´æ˜ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Read data from the file specified by fd.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // buffer is the buffer that the data will be written to.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // offset is the offset in the buffer to start writing at.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // length is an integer specifying the number of bytes to read.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // position is an integer specifying where to begin reading from in the file. If position is null, data will be read from the current file position.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // The callback is given the three arguments, (err, bytesRead, buffer).</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  fs.read(this.fd, pool, pool.used, toRead, this.pos, onread);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // move the pool positions, and internal position for reading.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (this.pos !== undefined)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â this.pos += toRead;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â pool.used += toRead; // è‡ªåŠ </font></div><div><span>Â  // fs.read çš„å›è°ƒ</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â function onread(er, bytesRead) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (er) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â if (self.autoClose) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â self.destroy();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â self.emit('error', er);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â var b = null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â if (bytesRead &gt; 0) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  Â  // bytesRead ä»£è¡¨æ­¤æ¬¡è¯»å–çš„å­—èŠ‚æ•°</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  Â  // self.bytesRead ä»£è¡¨æ€»å…±è¯»å–çš„å­—èŠ‚æ•°</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â self.bytesRead += bytesRead;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  Â  // è¿”å›æ­¤æ¬¡çš„ buffer</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span>Â Â  Â <span>Â  Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">Returns a new Buffer that references the same memory as the original, but offset and cropped by the start and end indices.</font></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  Â  //Â </span></span>Note that modifying the new Buffer slice will modify the memory in the original Buffer because the allocated memory of the two objects overlap.</font><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span><span/></span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â b = thisPool.slice(start, start + bytesRead);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â }</font></div><div><span>Â Â  Â <span>Â  // æœ€ç»ˆè°ƒç”¨ readable.push å‡½æ•°ã€ä¹‹ååˆ†æã€‘</span></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â self.push(b);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>å…³äº fromList æ˜¯å¦‚ä½•åˆ¶é€ æœ€ç»ˆçš„ç»“æœçš„ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function fromList(n, state) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // nothing buffered</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.length === 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return null; // æ²¡æœ‰ buffered åˆ™ç›´æ¥è¿”å› null</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var ret;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (state.objectMode)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // BufferList.prototype.shift // head.data å¼¹æ ˆ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â ret = state.buffer.shift(); // æ³¨æ„è¿™é‡Œ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â else if (!n || n &gt;= state.length) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // èµ°å…¥æ­¤åˆ†æ”¯ã€ç¬¬äºŒæ¬¡ read()ã€‘</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // è¯»å–æ‰€æœ‰æ•°æ®çš„æƒ…å†µ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // read it all, truncate the list</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (state.decoder) // null</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  //Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">BufferList.prototype.join</font></span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  // æ ¹æ®ä»£ç å¯çŸ¥ï¼Œæ­¤å‡½æ•°æ˜¯å°†æ‰€æœ‰å…ƒç´ çš„ data( Buffer ) è°ƒç”¨ toString() å³ å˜æˆ \uxxxx ç¼–ç è¿ç»“è¾“å‡º</span></span><br/></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â ret = state.buffer.join(â€˜â€™);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â else if (state.buffer.length === 1)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  // ç¬¬äºŒæ¬¡ read() èµ°å…¥è¿™é‡Œï¼Œç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ çš„ data( BufferÂ  )</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â ret = state.buffer.head.data;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â else</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â  // BufferList.prototype.concat æ–°å»ºä¸€ä¸ª Buffer å¹¶ä¸”æŠŠå‰©ä½™çš„ BufferList ä¸­çš„æ‰€æœ‰å…ƒç´  copy è‡³æ–° Buffer ä¸­</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â ret = state.buffer.concat(state.length);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // BufferList.prototype.clear å‡½æ•°ä½“è§ä¸‹ï¼Œæ¸…é™¤é“¾è¡¨</span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  // BufferList.prototype.clear = function() {</font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  <span>Â Â </span>//<span>Â Â  Â </span>this.head = this.tail = null;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  // Â  Â this.length = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  // };</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â state.buffer.clear();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // è·å–éƒ¨åˆ†æ•°æ®</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // read part of list</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â ret = fromListPartial(n, state.buffer, state.decoder);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return ret;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>è®°å½•æ‰§è¡Œç‚¹ï¼š</div><div><br/></div><div>readable.on( â€˜readableâ€™, xxxÂ ) åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œé€šè¿‡ nextTick å›è°ƒï¼Œè§¦å‘ä¸€æ¬¡ read(0) æ“ä½œï¼š</div><div><br/></div><div>ğŸŒŸ1âƒ£ï¸ç¬¬ä¸€æ¬¡çš„ read(0)ï¼Œæ ‡è®° state.needReadable ä¸º trueï¼Œä¸”å› ä¸º readable çš„ state.reading ä¸º falseï¼Œæ•…è¿›å…¥ readable._read çš„åº•å±‚è°ƒç”¨å¼€å§‹çœŸæ­£è·å–æ–‡ä»¶æ•°æ®ï¼ˆå¼‚æ­¥ï¼‰ï¼ŒåŒæ—¶æ ‡è®° state.reading ä¸º trueã€‚readable._read å‡½æ•°é€šè¿‡æ›´åº•å±‚çš„ fs.read å‡½æ•°æ¥å¼‚æ­¥è·å–æ–‡ä»¶æ•°æ®ï¼Œå¹¶æœ€ç»ˆåœ¨æŸæ—¶åˆ»é€šè¿‡å…¶å†…éƒ¨å›è°ƒå‡½æ•°æœ€ç»ˆè°ƒç”¨ readable.push(chunk) å‡½æ•°ï¼Œå°†æ•°æ®ä»åº•å±‚æ¨é€è‡³ä¸Šå±‚ï¼Œå¹¶ä¸”å°† readable.reading ç½®ä¸º falseï¼Œæ›´æ–° state.length(å¯æ¶ˆè´¹æ•°æ®æ€»é•¿)ï¼Œå¦‚æœ state.needReadable ä¸º true åˆ™ç»§ç»­è§¦å‘ `readable` äº‹ä»¶ï¼Œç­‰å¾…ä¸‹æ¬¡ç»§ç»­è°ƒç”¨ read()ï¼›</div><div><br/></div><div>ğŸŒŸ2âƒ£ï¸ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ¯• read(0) ä¹‹åï¼Œæ€»ä¼šæœ‰æ•°æ®è¢« push å…¥ internal bufferï¼Œæ­¤æ—¶å°±å¯ä»¥è§¦å‘ `readable` äº‹ä»¶äº†ï¼Œäºæ˜¯ä¹ï¼Œå°±è¿›å…¥äº†æœ¬èŠ‚çš„åˆ†æï¼›</div><div><br/></div><div>ğŸŒŸ3âƒ£ï¸ç¬¬ä¸€æ¬¡è¿›å…¥ readable äº‹ä»¶å›è°ƒï¼Œè¯´æ˜å·²ç»æœ‰äº†å¯æ¶ˆè´¹æ•°æ®ï¼Œäºæ˜¯å†æ¬¡æ‰‹åŠ¨è°ƒç”¨ readable.read() å‡½æ•°æ¥è·å–æ•°æ®ï¼Œæœ€ç»ˆé€šè¿‡æœ¬èŠ‚åˆ†æçš„ä¸€ç³»åˆ—è°ƒç”¨ï¼Œåœ¨ç¬¬ä¸€æ¬¡çš„ while å¾ªç¯åˆ¤æ–­ä¸­ï¼Œè·å–åˆ°ç¬¬ä¸€æ¬¡ read(0) æ‰€å¾—åˆ°çš„æ•°æ®ï¼Œå¹¶æœ€ç»ˆè§¦å‘ `data` äº‹ä»¶ï¼Œå¹¶ä¸”è¿”å›ç»“æœï¼Œä¸æ­¤åŒæ—¶ï¼Œæ­¤è¿‡ç¨‹è¿˜è°ƒç”¨äº†åº•å±‚çš„ readable._read å‡½æ•°æ¥è·å–åç»­æ•°æ®ï¼›</div><div><br/></div><div>ğŸŒŸ4âƒ£ï¸ç¬¬äºŒæ¬¡è¿›å…¥ 3 ä¸­çš„ while å¾ªç¯åˆ¤æ–­ï¼Œç»§ç»­æ‰§è¡Œ read() å‡½æ•°ï¼Œæ­¤æ—¶å› ä¸º 3 ä¸­çš„ readble._read å‡½æ•°åœ¨è·å–åç»­æ•°æ®æ—¶è¿˜æ²¡æœ‰å®Œæˆï¼Œinternal buffer ä¸­ä»æ—§ä¸ºç©ºï¼Œæ‰€ä»¥æ­¤ä¸€æ­¥éª¤ï¼Œread() å‡½æ•°å°†å¾—åˆ° null çš„ç»“æœï¼Œæœ€ç»ˆ while å¾ªç¯è·³å‡ºï¼Œåªèƒ½ç­‰å¾…ä¸‹ä¸€æ¬¡çš„ `readable` äº‹ä»¶è¢«è§¦å‘ï¼›</div><div><br/></div><div>ğŸŒŸ5âƒ£ï¸ç¬¬äºŒæ¬¡è¿›å…¥ readable äº‹ä»¶å›è°ƒï¼Œè¯´æ˜æœ‰ç¬¬äºŒæ‰¹æ•°æ®åˆ°è¾¾ï¼Œä¼šå†æ¬¡é‡å¤ 1ï¼Œ2ï¼Œ3ï¼Œ4 æ­¥éª¤ï¼Œä¸å†èµ˜è¿°ï¼›</div><div><br/></div><div>ğŸŒŸ6âƒ£ï¸ç¬¬ä¸‰æ¬¡è¿›å…¥ readable äº‹ä»¶å›è°ƒï¼Œè¯´æ˜æœ‰ç¬¬ä¸‰æ‰¹æ•°æ®åˆ°è¾¾ï¼Œä¼šå†æ¬¡é‡å¤ 1ï¼Œ2ï¼Œ3ï¼Œ4 æ­¥éª¤ï¼Œä¸å†èµ˜è¿°ï¼›</div><div><br/></div><div>ğŸŒŸ7âƒ£ï¸å…¶å®ç¬¬ä¸‰æ¬¡æ‰§è¡Œ readable å›è°ƒï¼Œè·å–åˆ°çš„æ•°æ®å·²ç»æ˜¯æœ€åçš„æ•°æ®ï¼›ä»æ—§ä¼šæœ‰ç¬¬å››æ¬¡æ‰§è¡Œ readable å›è°ƒï¼Œä½†æ˜¯æ­¤æ—¶çš„ read() å·²ç»è·å–ä¸åˆ°ä»»ä½•æ•°æ®ï¼ŒåŒæ—¶ read å†…ä¼šæŠŠ state.ended æ ‡è®°ä¸º true ä»¥ç»“æŸæ‰§è¡Œï¼Œå¦‚ä¸‹ä»£ç ï¼š</div><div><br/></div><div>From Readable.read:</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// if we've ended, and we're now clear, then finish it up.<br/></span><span style="color:#cc7832;font-weight:bold;">if </span>(n === <span style="color:#6897bb;">0 </span>&amp;&amp; state.ended) {<br/>Â  <span style="color:#cc7832;font-weight:bold;">if </span>(state.length === <span style="color:#6897bb;">0</span>)<br/>Â Â Â  endReadable(<span style="color:#cc7832;font-weight:bold;">this</span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â  </span><span style="color:#cc7832;font-weight:bold;">return null</span><span style="color:#cc7832;">;<br/></span>}
</pre></div><div>Then çœ‹çœ‹æœ€ç»ˆå¦‚ä½•ç»“æŸï¼ŒåŠå…¶å¦‚ä½•è§¦å‘ end äº‹ä»¶ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">function </span>endReadable(stream) {<br/>Â  <span style="color:#cc7832;font-weight:bold;">var </span>state = stream._readableState<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;">Â  </span><span style="color:#808080;">// If we get here before consuming all the bytes, then that is a<br/></span><span style="color:#808080;">Â  // bug in node.Â  Should never happen.<br/></span><span style="color:#808080;">Â  </span><span style="color:#cc7832;font-weight:bold;">if </span>(state.length &gt; <span style="color:#6897bb;">0</span>)<br/>Â Â Â  <span style="color:#cc7832;background-color:#344134;font-weight:bold;">throw new </span><span style="background-color:#344134;">Error(</span><span style="color:#6a8759;background-color:#344134;">'"endReadable()" called on non-empty stream'</span><span style="background-color:#344134;">)</span><span style="color:#cc7832;background-color:#344134;">;</span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;">Â  </span><span style="color:#cc7832;font-weight:bold;">if </span>(!state.endEmitted) {<br/>Â Â Â  state.ended = <span style="color:#cc7832;font-weight:bold;">true</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>process.nextTick(endReadableNT<span style="color:#cc7832;">, </span>state<span style="color:#cc7832;">, </span>stream)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â  </span>}<br/><span style="background-color:#344134;">}</span><br/><br/><span style="color:#cc7832;font-weight:bold;">function </span>endReadableNT(state<span style="color:#cc7832;">, </span>stream) {<br/>Â  <span style="color:#808080;">// Check that we didn't get one last unshift.<br/></span><span style="color:#808080;">Â  </span><span style="color:#cc7832;font-weight:bold;">if </span>(!state.endEmitted &amp;&amp; state.length === <span style="color:#6897bb;">0</span>) {<br/>Â Â Â  state.endEmitted = <span style="color:#cc7832;font-weight:bold;">true</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>stream.readable = <span style="color:#cc7832;font-weight:bold;">false</span><span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>stream.emit(<span style="color:#6a8759;">'end'</span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â  </span>}<br/>}
</pre>å¦‚ä¸Šä»£ç ï¼Œæœ€ç»ˆåœ¨ process.nextTick ä¸­è°ƒç”¨ endReadableNT å‡½æ•°æ¥ç»“æŸæœ€åçš„ Readable Stream æ‰§è¡Œã€‚</div><div><br/></div><div>å…·ä½“å…³äºï¼Œfs.createReadStream ä¸­ readable.push çš„ç»†èŠ‚ç‚¹ï¼Œè§ä¸‹èŠ‚åˆ†æã€‚</div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šFri Jan 06 2017 00:16:11 GMT+0800 (CST)</p>
</div></body></html>