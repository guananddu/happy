<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2016-12-26 08:10:45 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-27 16:53:44 +0000"/><title>buffer æ¨¡å—æ·±ç©¶ - 3 - Buffer.allocUnsafe &amp; Buffer.from</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>buffer æ¨¡å—æ·±ç©¶ - 3 - Buffer.allocUnsafe &amp; Buffer.from</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>å‰ä¸¤èŠ‚ä¸»è¦åˆ†æ buffer æ¨¡å—çš„åŠ è½½æ—¶æœºï¼Œä»¥åŠ Buffer.alloc å‡½æ•°çš„å†…éƒ¨è°ƒç”¨é€»è¾‘ï¼Œæœ¬èŠ‚ä¸»è¦æ¥åˆ†æ Buffer.allocUnsafe å‡½æ•°ï¼Œå…ˆæ¥ä¸€äº›æ€»ç»“ä¿¡æ¯ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Calling Buffer.alloc() can be significantly slower than the alternative Buffer.allocUnsafe() but ensures that the newly created Buffer instance contents will never contain sensitive data.The underlying memory for Buffer instances created(Buffer.allocUnsafe) in this way is not initialized. The contents of the newly created Buffer are unknown and may contain sensitive data. Use Buffer.alloc() instead to initialize Buffer instances to zeroes.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Note that the Buffer module pre-allocates an internal Buffer instance of size Buffer.poolSize that is used as a pool for the fast allocation of new Buffer instances created using Buffer.allocUnsafe() and the deprecated new Buffer(size) constructor only <u>when size is less than or equal to Buffer.poolSize &gt;&gt; 1 (floor of Buffer.poolSize divided by two)</u>.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Use of this pre-allocated internal memory pool is <u>a key difference</u> between calling Buffer.alloc(size, fill) vs. Buffer.allocUnsafe(size).fill(fill). Specifically, Buffer.alloc(size, fill) will never use the internal Buffer pool, while Buffer.allocUnsafe(size).fill(fill) will use the internal Buffer pool if size is less than or equal to half Buffer.poolSize. The difference is subtle but can be important when an application requires the additional performance that Buffer.allocUnsafe() provides.</font><br/></div></div><div><br/></div><div>æ³¨æ„ä¸Šé¢åŠ ä¸‹åˆ’çº¿çš„è¯­å¥ã€‚æ¥çœ‹ä¸‹é¢çš„æµ‹è¯•ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// Creates an uninitialized buffer of length 20.<br/></span><span style="color:#808080;">// This is faster than calling Buffer.alloc() but the returned<br/></span><span style="color:#808080;">// Buffer instance might contain old data that needs to be<br/></span><span style="color:#808080;">// overwritten using either fill() or write().<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>buf3 = Buffer.<span style="color:#ffc66d;">allocUnsafe</span>( <span style="color:#6897bb;">20 </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">'buf3: '</span><span style="color:#cc7832;">, </span>buf3 )<span style="color:#cc7832;">;</span>
</pre></div><div>æœ€ç»ˆï¼ŒBuffer.allocUnsafe å‡½æ•°è¿›å…¥ buffer å†…éƒ¨ç§æœ‰å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function allocate(size) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // size == 20</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (size &lt;= 0) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return new FastBuffer();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Buffer.poolSize == 8 * 1024 == 8192</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // å³ç§»ä¸€ä½ç›¸å½“äº Buffer.poolSize / 2 æ“ä½œã€æ­¤èŠ‚å¼€å§‹éƒ¨åˆ†çš„æ–‡å­—æœ‰è¯´æ˜ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // å…³äºâ€œæ— ç¬¦å·å³ç§»è¿ç®—ç¬¦â€ï¼šhttps://msdn.microsoft.com/zh-cn/library/x0ax6803(VS.80).aspx</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // å¦‚æœæ­¤æ¬¡æ–°ç”³è¯·çš„ç©ºé—´å¤§å°å°äº Buffer.poolSize çš„ä¸€åŠï¼Œåˆ™ä¸éœ€è¦å†æ¬¡è°ƒç”¨ createUnsafeBuffer</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (size &lt; (Buffer.poolSize &gt;&gt;&gt; 1)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // å¦‚æœæ­¤æ¬¡æ–°ç”³è¯·çš„ç©ºé—´å¤§å°å¤§äºç›®å‰ pool çš„å‰©ä½™ç©ºé—´å¤§å°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (size &gt; (poolSize - poolOffset))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // åˆ™éœ€è¦æ–°åˆ›å»º poolã€è§ä¸‹ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â createPool();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // å¦‚æœä¸éœ€è¦æ–°å»º pool åˆ™è°ƒç”¨ slice æ¥â€œåˆ‡åˆ†å‡ºâ€å¯ç”¨åŒºåŸŸ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // slice åˆ†æè§ä¸‹: poolOffset == 1392 | poolOffset + size == 1392 + 20 == 1412</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â var b = allocPool.slice(poolOffset, poolOffset + size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // å…¨å±€åç§»é‡è®°å½•æ›´æ–°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â poolOffset += size;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // alignPool ä¿è¯åç§»é‡å§‹ç»ˆæ˜¯ 8 çš„å€æ•°ã€è§ä¸‹åˆ†æã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â alignPool();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return b; // æœ€ç»ˆè¿”å›æ–°çš„ Buffer å®ä¾‹</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // Even though this is checked above, the conditional is a safety net and</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // sanity check to prevent any subsequent typed array allocation from not</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // being zero filled.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return createUnsafeBuffer(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// createPool çš„è°ƒç”¨æ¯”è¾ƒç®€å•</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function createPool() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // poolSize è®°å½•ç›®å‰å¯ç”¨çš„ç©ºé—´å¤§å°ï¼Œå› ä¸ºæ˜¯æ–°åˆ›å»ºï¼Œæ‰€ä»¥ä¸ºæœ€å¤§å€¼</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â poolSize = Buffer.poolSize;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // åˆ›å»º FastBufferï¼ˆBufferï¼‰ å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”æŠŠâ€œæŒ‡é’ˆâ€èµ‹äºˆ allocPool</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â allocPool = createUnsafeBuffer(poolSize);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // æ¢å¤ç›®å‰çš„â€œèµ‹å€¼â€ pool çš„åç§»é‡ä¸º 0</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â poolOffset = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// è¿™ä¸ª slice å‡½æ•°å¾ˆé‡è¦</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Buffer.prototype.slice = function slice(start, end) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // this.length == 8192 ã€æ€»ç©ºé—´å¤§å°ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // start == 1392 ã€ç”³è¯·ä¹‹å‰çš„åç§»é‡ã€‘| end == 1412</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const srcLength = this.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â start = adjustOffset(start, srcLength);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â end = end !== undefined ? adjustOffset(end, srcLength) : srcLength;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ä»¥ä¸Š start,end éƒ½ä¼šåšä¸€ä¸‹ offset é€‚é…</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const newLength = end &gt; start ? end - start : 0; // 20</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // âœ¨âœ¨</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // this.buffer è¿”å›å½“å‰çš„ allocPool Buffer å®ä¾‹å¯¹è±¡çš„ ArrayBuffer æœ¬ä½“</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // this.byteOffset === 0 å› ä¸ºæ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ allocPool è‚¯å®šæ˜¯å…¨éƒ¨æš´éœ²å‡ºæ¥çš„</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ä½†æ˜¯è¿™ä¸ªæ–°åˆ›å»ºçš„ FastBufferï¼ˆBufferï¼‰å®ä¾‹å¯¹è±¡ï¼Œåˆ™æ˜¯ä¸ºè€çš„ allocPool å¯¹è±¡æ–°å¼€äº†ä¸€æ‰‡çª—å£</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // æ‰€ä»¥è¯´ï¼Œæ­¤æ–°åˆ›å»ºçš„ FastBuffer å®ä¾‹å¯¹è±¡å’Œç›®å‰çš„å…¨å±€ allocPool Bufferå¯¹è±¡æ˜¯å…±äº«å†…å­˜çš„</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ä½†æ˜¯å¯¹ç”¨æˆ·æ¥è¯´ï¼Œè¿™ä¸ª FastBuffer æ˜¯ä¸€ä¸ªâ€œæ–°çš„â€ Buffer å®ä¾‹</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return new FastBuffer(this.buffer, this.byteOffset + start, newLength);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// æ­¤å‡½æ•°ä¸»è¦æ˜¯åš offset å‚æ•°çš„é€‚é…</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function adjustOffset(offset, length) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â offset = +offset;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ç­‰äº 0 æˆ–è€…ä¸ä¸ºæ•°å­—çš„æƒ…å†µ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (offset === 0 || Number.isNaN(offset)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ä¸ºè´Ÿæ•°çš„æƒ…å†µ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (offset &lt; 0) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â offset += length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return offset &gt; 0 ? offset : 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // æ­£å¸¸æƒ…å†µ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return offset &lt; length ? offset : length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function alignPool() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Ensure aligned slices</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // å¦‚æœä¸èƒ½æ•´é™¤ 8 </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (poolOffset &amp; 0x7) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // åˆ™åŠ ä¸Šä½™æ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â poolOffset |= 0x7;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // å†è¡¥ 1 å³å¯</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â poolOffset++;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><br/><br/></div></div><div><br/></div><div>ä¸Šé¢æ•´ä¸ªä»£ç å—ï¼Œåˆ™æ˜¯ Buffer.allocUnsafe çš„è°ƒç”¨åˆ†æã€‚å¯çŸ¥å…¶å†…å­˜åˆ†é…ç»†èŠ‚ï¼šå¦‚æœç”³è¯·å¤§äº Buffer.poolSize / 2 å¤§å° Buffer å®ä¾‹ï¼Œåˆ™ä¼šç›´æ¥é€šè¿‡åˆ›å»ºæ–°çš„ä¸€æ•´ä¸ªçš„ FastBuffer å®ä¾‹æ¥å®ç°ï¼›å¦‚æœç”³è¯·çš„ Buffer å®ä¾‹å¤§å°å°äº Buffer.poolSize / 2 çš„çš„å¤§å°ï¼Œåˆ™é€šè¿‡ä»¥ Buffer[ Buffer.poolSize ] ä¸ºå•ä½çš„ä¸€å—ä¸€å—å†…å­˜åŒºåŸŸæ¥å®ç°å†…å­˜åŠ¨æ€åˆ†é…ã€‚</div><div><br/></div><div><hr/></div><div><br/></div><div>å…³äº Buffer.from å‡½æ•°åˆ†æï¼Œé¦–å…ˆçœ‹æµ‹è¯•ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// Creates a Buffer containing [0x1, 0x2, 0x3].<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>buf4 = Buffer.<span style="color:#ffc66d;">from</span>( [ <span style="color:#6897bb;">1</span><span style="color:#cc7832;">, </span><span style="color:#6897bb;">2</span><span style="color:#cc7832;">, </span><span style="color:#6897bb;">3 </span>] )<span style="color:#cc7832;">;<br/></span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">'buf4: '</span><span style="color:#cc7832;">, </span>buf4 )<span style="color:#cc7832;">;</span>
</pre>ä¼ å…¥ä¸€ä¸ªçœŸå®çš„æ•°ç»„ç±»å‹ï¼Œå†ç»è¿‡ Buffer.from å‡½æ•°çš„å±‚å±‚åˆ¤æ–­è¿‡åï¼Œæœ€ç»ˆè¿›å…¥å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function fromArrayLike(obj) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ä¼ å…¥çš„ obj å³ä¸ºåŸæ•°ç»„</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const length = obj.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // æ­¤ allocate å‡½æ•°ï¼Œæœ¬èŠ‚å‰åŠéƒ¨åˆ†å·²ç»åˆ†æè¿‡ï¼Œè¯´æ˜å‚æ•°ä¸ºæ•°ç»„çš„æƒ…å†µä¸‹ï¼Œä»æ—§é‡‡ç”¨ allocPool æœºåˆ¶æ¥å®ç°å†…å­˜åˆ†é…</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Uint8Array[3]</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const b = allocate(length);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â for (var i = 0; i &lt; length; i++)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // ç®€å•èµ‹å€¼ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ¸…æ¥šçš„æ˜¯ b[ i ] çš„å€¼åœ¨ 8 ä½ä¹‹ä¸‹ï¼ˆåŒ…æ‹¬ï¼‰ã€å³ 255 ä¹‹ä¸‹ï¼ˆåŒ…æ‹¬ï¼‰ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â b[i] = obj[i];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return b;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; var arr = [260, 1]</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">undefined</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; Buffer.from(arr)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&lt;Buffer 04 01&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; var arr = [256, 1]</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">undefined</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; Buffer.from(arr)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&lt;Buffer 00 01&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; var bb = Buffer.from( arr )</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">undefined</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; bb[ 0 ]</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">0</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; var arr = [255, 1]</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">undefined</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&gt; Buffer.from(arr)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">&lt;Buffer ff 01&gt;</font></div><div><br/><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>ğŸŒŸå†æ¥çœ‹ Buffer.from( String strÂ ) çš„è°ƒç”¨ï¼Œå¦‚ä¸‹æµ‹è¯•ä»£ç ï¼Œä¼ å…¥çš„æ˜¯åŠè§’å­—ç¬¦ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// Creates a Buffer containing ASCII bytes.<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>buf5 = Buffer.<span style="color:#ffc66d;">from</span>( <span style="color:#6a8759;">'i am a buffer test!i am a buffer test!' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">'buf5: '</span><span style="color:#cc7832;">, </span>buf5 )<span style="color:#cc7832;">;</span>
</pre></div><div>æœ€ç»ˆç»è¿‡ç±»å‹åˆ¤æ–­ï¼Œè¿›å…¥å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function fromString(string, encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // encoding ä¸º undefined</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (typeof encoding !== 'string' || encoding === '')</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â encoding = 'utf8';</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // åˆ¤æ–­ç¼–ç å­—ç¬¦ä¸²æ˜¯å¦æ­£ç¡®</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!Buffer.isEncoding(encoding))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â throw new TypeError('"encoding" must be a valid string encoding');</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (string.length === 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return new FastBuffer();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // é€šè¿‡ encoding çš„ä¸åŒæ¥è®¡ç®— string çš„å­—èŠ‚å¤§å°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // è§ä¸‹ä»æ—§æ˜¯ 38</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var length = byteLength(string, encoding);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (length &gt;= (Buffer.poolSize &gt;&gt;&gt; 1))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return binding.createFromString(string, encoding);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (length &gt; (poolSize - poolOffset))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â createPool();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var actual = allocPool.write(string, poolOffset, encoding);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var b = allocPool.slice(poolOffset, poolOffset + actual);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â poolOffset += actual;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â alignPool();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return b;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function byteLength(string, encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // å­—ç¬¦ä¸ªæ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var len = string.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (len === 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return 0;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Use a for loop to avoid recursion</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ä¸åŒçš„ç¼–ç ï¼Œä¸åŒçš„å­—èŠ‚é•¿è®¡ç®—ç±»å‹</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var loweredCase = false;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â for (;;) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â switch (encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // å•å­—èŠ‚ç¼–ç </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'ascii':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'latin1':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'binary':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â return len;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // å¤šå­—èŠ‚ç¼–ç </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'utf8':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'utf-8':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case undefined:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â // ç›´æ¥è°ƒç”¨äº† c++ å±‚æ¬¡çš„ apiï¼Œåº•å±‚è°ƒç”¨ V8 apiã€ä¸å»æ·±ç©¶äº†ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â return binding.byteLengthUtf8(string);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // åŒå­—èŠ‚ç¼–ç </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'ucs2':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'ucs-2':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'utf16le':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'utf-16le':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â return len * 2;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // 16 è¿›åˆ¶çš„è¯åˆ™éœ€è¦é™¤ 2</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'hex':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â return len &gt;&gt;&gt; 1;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // base64 ç¼–ç é•¿åº¦è®¡ç®—</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â case 'base64':</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â return base64ByteLength(string, len);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â default:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â // The C++ binding defaulted to UTF8, we should too.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â if (loweredCase)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â return binding.byteLengthUtf8(string);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â // å¦‚æœå†™å¾—å¤§å†™å­—æ¯</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â encoding = ('' + encoding).toLowerCase();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â loweredCase = true;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><br/><br/></div></div><div><br/></div><div>æœªå®Œå¾…ç»­</div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šWed Dec 28 2016 00:56:24 GMT+0800 (CST)</p>
</div></body></html>