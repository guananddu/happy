<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2016-11-14 05:29:02 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-01 09:19:22 +0000"/><title>timer ç›¸å…³å‡½æ•°ç»†èŠ‚è§£æ - setInterval - 2</title></head><body><style>
    a { color: #43B0D6 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>timer ç›¸å…³å‡½æ•°ç»†èŠ‚è§£æ - setInterval - 2</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>æ€»ç»“ä¸Šä¸€èŠ‚çš„åˆ†æï¼šä»jså±‚çº§è°ƒç”¨ä¸€æ¬¡setIntervalï¼Œä¼šåˆ›å»ºä¸€ä¸ªTimeoutå¯¹è±¡ï¼Œæ ¹æ®Timeoutå¯¹è±¡çš„idleTimeçš„ä¸åŒï¼Œåˆ›å»ºä¸åŒçš„TimersListï¼ŒTimersListåŒæ ·ä¹Ÿä¼šæ”¾å…¥ä¸€ä¸ªä»¥idleTimeä¸ºkeyçš„mapä¸­å»ï¼ˆjså±‚çº§ï¼‰ï¼›åœ¨åˆ›å»ºjså±‚çº§çš„Timerslistæ—¶ï¼Œä¼šåŒæ ·åˆ›å»ºä¸€ä¸ªç”±c++åº•å±‚æ¥å®ç°çš„Timerå¯¹è±¡ï¼Œå¹¶ä¸”TimersListçš„_timeræŒ‡é’ˆæŒ‡å‘å…¶Timerå¯¹è±¡ï¼›</div><div>åœ¨åˆ›å»ºTimerå¯¹è±¡çš„æ—¶å€™ï¼Œåº•å±‚Timerå¯¹è±¡ä¼šæœ‰è‡ªå·±çš„timer_handleå±æ€§ï¼Œå¹¶ä¸”é€šè¿‡æ­¤å±æ€§ï¼Œloop-&gt;handle_queueå¾—ä»¥å°†Timerå¯¹è±¡çš„timer_handleä½œä¸ºèŠ‚ç‚¹æ’å…¥è‡ªèº«ï¼ˆæœ€åçš„ä½ç½®ï¼‰ï¼›</div><div>æœ€ç»ˆè°ƒç”¨Timerçš„startå¯åŠ¨å®šæ—¶å™¨ï¼Œæ­¤æ­¥éª¤å°†Timerçš„timer_handleçš„heap_nodeå±æ€§ä½œä¸ºç²˜åˆç‚¹ï¼Œå°†è‡ªèº«çš„heap_nodeæ’å…¥åˆ°loop-&gt;timer_heapæœ€å°å®Œå…¨äºŒå‰å †ç»“æ„ä¸­å»ï¼Œå¹¶ä¸”æ¯æ’å…¥ä¸€æ¬¡èŠ‚ç‚¹ï¼Œéƒ½ä¼šè¿›è¡Œæ•°ç»“æ„çš„é¡ºåºè°ƒæ•´ï¼ˆçˆ¶å­èŠ‚ç‚¹æ¢ä½ï¼Œå¦‚æœéœ€è¦ï¼‰ï¼›</div><div>ä¸€ä¸‹å†…å®¹æ‘˜è‡ªä»£ç æ³¨é‡Šï¼Œæœ‰å…³timeræ¶æ„çš„è§£é‡Šï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// HOW and WHY the timers implementation works the way it does.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// Timers are crucial to Node.js. Internally, any TCP I/O connection creates a<br/></span><span style="color:#808080;">// timer so that we can time out of connections. Additionally, many user<br/></span><span style="color:#808080;">// user libraries and applications also use timers. As such there may be a<br/></span><span style="color:#808080;">// significantly large amount of timeouts scheduled at any given time.<br/></span><span style="color:#808080;">// Therefore, it is very important that the timers implementation is performant<br/></span><span style="color:#808080;">// and efficient.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// Note: It is suggested you first read though the lib/internal/linkedlist.js<br/></span><span style="color:#808080;">// linked list implementation, since timers depend on it extensively. It can be<br/></span><span style="color:#808080;">// somewhat counter-intuitive at first, as it is not actually a class. Instead,<br/></span><span style="color:#808080;">// it is a set of helpers that operate on an existing object.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// In order to be as performant as possible, the architecture and data<br/></span><span style="color:#808080;">// structures are designed so that they are optimized to handle the following<br/></span><span style="color:#808080;">// use cases as efficiently as possible:<br/></span><span style="color:#808080;"><br/></span><span style="color:#808080;">// - Adding a new timer. (insert)<br/></span><span style="color:#808080;">// - Removing an existing timer. (remove)<br/></span><span style="color:#808080;">// - Handling a timer timing out. (timeout)<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// Whenever possible, the implementation tries to make the complexity of these<br/></span><span style="color:#808080;">// operations as close to constant-time as possible.<br/></span><span style="color:#808080;">// (So that performance is not impacted by the number of scheduled timers.)<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// Object maps are kept which contain linked lists keyed by their duration in<br/></span><span style="color:#808080;">// milliseconds.<br/></span><span style="color:#808080;">// The linked lists within also have some meta-properties, one of which is a<br/></span><span style="color:#808080;">// TimerWrap C++ handle, which makes the call after the duration to process the<br/></span><span style="color:#808080;">// list it is attached to.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// â•”â•â•â•â• &gt; Object Map<br/></span><span style="color:#808080;">// â•‘<br/></span><span style="color:#808080;">// â• â•â•<br/></span><span style="color:#808080;">// â•‘ refedLists: { '40': { }, '320': { etc } } (keys of millisecond duration)<br/></span><span style="color:#808080;">// â•šâ•â•Â Â Â Â Â Â Â Â Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br/></span><span style="color:#808080;">//Â Â Â Â Â Â Â Â Â Â Â Â Â  â”‚<br/></span><span style="color:#808080;">// â•”â•â•Â Â Â Â Â Â Â Â Â  â”‚<br/></span><span style="color:#808080;">// â•‘ TimersList { _idleNext: { }, _idlePrev: (self), _timer: (TimerWrap) }<br/></span><span style="color:#808080;">// â•‘Â Â Â Â Â Â Â Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•”â•â•Â  â”‚Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ^<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•‘Â Â Â  { _idleNext: { },Â  _idlePrev: { }, _onTimeout: (callback) }<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•‘Â Â Â Â Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•‘Â Â Â Â Â  â”‚Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ^<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•‘Â Â Â Â Â  { _idleNext: { etc },Â  _idlePrev: { }, _onTimeout: (callback) }<br/></span><span style="color:#808080;">// â• â•â•Â  â• â•â•<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•‘<br/></span><span style="color:#808080;">// â•‘Â Â Â  â•šâ•â•â•â• &gt;Â  Actual JavaScript timeouts<br/></span><span style="color:#808080;">// â•‘<br/></span><span style="color:#808080;">// â•šâ•â•â•â• &gt; Linked List<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// With this, virtually constant-time insertion (append), removal, and timeout<br/></span><span style="color:#808080;">// is possible in the JavaScript layer. Any one list of timers is able to be<br/></span><span style="color:#808080;">// sorted by just appending to it because all timers within share the same<br/></span><span style="color:#808080;">// duration. Therefore, any timer added later will always have been scheduled to<br/></span><span style="color:#808080;">// timeout later, thus only needing to be appended.<br/></span><span style="color:#808080;">// Removal from an object-property linked list is also virtually constant-time<br/></span><span style="color:#808080;">// as can be seen in the lib/internal/linkedlist.js implementation.<br/></span><span style="color:#808080;">// Timeouts only need to process any timers due to currently timeout, which will<br/></span><span style="color:#808080;">// always be at the beginning of the list for reasons stated above. Any timers<br/></span><span style="color:#808080;">// after the first one encountered that does not yet need to timeout will also<br/></span><span style="color:#808080;">// always be due to timeout at a later time.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// Less-than constant time operations are thus contained in two places:<br/></span><span style="color:#808080;">// TimerWrap's backing libuv timers implementation (a performant heap-based<br/></span><span style="color:#808080;">// queue), and the object map lookup of a specific list by the duration of<br/></span><span style="color:#808080;">// timers within (or creation of a new list).<br/></span><span style="color:#808080;">// However, these operations combined have shown to be trivial in comparison to<br/></span><span style="color:#808080;">// other alternative timers architectures.<br/></span><span style="color:#808080;"><br/></span><span style="color:#808080;"><br/></span><span style="color:#808080;">// Object maps containing linked lists of timers, keyed and sorted by their<br/></span><span style="color:#808080;">// duration in milliseconds.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// The difference between these two objects is that the former contains timers<br/></span><span style="color:#808080;">// that will keep the process open if they are the only thing left, while the<br/></span><span style="color:#808080;">// latter will not.<br/></span><span style="color:#808080;">//<br/></span><span style="color:#808080;">// - key = time in milliseconds<br/></span><span style="color:#808080;">// - value = linked list<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>refedLists = {}<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>unrefedLists = {}<span style="color:#cc7832;">;</span></pre></div></div><div><br/></div><div><hr/>ç»§ç»­ä¸Šä¸€å±Šæœªå®Œçš„å†…å®¹ï¼Œä¸Šä¸€èŠ‚åˆ†æåˆ°äº†ï¼š</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">insert(), timers.js:138</font><br/></div><div><pre style="font-family: Menlo; background-color: rgb(43, 43, 43); color: rgb(169, 183, 198); font-size: 13.5pt;"><span style="background-color:#344134;">list</span>._timer.start(msecs)<span style="color:#cc7832;">;</span>
</pre><font face="Monaco">çš„ä½ç½®ï¼Œç»§ç»­å¾€ä¸‹</font></div><div><font face="Monaco">==</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// The underlying logic for scheduling or re-scheduling a timer.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// Appends a timer onto the end of an existing timers list, or creates a new</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// TimerWrap backed list if one does not already exist for the specified timeout</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// duration.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">function insert(item, unrefed) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â <span>Â  ...</span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // ä¸Šä¸€èŠ‚å·²ç»åˆ†æåˆ°æ­¤</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â list._timer.start(msecs);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  // å°†å½“å‰æ–°åˆ›å»ºçš„TimersListå¯¹è±¡ï¼Œæ”¾å…¥listsä¸­å»ï¼Œkeyå³ä¸ºdelayæ—¶é—´</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â lists[msecs] = list;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">const kOnTimeout = TimerWrap.kOnTimeout | 0;</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/2FCCD980-171E-42D7-91F0-49CDEF877D16.png" height="auto" width="100%"/><br/></span><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>Â  Â  // ç»™TimerWrapå®ä¾‹å¯¹è±¡æ·»åŠ c2jsçš„ç²˜åˆç‚¹ã€è®¾ç½®å›è°ƒå‡½æ•°ï¼ä¾¿äºc++ call jsã€‘</span><br/></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â list._timer[kOnTimeout] = listOnTimeout;//ã€ä¸€å®šè¦æ³¨æ„æ­¤å›è°ƒå‡½æ•°c2jsçš„é‡è¦è°ƒç”¨ç‚¹ã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  // ä»¥åº•å±‚TimerWrapå®ä¾‹å¯¹è±¡ä½œä¸ºé“¾è¡¨å¤´ï¼Œå°†jså±‚çº§åˆ›å»ºçš„Timeoutå¯¹è±¡æ’å…¥æ­¤é˜Ÿåˆ—ä¸­å»</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â L.append(list, item);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â assert(!L.isEmpty(list)); // list is not empty</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div><div><font face="Monaco"/></div><div><font face="Monaco">==</font></div><div><font face="Monaco">ğŸŒŸè‡ªæ­¤ exports.setInterval ä¸­çš„ active(timer) æ‰§è¡Œå®Œæ¯•ï¼</font></div><div><font face="Monaco">æ­¤å‡½æ•°ä»¥ Timeout å®ä¾‹å¯¹è±¡ä½œä¸ºè¿”å›å€¼ï¼Œè®¾ç½®intervalTimerçš„é€»è¾‘åˆ°æ­¤ä¸ºæ­¢ï¼</font></div><div><font face="Monaco">==</font></div></div><div><br/></div><div><hr/>ä»¥ä¸‹å†…å®¹å…³æ³¨å¦‚ä½•è§¦å‘timerçš„å›è°ƒï¼Œé¦–å…ˆçœ‹c++å±‚æ¬¡å¾—å›è°ƒï¼š</div><div><br/></div><div>ä»æ—§æ˜¯åœ¨ loop çš„ uv_run æ ¸å¿ƒå‡½æ•°ä¸­çš„ï¼šuv_run_timers ç¯èŠ‚æ¥è§¦å‘çš„ï¼š</div><div><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/5381AA46-3E3F-44F6-B19E-055C0E37B3EC.png" height="auto" width="100%"/><br/></div><div>è¿›å…¥ uv__run_timers(loop)ï¼š</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void uv__run_timers(uv_loop_t* loop) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â struct heap_node* heap_node;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â uv_timer_t* handle;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â for (;;) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // å–åˆ°heapçš„æ ¹èŠ‚ç‚¹</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â heap_node = heap_min((struct heap*) &amp;loop-&gt;timer_heap);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // å¦‚æœæ ¹èŠ‚ç‚¹ä¸ºç©ºåˆ™ç›´æ¥break</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (heap_node == NULL)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â break;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  Â  é€šè¿‡ handle çš„ heap_node æ¥æ‹¿åˆ°handle</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â handle = container_of(heap_node, uv_timer_t, heap_node);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  // å¦‚æœç¬¦åˆè¿™ä¸ªæ¡ä»¶çš„è¯ï¼Œåˆ™è¡¨ç¤ºæ­¤timerçš„delayæ—¶é—´è¿˜æœªåˆ°ï¼›åˆ™è·³å‡º</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (handle-&gt;timeout &gt; loop-&gt;time)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â break;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  Â  // å¦åˆ™å¼€å§‹æ‰§è¡Œå›è°ƒ</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span><span>Â  Â  // 1âƒ£ï¸ä»æœ€å°å®Œå…¨äºŒå‰å †ä¸­åˆ é™¤å½“å‰æ­£åœ¨å¤„ç†çš„heap_nodeèŠ‚ç‚¹ï¼ŒåŒæ—¶ä¿è¯ç»“æ„æ­£ç¡®</span><br/></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span><span><span>Â  Â  // 2âƒ£ï¸æ ‡è¯†å½“å‰handleçš„çŠ¶æ€ä¸ºæœªæ¿€æ´»çŠ¶æ€</span><br/></span></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â uv_timer_stop(handle);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // ä¸handle-&gt;repeatç›¸å…³çš„é€»è¾‘ï¼ä½†æ˜¯æœ‰ä¸ªç–‘é—®ï¼Œhandle-&gt;repeatåœ¨ä»€ä¹ˆæ—¶å€™ä¸º1å‘¢ï¼Ÿè²Œä¼¼ç°åœ¨è§åˆ°çš„éƒ½æ˜¯0</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â uv_timer_again(handle);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  // è°ƒç”¨å›è°ƒå‡½æ•°</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â handle-&gt;timer_cb(handle);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div><div><font face="Monaco">==</font></div><div><font face="Monaco">ğŸŒŸ æœ€ç»ˆè¿›å…¥c++å±‚çº§çš„å›è°ƒå‡½æ•°ï¼š</font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0Â Â Â Â Â 0x000000010008e36c in node::TimerWrap::OnTimeout(uv_timer_s*) at /Users/mrguan/work/build/node/node-6.6.0/src/timer_wrap.cc:91</font></font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â static void OnTimeout(uv_timer_t* handle) {</font></font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â TimerWrap* wrap = static_cast&lt;TimerWrap*&gt;(handle-&gt;data);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Environment* env = wrap-&gt;env();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â HandleScope handle_scope(env-&gt;isolate());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Context::Scope context_scope(env-&gt;context());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  // è¿™é‡Œå°±æ˜¯c++ 2 jsçš„ç¯èŠ‚ï¼›æ­¤å¥çš„æ‰§è¡Œï¼Œæœ€ç»ˆè°ƒç”¨äº†jså±‚çº§çš„list._timer[0]</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // js level:Â <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">list._timer[kOnTimeout] = listOnTimeout;</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  // list._timer å°±æ˜¯wrapã€å¯ä»¥è¿™æ ·ç†è§£ã€‘åŒæ—¶ï¼ŒlistOnTimeoutçš„è°ƒç”¨ä¸Šä¸‹æ–‡å³ä¸º _timer è‡ªå·±</font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  //Â <img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/DE1FC694-1645-4DFD-B2F9-7FE534D2DE5D.png" height="auto" width="100%"/><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â wrap-&gt;MakeCallback(kOnTimeout, 0, nullptr);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></font></div><div><font face="Monaco"/></div><div><font face="Monaco"/></div><div><font face="Monaco">==</font></div></div><div><br/></div><div>å¼€å§‹è¿›å…¥jså±‚çº§çš„å›è°ƒå‡½æ•°ï¼Œé¦–å…ˆæ¥çœ‹æ­¤æ—¶çš„è§¦å‘å›è°ƒï¼š</div><div><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/ABF09A2B-EE48-4D86-B38A-8B00B550018A.png" height="auto" width="100%"/><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">listOnTimeout(), timers.js:202</font><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">function listOnTimeout() {</font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // this å³ä¸º Timer å®ä¾‹å¯¹è±¡ this._list ä¸º TimersList å¯¹è±¡ã€jså±‚çº§çš„åŒå‘é“¾è¡¨ã€‘</span><br/></font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var list = this._list;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  // delay æ—¶é—´</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var msecs = list.msecs;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â debug('timeout callback %d', msecs);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  // å¾—åˆ°ç°åœ¨çš„CPUæ¯«ç§’æ•°</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var now = TimerWrap.now();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â debug('now: %d', now);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â var diff, timer;</font></div><div><font face="Monaco">Â  // peek å‡½æ•°è§ä¸‹ï¼Œå³è¿”å›â€œæœ€è€â€çš„èŠ‚ç‚¹</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â <img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/F80FCC55-4B38-4172-8042-A2C190DFA68A.png" height="auto" width="100%"/><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â while (timer = L.peek(list)) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â diff = now - timer._idleStart;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // Check if this loop iteration is too early for the next timer.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // This happens if there are more timers scheduled for later in the list.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // å¦‚æ³¨é‡Šæ‰€è¯´ï¼Œåœ¨listä¸­çš„timeoutèŠ‚ç‚¹è¿‡å¤šæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æ­¤ç§æƒ…å†µ</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (diff &lt; msecs) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â var timeRemaining = msecs - (TimerWrap.now() - timer._idleStart);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â if (timeRemaining &lt; 0) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â timeRemaining = 0;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // é‡æ–°æ¿€æ´»åº•å±‚timer</span></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â this.start(timeRemaining);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â debug('%d list wait because diff is %d', msecs, diff);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â return;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // The actual logic for when a timeout happens.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  Â  // å°†å½“å‰è¦å¤„ç†çš„timerèŠ‚ç‚¹ç§»é™¤é˜Ÿåˆ—</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â L.remove(timer);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â assert(timer !== L.peek(list));</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  Â Â </span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (!timer._onTimeout) continue;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  â€¦ domainç›¸å…³Â </font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  Â  // æ‰§è¡Œå›è°ƒ</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â tryOnTimeout(timer, list);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (domain)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â domain.exit();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // If `L.peek(list)` returned nothing, the list was either empty or we have</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // called all of the timer timeouts.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // As such, we can remove the list and clean up the TimerWrap C++ handle.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â debug('%d list empty', msecs);</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â assert(L.isEmpty(list));</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  // æ­¤å‡½æ•°æ‰§è¡Œï¼Œæœ€ç»ˆè°ƒå…¥ï¼š</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>Â  //Â <img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/6FEEA16D-6808-4FDC-BEBA-2034877AFE61.png" height="auto" width="100%"/><br/></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span><span>Â  //Â <img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/8048FA18-E619-42B8-A203-CD7BAED075E0.png" height="auto" width="100%"/><br/></span><br/></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"/><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â this.close();</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // Either refedLists[msecs] or unrefedLists[msecs] may have been removed and</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // recreated since the reference to `list` was created. Make sure they're</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â // the same instance of the list before destroying.</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (list._unrefed === true &amp;&amp; list === unrefedLists[msecs]) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â delete unrefedLists[msecs];</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â } else if (list === refedLists[msecs]) {</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â delete refedLists[msecs];</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font face="Monaco">==</font></div><div><font face="Monaco">ğŸŒŸ è¿›å…¥tryOnTimeoutå‡½æ•°ï¼š</font></div><div><font face="Monaco"><img src="timer%20%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E7%BB%86%E8%8A%82%E8%A7%A3%E6%9E%90%20-%20setInterval%20-%202.resources/C5AF59E4-AEAF-42D4-9278-F6BD7B76CEFA.png" height="auto" width="100%"/><br/></font></div><div><font face="Monaco">==</font></div><div><font face="Monaco">ğŸŒŸ è¿›å…¥ timer._onTimeout()ï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆå³ä¸ºå†…éƒ¨å‡½æ•°ï¼šwrapperï¼š<font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">wrapper(), timers.js:425</font></font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></font></div><div><font face="Monaco"/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  function wrapper() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  Â  // ğŸŒŸæ­¤_repeat() å³ä¸ºç”¨æˆ·å›è°ƒå‡½æ•°çš„åŒ…è£…å‡½æ•°ï¼ç”¨æˆ·é€»è¾‘åœ¨æ­¤è¢«è°ƒèµ·ğŸŒŸ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â timer._repeat();</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // Timer might be closed - no point in restarting it</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (!timer._repeat)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â return;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â // If timer is unref'd (or was - it's permanently removed from the list.)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â if (this._handle) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â this._handle.start(repeat);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // ä¸€èˆ¬çš„timeréƒ½èµ°è¿™ä¸ªåˆ†æ”¯</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>Â Â  Â <span>Â  // é‡æ–°è®¾ç½®delayæ—¶é—´</span></span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â timer._idleTimeout = repeat;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â Â  Â <span>Â  // é‡æ–°æ¿€æ´»timerï¼å› ä¸ºæ˜¯intervalè°ƒç”¨</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â active(timer);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font><br/></div><div><font face="Monaco"/></div><div><font face="Monaco">==</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"/></div></div><div><br/></div><div>æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šsetInterval çš„æ•´ä½“é€»è¾‘ï¼Œå½“æŸä¸€ä¸ªTimeoutèŠ‚ç‚¹è¢«å¤„ç†å®Œæˆä»¥åï¼Œå°±ä¼šä»jså±‚çº§çš„åŒå‘é“¾è¡¨ä¸­removeæ‰ï¼›è€Œåœ¨åº•å±‚çš„timer_heapï¼ˆæœ€å°å®Œå…¨äºŒå‰å †ï¼‰èŠ‚ç‚¹ä¸­æŸä¸€ä¸ªèŠ‚ç‚¹è¢«å¤„ç†å®Œæ¯•ï¼Œä¹Ÿä¼šä»æ ‘ä¸­removeæ‰ï¼›ä½†å½“æ‰§è¡Œå®Œä¸€æ¬¡ç”¨æˆ·å›è°ƒï¼ŒTimeoutèŠ‚ç‚¹ä¼šé‡æ–°è¢«æ’å…¥jså±‚çº§çš„åŒå‘é“¾è¡¨ä¸­ï¼Œå¹¶ä¸”é‡æ–°è°ƒç”¨_timer.start()åº•å±‚è°ƒç”¨ï¼Œå¾€äºŒå‰å †ä¸­æ’å…¥èŠ‚ç‚¹ï¼Œä¾¿äºuv__loop_timers() æ¥æ£€æŸ¥ï¼›</div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šThu Dec 22 2016 14:39:19 GMT+0800 (CST)</p>
</div></body></html>