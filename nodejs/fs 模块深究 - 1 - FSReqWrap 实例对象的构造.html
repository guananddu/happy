<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="altitude" content="56"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2017-01-13 07:49:44 +0000"/><meta name="latitude" content="39.97077903456425"/><meta name="longitude" content="116.3234090161813"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-02-09 07:43:57 +0000"/><title>fs æ¨¡å—æ·±ç©¶ - 1 - FSReqWrap å®ä¾‹å¯¹è±¡çš„æ„é€ </title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>fs æ¨¡å—æ·±ç©¶ - 1 - FSReqWrap å®ä¾‹å¯¹è±¡çš„æ„é€ </h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>ä»æœ¬èŠ‚å¼€å§‹å­¦ä¹  fs æ¨¡å—çš„å†…éƒ¨åŸç†ï¼Œå®˜æ–¹æ–‡æ¡£å¯¹ fs æ¨¡å—çš„å¼€å§‹æ¦‚è§ˆï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">File I/O is provided by simple wrappers around standard POSIX functions. To use this module do require('fs'). All the methods have asynchronous and synchronous forms.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The asynchronous form always takes a completion callback as its last argument. The arguments passed to the completion callback depend on the method, but the first argument is always reserved for an exception. If the operation was completed successfully, then the first argument will be null or undefined.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">When using the synchronous form any exceptions are immediately thrown. You can use try/catch to handle exceptions or allow them to bubble up.</font><br/></div></div><div><br/></div><div>æ¥çœ‹è°ƒè¯•ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">const </span>fs = require( <span style="color:#6a8759;">'fs' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>path = require( <span style="color:#6a8759;">'path' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;font-weight:bold;">const </span>file = path.<span style="color:#ffc66d;">resolve</span>( __dirname<span style="color:#cc7832;">, </span><span style="color:#6a8759;">'myfile.txt' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span>fs.access( file<span style="color:#cc7832;">, </span>fs.<span style="color:#9876aa;">constants</span>.R_OK | fs.<span style="color:#9876aa;">constants</span>.W_OK<span style="color:#cc7832;">, </span>( err ) =&gt; {<br/>Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( err ? <span style="color:#6a8759;">'no access!' </span>: <span style="color:#6a8759;">'can read/write' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span><span style="color:#ffc66d;">readFile</span>( file )<span style="color:#cc7832;">;<br/></span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;"><br/></span><span style="color:#cc7832;font-weight:bold;">function </span><span style="color:#ffc66d;">readFile</span>( file ) {<br/>Â Â Â  fs.<span style="color:#ffc66d;">readFile</span>( file<span style="color:#cc7832;">, </span>( err<span style="color:#cc7832;">, </span>data ) =&gt; {<br/>Â Â Â Â Â Â Â  <span style="color:#cc7832;font-weight:bold;">if </span>( err ) <span style="color:#cc7832;font-weight:bold;">throw </span>err<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â Â Â Â Â  </span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">`</span>${data.<span style="color:#ffc66d;">toString</span>().<span style="color:#ffc66d;">substring</span>( <span style="color:#6897bb;">0</span><span style="color:#cc7832;">, </span><span style="color:#6897bb;">20 </span>)}<span style="color:#6a8759;">....` </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â Â Â Â Â  </span><span style="color:#ffc66d;">appendFile</span>( file )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>} )<span style="color:#cc7832;">;<br/></span>}<br/><br/><span style="color:#cc7832;font-weight:bold;">function </span><span style="color:#ffc66d;">appendFile</span>( file ) {<br/>Â Â Â  fs.<span style="color:#ffc66d;">appendFile</span>( file<span style="color:#cc7832;">, </span><span style="color:#6a8759;">`</span><span style="color:#cc7832;">\n</span><span style="color:#6a8759;">data to append: </span>${<span style="color:#cc7832;font-weight:bold;">new </span>Date().<span style="color:#ffc66d;">getTime</span>()}<span style="color:#6a8759;">`</span><span style="color:#cc7832;">, </span>( err ) =&gt; {<br/>Â Â Â Â Â Â Â  <span style="color:#cc7832;font-weight:bold;">if </span>( err ) <span style="color:#cc7832;font-weight:bold;">throw </span>err<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â Â Â Â Â  </span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">'The "data to append" was appended to file!' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>} )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>fs.<span style="color:#9876aa;">stat</span>( file<span style="color:#cc7832;">, </span>( err<span style="color:#cc7832;">, </span>stats ) =&gt; {<br/>Â Â Â Â Â Â Â  <span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( err<span style="color:#cc7832;">, </span><span style="color:#9876aa;">JSON</span>.<span style="color:#ffc66d;">stringify</span>( stats ) )<span style="color:#cc7832;">;<br/></span><span style="color:#cc7832;">Â Â Â  </span>} )<span style="color:#cc7832;">;<br/></span>}
</pre></div><div>ä» fs.access/fs.readFile/fs.appendFile/fs.stat è¿™å‡ ä¸ªå‡½æ•°ï¼Œæ¥äº†è§£ fs çš„å†…éƒ¨åŸç†ã€‚nodejs çš„ event loop åŸºäº libuvï¼Œæ ¹æ®ä¹‹å‰å¯¹ libuv çš„åˆæ­¥ä»‹ç»ï¼Œlibuv åœ¨åº•å±‚å®ç° File I/O é‡‡ç”¨äº†çº¿ç¨‹æ± çš„æœºåˆ¶ï¼š<a href="http://docs.libuv.org/en/v1.x/design.html">http://docs.libuv.org/en/v1.x/design.html</a>ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);">Unlike network I/O, there are no platform-specific file I/O primitives libuv could rely on, so the current approach is to run blocking file I/O operations in a thread pool.</font></div><div style="color: rgb(51, 51, 51);"><br/></div><div style="color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);">For a thorough explanation of the cross-platform file I/O landscape, checkout this post(<a href="http://blog.libtorrent.org/2012/10/asynchronous-disk-io/"><font style="font-size: 12px; color: rgb(51, 51, 51);">http://blog.libtorrent.org/2012/10/asynchronous-disk-io/</font></a>).</font></div><div style="color: rgb(51, 51, 51);"><br/></div><div><font style="color: rgb(51, 51, 51); font-size: 12px;">libuv currently uses </font><font style="font-size: 12px;" color="#ff2600">a global thread pool</font><font style="color: rgb(51, 51, 51); font-size: 12px;"> on which all loops can queue work on. 3 types of operations are currently run on this pool:</font></div><div style="color: rgb(51, 51, 51);"><br/></div><div><font style="font-size: 12px;" color="#0433ff">Filesystem operations</font></div><div><font style="font-size: 12px;" color="#0433ff">DNS functions (getaddrinfo and getnameinfo)</font></div><div><font style="font-size: 12px;" color="#0433ff">User specified code via uv_queue_work()</font><br/></div></div><div><br/></div><div/><div>æ¢ç©¶ä¾‹å­ä»£ç ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸€ä¸ªæ¥è‡ªå®˜ç½‘ç»†èŠ‚ï¼Œä»¥ä¸Šçš„æµ‹è¯•ä»£ç ä¸æ˜¯æœ€ä¼˜çš„ï¼Œä»…ä»…ç”¨æ¥ä½œä¸ºåˆ‡å…¥ç‚¹ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><font style="color: rgb(51, 51, 51); font-size: 12px;">Using fs.access() to check for the accessibility of a file before calling fs.open(), fs.readFile() or fs.writeFile() is </font><font style="font-size: 12px;" color="#ff2600">not recommended</font><font style="color: rgb(51, 51, 51); font-size: 12px;">. Doing so introduces a race condition, since other processes may change the file's state between the two calls. Instead, user code should open/read/write the file directly and handle the error raised if the file is not accessible.</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>æ¥çœ‹è¿›å…¥ fs.access çš„è¿‡ç¨‹ï¼Œé»˜è®¤çš„æµ‹è¯•ä»£ç è°ƒç”¨éƒ½æ˜¯å¼‚æ­¥æ¨¡å¼ï¼Œä½†æ˜¯åŒæ­¥æ¨¡å¼ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œé‡ç‚¹åˆ†æå¼‚æ­¥æ¨¡å¼ï¼Œæœ€ç»ˆè¿›å…¥ fs.js æ¨¡å—ä¸­çš„ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// é»˜è®¤çš„å¼‚æ­¥å‡½æ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">fs.access = function(path, mode, callback) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â . . . // å›è°ƒå‡½æ•°ç±»å‹åˆ¤æ–­ï¼é»˜è®¤æ¨¡å¼å¤„ç†</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â mode = mode | 0; // è½¬æ•´</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â var req = new FSReqWrap(); // åˆ›å»ºè¯·æ±‚å¯¹è±¡</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â req.oncomplete = makeCallback(callback); // è®¾ç½®è¯·æ±‚å¯¹è±¡çš„ oncomplete å›è°ƒå±æ€§</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // è°ƒç”¨åº•å±‚ access æ–¹æ³•ï¼Œæ³¨æ„æ˜¯ä¸‰ä¸ªå‚æ•°ï¼špath, mode, req</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â binding.access(pathModule._makeLong(path), mode, req); </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font></div><div><br/></div><div>// åŒæ­¥å‡½æ•°</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">fs.accessSync = function(path, mode) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â . . . // å›è°ƒå‡½æ•°ç±»å‹åˆ¤æ–­ï¼é»˜è®¤æ¨¡å¼å¤„ç†</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // ç›´æ¥é‡‡ç”¨ path, mode ä¸¤ä¸ªå‚æ•°è°ƒç”¨ binding.access å‡½æ•°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â binding.access(pathModule._makeLong(path), mode);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>ä¸Šè¿°ä»£ç ä¸­çš„ FSReqWrap å¯¹è±¡å³ä¸ºï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">const binding = process.binding('fs');</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">. . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">const FSReqWrap = binding.FSReqWrap;</font><br/></div></div><div><br/></div><div>FSReqWrap æ˜¯ä¸€ä¸ªæ˜ å°„åˆ° c++ å±‚æ¬¡çš„æ„é€ å‡½æ•°ï¼Œåœ¨ c++ å±‚æ¬¡çš„ fs æ¨¡å—ä¸­è¢«å®šä¹‰ï¼Œåœ¨ node/Source/src/node_file.cc æºç æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº† binding.fs å¯¹è±¡çš„å„ä¸ªå±æ€§å’Œæ–¹æ³•ï¼Œå…¶ä¸­å¯¹ FSReqWrap æ„é€ å‡½æ•°çš„å®šä¹‰æ˜¯ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>. . . // line 1490</div><div><span>Â  // ä¸‹é¢æ˜¯é€šç”¨çš„ï¼Œå¯¹ js å±‚çº§å¯¹è±¡æš´éœ² c++ ç±»æ„é€ å‡½æ•°çš„åˆå§‹åŒ–æ–¹æ³•</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Create FunctionTemplate for FSReqWrap åˆ›å»ºæ„é€ å‡½æ•°æ¨¡æ¿ï¼ŒæŒ‡å‘Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">NewFSReqWrap c++ å‡½æ•°</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Local&lt;FunctionTemplate&gt; fst =</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â FunctionTemplate::New(env-&gt;isolate(), NewFSReqWrap);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â fst-&gt;InstanceTemplate()-&gt;SetInternalFieldCount(1); // è®¾ç½® internal æŒ‡é’ˆå­—æ®µæ•°é‡ã€ä¸ v8 è°ƒç”¨ä¸­çš„ Wrap å‡½æ•°ç›¸å…³ï¼Œè§åç»­åˆ†æã€‘</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â fst-&gt;SetClassName(FIXED_ONE_BYTE_STRING(env-&gt;isolate(), "FSReqWrap")); // ç±»åç§°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â target-&gt;Set(FIXED_ONE_BYTE_STRING(env-&gt;isolate(), "FSReqWrap"),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â fst-&gt;GetFunction()); // ç»™ target ï¼ˆå³ fs å¯¹è±¡ï¼‰æš´éœ²å‡º FSReqWrap æ„é€ å‡½æ•°ï¼Œä»¥ä¾¿ binding.<font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">FSReqWrap è®¿é—®</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>åœ¨åé¢çš„å„ä¸ª fs ç›¸å…³å‡½æ•°çš„å¼‚æ­¥è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šå‡ºç° FSReqWrap å¯¹è±¡çš„èº«å½±ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">var req = new FSReqWrap(); // åˆ›å»ºè¯·æ±‚å¯¹è±¡</font><br/></div></div><div><br/></div><div>åœ¨ä¸Šè¿° js ä»£ç æ‰§è¡Œæ—¶ï¼Œå¯¹åº”çš„ c++ å±‚æ¬¡çš„å‡½æ•°è¢«æ‰§è¡Œï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">static void NewFSReqWrap(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK(args.IsConstructCall()); // æ­¤å‡½æ•°å¹¶æ²¡æœ‰å¤ªå¤šé™„å±çš„åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ£€æŸ¥åªç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯é€šè¿‡ new æ¥åˆå§‹åŒ– FSReqWrap å®ä¾‹å¯¹è±¡</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>å½“ js å±‚çº§çš„ fs.access ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä¸º req(FSReqWrap å®ä¾‹å¯¹è±¡) è®¾ç½®äº† oncomplete å±æ€§ï¼Œæœ€ç»ˆè°ƒç”¨è¿›å…¥ binding.access åº•å±‚å‡½æ•°ï¼Œæ¥çœ‹ä¸‹æ­¤æ—¶çš„è¿è¡Œæˆªå›¾ï¼š</div><div><br/></div><div><img src="fs%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201%20-%20FSReqWrap%20%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9E%84%E9%80%A0.resources/96F862EA-87CA-432D-ACEF-CAF68D1E6DC5.png" height="auto" width="100%"/><br/></div><div><br/></div><div><hr/></div><div><br/></div><div>å…³äº binding.access åº•å±‚å‡½æ•°çš„è°ƒç”¨ï¼Œé¦–å…ˆæ³¨æ„ä¼ å…¥å…¶çš„ä¸‰ä¸ªå‚æ•°ï¼špathï¼modeï¼reqï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">static void Access(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . . // env åŠ scope åˆå§‹åŒ–</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . . // å‚æ•°ç±»å‹åˆ¤æ–­</font></div><div><br/></div><div><span>Â Â <font style="font-size: 12px; color: rgb(51, 51, 51);">// Slightly different take on Utf8Value. If value is a String,</font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // it will return a Utf8 encoded string. If value is a Buffer,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // it will copy the data out of the Buffer as is.</font><span/><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â BufferValue path(env-&gt;isolate(), args[0]);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â <font style="font-size: 12px; color: rgb(51, 51, 51);">ASSERT_PATH(path) // åˆ¤æ–­ path æ˜¯å¦åˆæ³•ï¼Œç»å¸¸ä¼šç”¨åˆ°ï¼š</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  [[ å…¶å®šä¹‰è§ï¼š</span></font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â Â <font style="font-size: 12px; color: rgb(51, 51, 51);">#define ASSERT_PATH(path)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></span></span></font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  Â  if (*path == nullptr) Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  Â  Â  Â return TYPE_ERROR( #path " must be a string or Buffer");</font><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span/><br/></span></font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â Â </span>]]</span><br/></font></font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â int mode = static_cast&lt;int&gt;(args[1]-&gt;Int32Value()); //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">modeÂ Â Â Â Â intÂ Â Â Â Â 6</font></font></div><div><span>Â  // é€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å¦ä¼ å…¥ä¸”æ˜¯å¦ä¸º Object æ¥ç¡®å®šå¼‚æ­¥æˆ–è€…åŒæ­¥æ¨¡å¼</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (args[2]-&gt;IsObject()) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â ASYNC_CALL(access, args[2], UTF8, *path, mode);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â SYNC_CALL(access, *path, *path, mode);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>å…³äºï¼šASYNC_CALL(access, args[2], UTF8, *path, mode) çš„å«ä¹‰ï¼š</div><div><br/></div><div>å…¶ä¸­ç¬¬ä¸€ä¸ª â€œaccessâ€ å‚æ•°æŒ‡ä»£åº•å±‚ c++ å‡½æ•°ï¼šaccessï¼šå‚è§è§£é‡Šï¼šï¼ˆ<a href="https://linux.die.net/man/2/access">https://linux.die.net/man/2/access</a>ï¼‰æ‘˜è¦ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Name</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">access - check real user's permissions for a file</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Synopsis</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#include &lt;unistd.h&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">int access(const char *pathname, int mode);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Description</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"> access() checks whether the calling process can access the file pathname. If pathname is a symbolic link, it is dereferenced.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The mode specifies the accessibility check(s) to be performed, and is either the value F_OK, or a mask consisting of the bitwise OR of one or more of R_OK, W_OK, and X_OK. F_OK tests for the existence of the file. R_OK, W_OK, and X_OK test whether the file exists and grants read, write, and execute permissions, respectively.</font><br/></div></div><div><br/></div><div>ç¬¬äºŒä¸ªå‚æ•° args[2] ä¸º FSReqWrap å®ä¾‹å¯¹è±¡ï¼›ç¬¬ä¸‰ä¸ªå‚æ•° utf8 æšä¸¾ç±»å‹ï¼›ç¬¬å››ä¸ªå‚æ•° *path å°† path æŒ‡é’ˆè§£å¼•ç”¨ï¼Œè·å–å…¶å€¼ï¼›ç¬¬äº”ä¸ªå‚æ•°ä¸º mode å³æµ‹è¯•ç±»å‹ã€‚</div><div><br/></div><div>æ¥çœ‹ ASYNC_CALL å®å±•å¼€ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#define ASYNC_CALL(func, req, encoding, ...)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â ASYNC_DEST_CALL(func, req, nullptr, encoding, __VA_ARGS__) Â  Â  Â  Â  Â  Â  Â  Â  Â \</font><br/></div><div><br/></div><div>__VA_ARGS__ ä»£è¡¨ â€¦ éƒ¨åˆ†çš„å‚æ•°åˆ—è¡¨</div></div><div><br/></div><div>ç»§ç»­å±•å¼€ ASYNC_DEST_CALL ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#define ASYNC_DEST_CALL(func, req, dest, encoding, ...)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Environment* env = Environment::GetCurrent(args);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // req å¿…é¡»ä¸º Object ç±»å‹</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK(req-&gt;IsObject());Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // æ˜¾å¼åœ°è°ƒç”¨æ„é€ å‡½æ•°ï¼Œæ­¤å¥çš„åˆ†æè§ä¸‹</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â FSReqWrap* req_wrap = FSReqWrap::New(env, req.As&lt;Object&gt;(),Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #func, dest, encoding);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â int err = uv_fs_ ## func(env-&gt;event_loop(),Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &amp;req_wrap-&gt;req_,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â __VA_ARGS__,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â After);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â req_wrap-&gt;Dispatched();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (err &lt; 0) {Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â uv_fs_t* uv_req = &amp;req_wrap-&gt;req_;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â uv_req-&gt;result = err;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â uv_req-&gt;path = nullptr;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â After(uv_req);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â req_wrap = nullptr;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else {Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â args.GetReturnValue().Set(req_wrap-&gt;persistent());Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font><br/></div></div><div><br/></div><div>å…³äº FSReqWrap::New çš„è°ƒç”¨ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">FSReqWrap* FSReqWrap::New(Environment* env,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Local&lt;Object&gt; req,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const char* syscall,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const char* data,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â enum encoding encoding,</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Ownership ownership) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">envÂ Â Â Â Â node::Environment *Â Â Â Â Â 0x105000000Â Â Â Â Â 0x0000000105000000</font></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">reqÂ Â Â Â Â v8::Local&lt;v8::Object&gt;</font></span><br/></font></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <span>Â Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">val_Â Â Â Â Â v8::Object *Â Â Â Â Â 0x7fff5fbfe920Â Â Â Â Â 0x00007fff5fbfe920</font></span></span><br/></font></span></font></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">syscallÂ Â Â Â Â const char *Â Â Â Â Â "accessâ€Â Â Â Â Â 0x00000001011156e3 ã€ç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„åç§°ã€‘</font></span><br/></font></span></font></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">dataÂ Â Â Â Â const char *Â Â Â Â Â NULLÂ Â Â Â Â 0x0000000000000000 ã€ç©ºæŒ‡é’ˆã€‘</font></span><br/></font></span></font></span></font></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â <span>Â //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">encodingÂ Â Â Â Â node::encodingÂ Â Â Â Â UTF8 ã€ç¼–ç ã€‘</font></span></span><br/></font></span></font></span></font></span></font></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">ownershipÂ Â Â Â Â node::FSReqWrap::OwnershipÂ Â Â Â Â COPY ã€æ‰€æœ‰æƒï¼Ÿã€‘</font></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Â  const bool copy = (data != nullptr &amp;&amp; ownership == COPY); //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">copyÂ Â Â Â Â const boolÂ Â Â Â Â false</font><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const size_t size = copy ? 1 + strlen(data) : 0; //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">sizeÂ Â Â Â Â size_tÂ Â Â Â Â 0</font></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â FSReqWrap* that; // åˆå§‹åŒ–æŒ‡é’ˆ</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è®¡ç®— FSReqWrap å¯¹è±¡å¤§å°ï¼Œå¹¶ä¸”å¼€è¾Ÿç©ºé—´ï¼Œæ³¨æ„ storage ç±»å‹ä¸ºæ•°ç»„ã€æŒ‡é’ˆç±»å‹ã€‘</span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span>Â Â </span>//Â </font><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333">storageÂ Â Â Â Â char *constÂ Â Â Â Â "â€Â Â  Â  0x0000000105800010</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">(lldb) print storage[0]</font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // (char) $18 = '\0'</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // (lldb) print storage[1]</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // (char) $19 = â€˜\0'</font><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span/><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â char* const storage = new char[sizeof(*that) + size];</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // å¼€å§‹åœ¨ä¸Šé¢å¼€è¾Ÿçš„ç©ºé—´å†…åˆå§‹åŒ– FSReqWrap å®ä¾‹</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â that = new(storage) FSReqWrap(env, req, syscall, data, encoding);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // æœ€ç»ˆè¿”å›åˆ›å»ºçš„å¯¹è±¡</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return that;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>æ¥çœ‹ FSReqWrap çš„ c++ æ„é€ å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå› ä¸º FSReqWrap ç±»çš„ç»§æ‰¿ç»“æ„æ¯”è¾ƒæ·±ï¼Œä¸€æ­¥ä¸€æ­¥æ¥çœ‹ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#5Â Â Â Â Â 0x0000000100063229 in node::FSReqWrap::New(node::Environment*, v8::Local&lt;v8::Object&gt;, char const*, char const*, node::encoding, node::FSReqWrap::Ownership) at /Users/mrguan/work/build/node/node-6.6.0/src/node_file.cc:116</font></div><div><br/>// è¿™é‡Œæ˜¯è°ƒç”¨å¤„
</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">that = new(storage) FSReqWrap(env, req, syscall, data, encoding);</font><br/></div><div>// å…·ä½“çš„å‚æ•°ä¿¡æ¯è§ä¸Šä¸€ä¸ªä»£ç å—ä¸­çš„æ³¨é‡Š</div></div><div><br/></div><div>åœ¨æ„é€  FSReqWrap å®ä¾‹å¯¹è±¡æ—¶ï¼Œä¼šä»æœ€é¡¶å±‚çš„ super ç±»æ„é€ å‡½æ•°ä¸€å±‚ä¸€å±‚å¾€ä¸‹è°ƒç”¨ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#4Â Â Â Â Â 0x0000000100063e2d in node::FSReqWrap::FSReqWrap(node::Environment*, v8::Local&lt;v8::Object&gt;, char const*, char const*, node::encoding) at /Users/mrguan/work/build/node/node-6.6.0/src/node_file.cc:86</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#3Â Â Â Â Â 0x0000000100063eb2 in node::FSReqWrap::FSReqWrap(node::Environment*, v8::Local&lt;v8::Object&gt;, char const*, char const*, node::encoding) at /Users/mrguan/work/build/node/node-6.6.0/src/node_file.cc:83</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#2Â Â Â Â Â 0x0000000100063f5d in node::ReqWrap&lt;uv_fs_s&gt;::ReqWrap(node::Environment*, v8::Local&lt;v8::Object&gt;, node::AsyncWrap::ProviderType) at /Users/mrguan/work/build/node/node-6.6.0/src/req-wrap-inl.h:20</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#1Â Â Â Â Â 0x0000000100010fb0 in node::AsyncWrap::AsyncWrap(node::Environment*, v8::Local&lt;v8::Object&gt;, node::AsyncWrap::ProviderType, node::AsyncWrap*) at /Users/mrguan/work/build/node/node-6.6.0/src/async-wrap-inl.h:22</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#0Â Â Â Â Â 0x0000000100011516 in node::BaseObject::BaseObject(node::Environment*, v8::Local&lt;v8::Object&gt;) at /Users/mrguan/work/build/node/node-6.6.0/src/base-object-inl.h:18</font></div></div><div><br/></div><div>æ„é€ å‡½æ•°è°ƒç”¨é¡ºåºï¼š0 -&gt; 4ï¼Œè°ƒç”¨æ ˆæˆªå›¾è§ï¼š</div><div><br/></div><div><img src="fs%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201%20-%20FSReqWrap%20%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9E%84%E9%80%A0.resources/85E60878-4DE0-43EA-983C-483552631A6E.png" height="auto" width="100%"/><br/></div><div><br/></div><div>0 -&gt; node::BaseObject::BaseObject çš„è°ƒç”¨ï¼š<br/></div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">inline BaseObject::BaseObject(Environment* env, v8::Local&lt;v8::Object&gt; handle)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ğŸŒŸ<font style="font-size: 12px; color: rgb(51, 51, 51);">v8::Persistent&lt;v8::Object&gt; persistent_handle_</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ğŸŒŸ<font style="font-size: 12px; color: rgb(51, 51, 51);">æ³¨æ„è¿™é‡Œçš„Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">persistent_handle_ ï¼Œæ˜¯å°†åŸå§‹ js å±‚çº§çš„ req å¯¹è±¡åœ¨ c++ å±‚æ¬¡çš„æ˜ å°„ Local å¯¹è±¡è½¬åŒ–ä¸ºä¸€ä¸ªâ€œæŒä¹…åŒ–â€çš„ HandleÂ å¯¹è±¡</font></font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><span>Â  Â  // ğŸŒŸåœ¨æœ€å¤–å±‚çš„æ„é€ å‡½æ•°è°ƒç”¨ object() å‡½æ•°æ—¶ï¼Œå°†è¿”å›æ­¤Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51);">persistent_handle_ å¯¹è±¡ã€å³ä¸º req å¯¹è±¡çš„æŒä¹…åŒ–æ˜ å°„å¯¹è±¡ã€‘é‡æ–°è½¬åŒ–ä¸º</font></span><br/></font></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><span><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â <span>Â // ğŸŒŸLocal ç±»å‹å¯¹è±¡</span></span><br/></font></span></font></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â : persistent_handle_(env-&gt;isolate(), handle),Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â env_(env) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // æ³¨æ„è¿™é‡Œçš„ handle å¯¹è±¡å³ä¸ºä¹‹å‰ä¼ å…¥çš„ req å¯¹è±¡</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">handleÂ Â Â Â Â v8::Local&lt;v8::Object&gt; Â <font style="font-size: 12px; color: rgb(51, 51, 51);">val_Â Â Â Â Â v8::Object *Â Â Â Â Â 0x7fff5fbfe920Â Â Â Â Â 0x00007fff5fbfe920</font></font></span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK_EQ(false, handle.IsEmpty()); // å…ˆåˆ¤æ–­ req å¼‚æ­¥è¯·æ±‚å¯¹è±¡æ˜¯æ­£å¸¸çš„</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // The zero field holds a pointer to the handle. Immediately set it to</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // nullptr in case it's accessed by the user before construction is complete.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // å› ä¸º js å±‚çº§çš„ binding.<font style="font-size: 12px; color: rgb(51, 51, 51);">FSReqWrap æ„é€ å‡½æ•°æ˜ å°„åˆ° c++ å±‚æ¬¡ï¼Œä¸”åœ¨å…¶åˆå§‹åŒ–æ—¶æœ‰Â <font style="font-size: 12px; color: rgb(51, 51, 51);">SetInternalFieldCount(1) è°ƒç”¨ï¼ˆè§ä¸Šè¿°åˆ†æï¼‰</font></font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">(lldb) print handle-&gt;InternalFieldCount()</font></span></font></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // (int) $0 = 1</font><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><br/></font></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (handle-&gt;InternalFieldCount() &gt; 0)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ä¼šè¿›å…¥åˆ†æ”¯æ‰§è¡Œ</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â handle-&gt;SetAlignedPointerInInternalField(0, nullptr);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ã€å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆæœ‰å¾…ç¼•æ¸…ã€‘</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>1 -&gt;Â node::AsyncWrap::AsyncWrap çš„è°ƒç”¨ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">inline AsyncWrap::AsyncWrap(Environment* env,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â v8::Local&lt;v8::Object&gt; object,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ProviderType provider,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â AsyncWrap* parent)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â : BaseObject(env, object), bits_(static_cast&lt;uint32_t&gt;(provider) &lt;&lt; 1),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â uid_(env-&gt;get_async_wrap_uid()) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">thisÂ Â Â Â Â node::AsyncWrap *Â Â Â Â Â 0x103603ff0Â Â Â Â Â 0x0000000103603ff0</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <span>Â Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">node::BaseObjectÂ Â Â Â Â node::BaseObjectÂ Â Â Â Â </font></span></span><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //<span>Â  Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">bits_Â Â Â Â Â uint32_tÂ Â Â Â Â 6</font></span></span><br/></font></span></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //<span>Â  Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">uid_Â Â Â Â Â int64_tÂ Â Â Â Â 1</font></span></span><br/></font></span></span></font></span></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK_NE(provider, PROVIDER_NONE);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK_GE(object-&gt;InternalFieldCount(), 1); //Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">object-&gt;InternalFieldCount() == 1 åˆ¤æ–­æ˜¯ä¸æ˜¯ &gt;= 1</font></font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Shift provider value over to prevent id collision.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â persistent().SetWrapperClassId(NODE_ASYNC_ID_OFFSET + provider);</font></div><div><span>Â  // ã€TODOã€‘<font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">env-&gt;async_hooks_init_function æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿ</font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â v8::Local&lt;v8::Function&gt; init_fn = env-&gt;async_hooks_init_function();</font></div><div><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">init_fnÂ Â Â Â Â v8::Local&lt;v8::Function&gt; Â  Â Â <font style="font-size: 12px; color: rgb(51, 51, 51);">val_Â Â Â Â Â v8::Function *Â Â Â Â Â NULLÂ Â Â Â Â 0x0000000000000000</font></font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ä»è¿™ä¸ªåˆ†æ”¯è·³å‡º</span><br/></font></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // No init callback exists, no reason to go on.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (init_fn.IsEmpty())</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">. . .</font><br/></div></div><div><br/></div><div>2 -&gt;Â node::ReqWrap&lt;uv_fs_s&gt;::ReqWrap çš„è°ƒç”¨ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">template &lt;typename T&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">ReqWrap&lt;T&gt;::ReqWrap(Environment* env,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â v8::Local&lt;v8::Object&gt; object,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â AsyncWrap::ProviderType provider)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â : AsyncWrap(env, object, provider) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">thisÂ Â Â Â Â node::ReqWrap&lt;uv_fs_s&gt; *Â Â Â Â Â 0x103603ff0Â Â Â Â Â 0x0000000103603ff0</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <span>Â Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">node::AsyncWrapÂ Â Â Â Â node::AsyncWrapÂ Â Â Â Â </font></span></span><br/></font></span></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <span>Â  Â Â <font style="font-size: 12px; color: rgb(51, 51, 51);">req_wrap_queue_Â Â Â Â Â node::ListNode&lt;node::ReqWrap&lt;uv_fs_s&gt; &gt;Â Â Â Â Â </font></span></span><br/></font></span></span></font></span></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //<span>Â  Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">req_Â Â Â Â Â uv_fs_sÂ Â Â Â Â </font></span></span><br/></font></span></span></font></span></span></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // FIXME(bnoordhuis) The fact that a reinterpret_cast is needed is</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // arguably a good indicator that there should be more than one queue.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ğŸŒŸğŸŒŸğŸŒŸå°†è¿™æ¬¡çš„è¯·æ±‚ ReqWrap&lt;uv_req_t&gt; æ¨å…¥é˜Ÿåˆ—Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">env-&gt;</font><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">req_wrap_queue<font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">ğŸŒŸğŸŒŸğŸŒŸ</font></font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â env-&gt;req_wrap_queue()-&gt;PushBack(reinterpret_cast&lt;ReqWrap&lt;uv_req_t&gt;*&gt;(this));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>3/4 -&gt;Â node::FSReqWrap::FSReqWrap æ‰§è¡Œæµç¨‹ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>. . .</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"> private: // FSReqWrap æ„é€ å‡½æ•°ä¸ºç§æœ‰ï¼Œè¢«Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">FSReqWrap::New æ‰€è°ƒç”¨å’Œæ„å»º</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â FSReqWrap(Environment* env,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Local&lt;Object&gt; req,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â const char* syscall,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â const char* data,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â enum encoding encoding)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â : ReqWrap(env, req, AsyncWrap::PROVIDER_FSREQWRAP),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â encoding_(encoding),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â syscall_(syscall),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â data_(data) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // object() å‡½æ•°å°†ä¸€ä¸ª v8 ä¸­çš„â€œæŒä¹…åŒ– Handle å¯¹è±¡â€è½¬åŒ–æˆÂ Local ç±»å‹å¯¹è±¡ã€ä¸åŸå§‹çš„ req ç›¸å¯¹åº”ã€‘</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">return PersistentToLocal(env_-&gt;isolate(), persistent_handle_);</font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // æ³¨æ„è¿™é‡Œçš„ Wrap å‡½æ•°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  [[</span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  Â  Â  template &lt;typename TypeName&gt;</font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â void Wrap(v8::Local&lt;v8::Object&gt; object, TypeName* pointer) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â CHECK_EQ(false, object.IsEmpty());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â CHECK_GT(object-&gt;InternalFieldCount(), 0);Â </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â Â  Â <span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">(lldb) print object-&gt;InternalFieldCount()</font></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â Â  Â <span>Â  //Â </span></span></span>(int) $18 = 1</font><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span/></span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â Â  Â <span>Â Â  Â <span>Â  // å°†æ­¤ v8::Local&lt;<font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">v8::</font>Object&gt; å¯¹è±¡ï¼ˆä¸ js å±‚çº§çš„ object å¯¹åº”ï¼‰ä¸­è®¾ç½®æŒ‡å‘å¯¹åº” c++ æ˜ å°„å¯¹è±¡çš„æŒ‡é’ˆ</span></span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â object-&gt;SetAlignedPointerInInternalField(0, pointer);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â }</font><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â Â </span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  ]]</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span>Â  Â  // è¿™æ˜¯ä¸€ç§å¸¸è§çš„å°† js å¯¹è±¡å’Œ c++ å¯¹è±¡â€œç²˜åˆâ€çš„æ–¹å¼</span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Wrap(object(), this);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>åˆ°æ­¤ï¼ŒFSReqWrap å¯¹è±¡æ„å»ºå®Œæ¯•ï¼Œè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸€ç³»åˆ— super åŠå…¶è‡ªèº«æ„é€ å‡½æ•°å®Œæˆæ‰§è¡Œåï¼Œä¹ŸæŠŠè‡ªèº«æ¨å…¥äº†Â env-&gt;req_wrap_queue() çš„åŒå‘ req_wrap è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æœ€é‡è¦çš„æ˜¯è¦äº†è§£ js å¯¹è±¡å’Œ c++ å¯¹è±¡æ˜¯æ€ä¹ˆâ€œç²˜åˆâ€åœ¨ä¸€èµ·çš„(Wrap(object(), this))ã€‚æœ€ç»ˆçš„ç»§æ‰¿ç»“æ„æˆªå›¾ï¼š</div><div><br/></div><div><img src="fs%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201%20-%20FSReqWrap%20%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9E%84%E9%80%A0.resources/ED5168C5-AFAE-4250-8636-730C9B6B9328.png" height="auto" width="100%"/><br/></div><div><br/></div><div>ä¸‹ä¸€èŠ‚ç»§ç»­åˆ†æã€‚</div><div><br/></div><div><hr/></div><div><br/></div><div>é™„å½•</div><div><br/></div><div>env-&gt;req_wrap_queue() é“¾è¡¨ç›¸å…³åˆå§‹åŒ–å’Œæ“ä½œï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>// é“¾è¡¨ append</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">env-&gt;req_wrap_queue()-&gt;PushBack(reinterpret_cast&lt;ReqWrap&lt;uv_req_t&gt;*&gt;(this));</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><br/></font></div><div>// req_wrap_queue å®šä¹‰ï¼š</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef ListHead&lt;ReqWrap&lt;uv_req_t&gt;, &amp;ReqWrap&lt;uv_req_t&gt;::req_wrap_queue_&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â ReqWrapQueue;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">inline ReqWrapQueue* req_wrap_queue() { return &amp;req_wrap_queue_; }</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><br/></font></div><div>// å¦‚ä½• PushBack</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">template &lt;typename T, ListNodeMember(T) M&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">void ListHead&lt;T, M&gt;::PushBack(T* element) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â ListNode&lt;T&gt;* that = &amp;(element-&gt;*M);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â head_.prev_-&gt;next_ = that;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â that-&gt;prev_ = head_.prev_;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â that-&gt;next_ = &amp;head_;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â head_.prev_ = that;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šThu Feb 09 2017 15:48:32 GMT+0800 (CST)</p>
</div></body></html>