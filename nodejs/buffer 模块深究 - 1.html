<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2016-12-16 08:41:30 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-24 07:08:00 +0000"/><title>buffer æ¨¡å—æ·±ç©¶ - 1</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>buffer æ¨¡å—æ·±ç©¶ - 1</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>é¦–å…ˆå›é¡¾ä¸‹å®˜æ–¹æ‰‹å†Œå¯¹ buffer çš„æè¿°ä¿¡æ¯ï¼šÂ </div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Prior to the introduction of TypedArray in ECMAScript 2015 (ES6), the JavaScript language had no mechanism for reading or manipulating streams of binary data. The Buffer class was introduced as part of the Node.js API to make it possible to interact with octet streams in the context of things like TCP streams and file system operations.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Now that TypedArray has been added in ES6, the Buffer class implements the Uint8Array APIï¼ˆæ³¨æ„è¿™é‡Œæ˜¯ Buffer æ‰©å±•äº† V8 å·²ç»å®ç°çš„ Uint8Arrayï¼‰Â in a manner that is more optimized and suitable for Node.js' use cases.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Instances of the Buffer class are similar to arrays of integers but correspond to fixed-sized, raw memory allocations outside the V8 heapï¼ˆæ³¨æ„è¿™é‡Œçš„â€œoutsideâ€ï¼Œåœ¨ node å±‚é¢ï¼ŒBuffer çš„å®ä¾‹å¯¹è±¡ä¸å†å—åˆ° V8 çš„å †å†…å­˜é™åˆ¶ï¼‰. The size of the Buffer is established when it is created and cannot be resized.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The Buffer class is a global within Node.js, making it unlikely that one would need to ever use require('buffer').Buffer.</font><br/></div></div><div><br/></div><div>buffer æ¨¡å—ä¹Ÿæ˜¯ä½œä¸ºå…¨å±€å¯¹è±¡ global çš„ Buffer å±æ€§ï¼Œåœ¨ node å¯åŠ¨é˜¶æ®µå°±åŠ è½½å¥½çš„ã€‚</div><div><br/></div><div>è¿™é‡Œé¡ºå¸¦è¯´ä¸€ä¸‹ï¼Œglobal è¿™ä¸ªå…¨å±€å¯¹è±¡å˜é‡ï¼Œæ˜¯ä»€ä¹ˆæ—¶å€™è¢«â€œæ³¨å…¥â€çš„ï¼Ÿglobal å˜é‡çš„å…¨å±€â€œæ³¨å…¥â€ï¼Œåœ¨ node å¯åŠ¨ä¹‹æ—¶ï¼Œæ–­ç‚¹ä½ç½®æ˜¯ï¼š</div><div>Â <br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0Â Â Â Â Â 0x000000010002a484 in node::LoadEnvironment(node::Environment*) at /Users/mrguan/work/build/node/node-6.6.0/src/node.cc:3498</font></div></div><div><br/></div><div><img src="buffer%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201.resources/3F558EAF-4890-476C-9C88-36F8BD0F6076.png" height="auto" width="100%"/><br/></div><div><br/></div><div>LoadEnvironment çš„ä½œç”¨å°±æ˜¯è°ƒç”¨ bootstrap_node.js å¯åŠ¨æ–‡ä»¶ä¸­çš„å¯åŠ¨å‡½æ•°ï¼Œè€Œæˆªå›¾ä¸­çš„ä¸Šè¿°ä»£ç ï¼Œåˆ™æ˜¯åœ¨å¯åŠ¨å‡½æ•°è°ƒç”¨ä¹‹å‰ï¼Œå°† Â global æ³¨å…¥è¿›å¯åŠ¨å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸­ã€‚</div><div><hr/>åœ¨ bootstrap_node.js å¯åŠ¨æµç¨‹ä¸­ï¼Œstartup å‡½æ•°ä½“ä¸­ä¼šè°ƒç”¨Â setupGlobalVariables å‡½æ•°ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â function setupGlobalVariables() {</font></div><div><font style="color: rgb(51, 51, 51); font-family: Monaco; font-size: 12px;">Â  Â  . . .</font></div><div><font style="color: rgb(51, 51, 51); font-family: Monaco; font-size: 12px;"><span>Â  Â  // å¼•å…¥ Buffer æ¨¡å—</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â global.Buffer = NativeModule.require('buffer').Buffer;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â process.domain = null;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â process._exiting = false;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>buffer åœ¨è¢«åŠ è½½ä¹‹æ—¶ï¼Œåšäº†å“ªäº›æ“ä½œå‘¢ï¼Ÿ</div><div><br/></div><div>æœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼Œä»£ç æ¥è‡ª node/lib/buffer.js æ–‡ä»¶ï¼Œæ˜¯ä¸€äº›å‰æœŸå£°æ˜ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">/* eslint-disable require-buffer */</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">'use strict';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// å¼•ç”¨åº•å±‚ c++ æ¨¡å—</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">const binding = process.binding('buffer');</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">const { isArrayBuffer } = process.binding('utilâ€™);</font></div><div><font face="Monaco">// c++ å’Œ js é€šä¿¡æ¡¥</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">const bindingObj = {};</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">const internalUtil = require('internal/util');</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// FastBuffer ç›´æ¥ç»§æ‰¿äº† V8 çš„Â Uint8Array</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">class FastBuffer extends Uint8Array {}</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// è®¾ç½®æ„é€ å‡½æ•°å±æ€§</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">FastBuffer.prototype.constructor = Buffer;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Buffer.prototype = FastBuffer.prototype;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// æš´éœ² Buffer</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports.Buffer = Buffer;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports.SlowBuffer = SlowBuffer;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports.INSPECT_MAX_BYTES = 50;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// å¤§å°é™åˆ¶è§ä¸‹åˆ†æ</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">exports.kMaxLength = binding.kMaxLength;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// é”™è¯¯ä¿¡æ¯</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">const kFromErrorMsg = 'First argument must be a string, Buffer, ' +</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'ArrayBuffer, Array, or array-like object.';</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// poolSize 8KB å¤§å°ä¸º 1 ä¸ª poolSize</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Buffer.poolSize = 8 * 1024;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// è¿™å‡ ä¸ªå˜é‡ä¸º Buffer é€»è¾‘å†…çš„å…¨å±€å¯¹è±¡</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">var poolSize, poolOffset, allocPool;</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// è°ƒç”¨åº•å±‚å‡½æ•°ï¼Œè§ä¸‹åˆ†æ</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// ä¸º Buffer æ„é€ å‡½æ•°çš„ prototype å¯¹è±¡é™„åŠ ä¸€äº›åº•å±‚å‡½æ•°ï¼Œä¹‹åè¿˜ä¼šé™„åŠ  js å±‚çº§çš„å‡½æ•°</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">binding.setupBufferJS(Buffer.prototype, bindingObj);</font><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// ä¸Šä¸€æ­¥å·²ç»è®¾ç½®å¥½ bindingObj.flags å¯¹è±¡ä¸ºä¸€ä¸ª Uint32Array å¯¹è±¡ï¼Œä¸”åªæœ‰ä¸€ä¸ªå…ƒç´ </font></div><div><font face="Monaco">// c++ &lt;==&gt; js é€šä¿¡ç”¨</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51);">const flags = bindingObj.flags;</font></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51);">const kNoZeroFill = 0;</font><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">. . .</font></div></div><div><br/></div><div>å…³äº binding.kMaxLengthï¼Œåœ¨ buffer åº•å±‚ c++ æ¨¡å—è¢«åŠ è½½æ—¶èµ‹äºˆçš„å±æ€§å€¼ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">target-&gt;Set(env-&gt;context(),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â FIXED_ONE_BYTE_STRING(env-&gt;isolate(), "kMaxLength"),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Integer::NewFromUnsigned(env-&gt;isolate(), kMaxLength)).FromJust();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// kMaxLength å®šä¹‰</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">static const unsigned int kMaxLength =</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // ç”±ä¸‹é¢çš„å®å®šä¹‰å¯çŸ¥ï¼šintptr_r == long</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â sizeof(int32_t) == sizeof(intptr_t) ? 0x3fffffff : 0x7fffffff;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// ç›¸å…³å®å®šä¹‰</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef intÂ Â Â Â Â int32_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef __darwin_intptr_t intptr_t;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#ifdef __GNUC__</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef __signed charÂ Â Â __int8_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#else /* !__GNUC__ */</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef charÂ Â Â Â Â Â __int8_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#endifÂ Â /* !__GNUC__ */</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef unsigned charÂ Â Â __uint8_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef shortÂ Â Â Â Â __int16_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef unsigned shortÂ Â Â Â __uint16_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef intÂ Â Â Â Â __int32_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef unsigned intÂ Â Â Â __uint32_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef long longÂ Â Â __int64_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef unsigned long longÂ Â __uint64_t;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// è¿™é‡Œ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef longÂ Â Â Â Â Â __darwin_intptr_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">typedef unsigned intÂ Â Â Â __darwin_natural_t;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">. . .</font></div><div><br/></div></div><div><br/></div><div>0x3FFFFFFF å’Œ 0x7FFFFFFF çš„å½¢è±¡åŒ–è¡¨ç¤ºï¼š</div><div><br/></div><div><img src="buffer%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201.resources/41A5E3A1-9481-4C09-9982-FDAE3A5B54C5.png" height="auto" width="100%"/><br/></div><div><img src="buffer%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201.resources/D5929A97-A1E5-429A-8483-848FCC2FEB30.png" height="auto" width="100%"/><br/></div><div><br/></div><div>è‡³äº 10 è¿›åˆ¶æ˜¯ä»€ä¹ˆå°±ä¸å»æ¢ç®—äº†ã€‚ä¸Šè¿°çš„ sizeof åˆ¤æ–­åˆ™ä¸ºæœºå™¨æ¶æ„çš„åˆ¤æ–­ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">On 32-bit architectures, this value is (2^30)-1 (~1GB). On 64-bit architectures, this value is (2^31)-1 (~2GB).</font><br/></div></div><div><br/></div><div><hr/></div><div><br/></div><div>å…³äºÂ binding.setupBufferJS çš„è°ƒç”¨ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Buffer.prototype ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç©ºçš„ {}ï¼Œæ–­ç‚¹è¿›å…¥ï¼š</div><div>Â <br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#0Â Â Â Â Â 0x00000001000404ef in node::Buffer::SetupBufferJS(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) at /Users/mrguan/work/build/node/node-6.6.0/src/node_buffer.cc:1300</font></div></div><div><br/></div><div><img src="buffer%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%201.resources/7C490DF0-7CAB-4F4C-8F27-358DE7F2A665.png" height="auto" width="100%"/><br/></div><div><br/></div><div>å…·ä½“æ€ä¹ˆé™„åŠ  prototype å¯¹è±¡çš„æ–¹æ³•ä¸å†èµ˜è¿°ï¼Œå¦‚ä¸Šæˆªå›¾ï¼Œå…³æ³¨ç¬¬äºŒä¸ªå‚æ•° bindingObjï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#0Â Â Â Â Â 0x0000000100040672 in node::Buffer::SetupBufferJS(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) at /Users/mrguan/work/build/node/node-6.6.0/src/node_buffer.cc:1312</font></div><div><br/>// æ­¤å¤„å¼€å§‹è®¾ç½® bindingObj ç›¸å…³çš„é€»è¾‘</div><div>. . .</div><div><span>Â  // ç¡®ä¿ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª Object</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK(args[1]-&gt;IsObject());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è·å–åˆ°æ­¤ Object</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Local&lt;Object&gt; bObj = args[1].As&lt;Object&gt;();</font></div><div><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">fieldsÂ Â Â Â Â uint32_t *constÂ Â Â Â Â 0x105008600Â Â Â Â Â 0x0000000105008600</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // fields æœ€ç»ˆè¿”å›ä¸€ä¸ª uint32_t çš„æ•°ç»„æŒ‡é’ˆ</span><br/></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â uint32_t* const fields = env-&gt;array_buffer_allocator_info()-&gt;fields();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è¿”å›å­—æ®µä¸ªæ•°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â uint32_t const fields_count =</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â env-&gt;array_buffer_allocator_info()-&gt;fields_count();</font></div><div><span>Â  // åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„ v8 ArrayBuffer ç»“æ„ï¼Œå¤§å°ç”± fields å’Œ fields_count æ¥å†³å®š</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Local&lt;ArrayBuffer&gt; array_buffer =</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â ArrayBuffer::New(env-&gt;isolate(), fields, sizeof(*fields) * fields_count);</font></div><div><span>Â  // åœ¨ ArrayBuffer çš„åŸºç¡€ä¸Šï¼Œåˆ›å»º js å±‚çº§çš„ Uint32Array å¯¹è±¡</span><br/></div><div><span><span>Â  // å³è®¾ç½® js å±‚çº§çš„ bindingObj.flags ä¸ºæ­¤ Uint32Array å¯¹è±¡</span><br/></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â bObj-&gt;Set(String::NewFromUtf8(env-&gt;isolate(), "flags"),</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â Â Â Â Â Uint32Array::New(array_buffer, 0, fields_count));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div><div>====&gt;</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">inline int Environment::ArrayBufferAllocatorInfo::fields_count() const {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return kFieldsCount;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div><div>====&gt;</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">enum Fields {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â kNoZeroFill,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â kFieldsCount // 1</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">uint32_t fields_[kFieldsCount];</font></div></div><div><br/></div><div><hr/></div><div>ğŸŒŸbuffer æ¨¡å—åœ¨è¢«åŠ è½½ä¹‹åˆï¼Œä¼šé¦–æ¬¡æ‰§è¡Œ createPool å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ª â€œpoolâ€ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// é»˜è®¤ poolSize å¤§å°ä¸º 8KB å¤§å°</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Buffer.poolSize = 8 * 1024;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">var poolSize, poolOffset, allocPool;</font></div><div><br/></div><div>// å·²ç»åˆ†æ</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">binding.setupBufferJS(Buffer.prototype, bindingObj);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">const flags = bindingObj.flags;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">const kNoZeroFill = 0;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function createUnsafeBuffer(size) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // éå¡«å……æ•°æ®</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â flags[kNoZeroFill] = 1;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â try {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // åˆ›å»º FastBuffer å¯¹è±¡</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return new FastBuffer(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } finally {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // æ¢å¤ 0</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â flags[kNoZeroFill] = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">function createPool() {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // 8 * 1024</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â poolSize = Buffer.poolSize;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // è°ƒç”¨ createUnsafeBuffer åˆ›å»º FastBuffer( Uint8Array å­ç±»Â )</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  // è¿™å°±æ˜¯ä¸€ä¸ª poolSize å¤§å°çš„ allocPool ã€å…¨å±€å¯¹è±¡ã€‘</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â allocPool = createUnsafeBuffer(poolSize);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // æ¢å¤åç§»é‡ã€å…¨å±€ã€‘</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â poolOffset = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// buffer æ¨¡å—åŠ è½½æ—¶æ‰§è¡Œ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">createPool();</font><br/></div></div><div><br/></div><div><hr/>æµ‹è¯•æ–‡ä»¶å‚è§ test-nodejs/buffer/main.js ï¼Œé¦–å…ˆè¿›å…¥ç¬¬ä¸€ä¸ªæµ‹è¯•è¯­å¥ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>const buf1 = Buffer.alloc( 20 );</div></div><div><br/></div><div>æ­¤æ¡è¯­å¥æœ€ç»ˆè¿›å…¥ node/lib/buffer.js ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">/**</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"> * Creates a new filled Buffer instance.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"> * alloc(size[, fill[, encoding]])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"> **/</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Buffer.alloc = function(size, fill, encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // size == 20</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>Â  // fill == undefined == encoding</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>Â  // è¿™ä¸€å¥åªæ˜¯ä¿è¯ä¼ å…¥çš„ size å‚æ•°ä¸€å®šè¦æ˜¯ä¸€ä¸ª number</span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â assertSize(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // å› ä¸º fill == undefined æ•…æ­¤åˆ†æ”¯ä¸ä¼šè¿›å…¥</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â if (size &gt; 0 &amp;&amp; fill !== undefined) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â  Â  . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>Â  // è¿›å…¥æ­¤æ„é€ å‡½æ•°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Â Â return new FastBuffer(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">};</font><br/></div></div><div><br/></div><div>è€Œ FastBuffer çš„æ„é€ å‡½æ•°å¾ˆç®€å•ï¼š</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">// è¿™é‡Œçš„ Uint8Array æ˜¯ V8 å±‚é¢çš„å¯¹è±¡</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">class FastBuffer extends Uint8Array {}</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">// ä¿®æ”¹å…¶å®ä¾‹çš„æ„é€ å‡½æ•°å±æ€§</div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">FastBuffer.prototype.constructor = Buffer;</font></div><div><font face="Monaco">// Buffer çš„åŸå‹å¯¹è±¡å’Œ FastBuffer ä¿æŒä¸€è‡´</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">Buffer.prototype = FastBuffer.prototype;</font><br/></div></div><div><br/></div><div>ä¸‹èŠ‚ç»§ç»­åˆ†æ</div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šSat Dec 24 2016 16:00:43 GMT+0800 (CST)</p>
</div></body></html>