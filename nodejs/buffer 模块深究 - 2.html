<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="ç®¡ä¼Ÿ"/><meta name="created" content="2016-12-23 10:27:26 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-26 07:02:39 +0000"/><title>buffer æ¨¡å—æ·±ç©¶ - 2</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>buffer æ¨¡å—æ·±ç©¶ - 2</h2>
<p class="title-p">ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p class="title-p">æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>ç¤ºä¾‹ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#808080;">// Creates a Buffer of length 20, filled with 0x1.<br/></span><span style="color:#cc7832;font-weight:bold;">const </span>buf2 = Buffer.<span style="color:#ffc66d;">alloc</span>( <span style="color:#6897bb;">20</span><span style="color:#cc7832;">, </span><span style="color:#6897bb;">1 </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">'buf2: '</span><span style="color:#cc7832;">, </span>buf2 )<span style="color:#cc7832;">;</span>
</pre>å³ï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ 20 çš„ Buffer å®ä¾‹ï¼Œä¸”å¡«å…… 0x1ï¼Œä»æ—§èµ°å…¥ Buffer.alloc å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Buffer.alloc = function(size, fill, encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // size: 20; fill: 1</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â assertSize(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // èµ°å…¥ if åˆ†æ”¯</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (size &gt; 0 &amp;&amp; fill !== undefined) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // Since we are filling anyway, don't zero fill initially.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // Only pay attention to encoding if it's a string. This</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // prevents accidentally sending in a number that would</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // be interpretted as a start offset.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (typeof encoding !== 'string')</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â encoding = undefined;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // æœ€ç»ˆåˆ°è¿™é‡Œ, createUnsafeBuffer( size ) ä¸Šä¸€èŠ‚å·²ç»åˆ†æè¿‡</span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  // createUnsafeBuffer åˆ›å»ºä¸€ä¸ª FastBuffer å®ä¾‹å¯¹è±¡ï¼Œè€Œ Buffer ç”±ç»§æ‰¿äº† FastBuffer</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><span>Â  Â  // ç›´æ¥è¿›å…¥ fill å‡½æ•°æ¥çœ‹</span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return createUnsafeBuffer(size).fill(fill, encoding);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return new FastBuffer(size);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>è¿›å…¥ fill å‡½æ•°ï¼Œæ­¤å‡½æ•°å³ä¸º Buffer.prototype.fill &lt;==&gt; FastBuffer.prototype.fillï¼ˆä¸Šä¸€èŠ‚å·²ç»åˆ†æè¿‡ï¼‰ï¼Œå› ä¸ºï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>class FastBuffer extends Uint8Array {}<br/></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">FastBuffer.prototype.constructor = Buffer;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// æŒ‰å¼•ç”¨ä¼ å€¼ï¼Œå…±äº« prototype</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Buffer.prototype = FastBuffer.prototype;</font><br/></div></div><div><br/></div><div>fill å‡½æ•°å†…éƒ¨ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// Usage:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â buffer.fill(number[, offset[, end]])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â buffer.fill(buffer[, offset[, end]])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â buffer.fill(string[, offset[, end]][, encoding])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Buffer.prototype.fill = function fill(val, start, end, encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // åªä¼ å…¥ä¸€ä¸ªå‚æ•° val: 1ï¼Œä¸”ç±»å‹ä¸º number</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  // å‰©ä½™ä¸‰ä¸ªéƒ½æ˜¯ undefined</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Handle string cases:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (typeof val === 'string') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  Â  . . . // å­—ç¬¦ä¸²çš„é€»è¾‘ç¨ååˆ†æ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } else if (typeof val === 'number') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // æ­¤å¡«å……æ•°å­—çš„å¤§å°ä¸èƒ½è¶…è¿‡ 255 ï¼ˆå³ 2^8 - 1 = 255ï¼‰ç¬¬ä¸€å­èŠ‚å…¨æ˜¯ 1</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â  // æ•°å­—å¤§å°ä¸èƒ½è¶…è¿‡ 1 byteå¤§å°</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â val = val &amp; 255;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Invalid ranges are not set to a default, so can range check early.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (start &lt; 0 || end &gt; this.length)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â throw new RangeError('Out of range index');</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (end &lt;= start)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return this;</font></div><div><span>Â  // æ‰€æœ‰éæ•°å€¼è½¬æˆ 0ï¼›æ‰€æœ‰å¤§äºç­‰äº 0 å–æ•´æ•°éƒ¨åˆ†</span><br/></div><div><span><span>Â  // ç›¸å…³è¯´æ˜ï¼š<a href="https://www.zhihu.com/question/20693429">https://www.zhihu.com/question/20693429</a></span><br/></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â start = start &gt;&gt;&gt; 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â end = end === undefined ? this.length : end &gt;&gt;&gt; 0;</font></div><div><span>Â  // start === 0</span><br/></div><div><span><span>Â  // end === 20 ( this.length )</span><br/></span></div><div><span><span><span>Â  // èµ°å…¥ binding.fill</span><br/></span></span></div><div><span><span><span><span>Â  // this ==&gt; Uint8Array</span><br/></span></span></span></div><div><span><span><span><span><span>Â  // val: 1, start: 0, end: 20, encoding: undefined</span><br/></span></span></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â binding.fill(this, val, start, end, encoding);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â return this;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">};</font><br/></div></div><div><br/></div><div>æ¥çœ‹çœ‹å¦‚ä½•èµ°å…¥ binding.fill:</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#0Â Â Â Â Â 0x00000001000396b0 in node::Buffer::Fill(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) at /Users/mrguan/work/build/node/node-6.6.0/src/node_buffer.cc:605</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">void Fill(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Environment* env = Environment::GetCurrent(args);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â THROW_AND_RETURN_UNLESS_BUFFER(env, args[0]);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â SPREAD_ARG(args[0], ts_obj);</font></div><div>Â  // 0</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â size_t start = args[2]-&gt;Uint32Value();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â size_t end = args[3]-&gt;Uint32Value(); // 20</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â size_t fill_length = end - start; // 20</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Local&lt;String&gt; str_obj;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â size_t str_length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">BINARY is a deprecated alias of LATIN1.</font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // ğŸŒŸÂ enum encoding {ASCII, UTF8, BASE64, UCS2, BINARY, HEX, BUFFER, LATIN1 = BINARY};</font><font style="font-size: 12px; color: rgb(51, 51, 51);"/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â enum encoding enc;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // ä¿è¯ä¸è¶Šç•Œ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK(fill_length + start &lt;= ts_obj_length);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Then coerce everything that's not a string.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // number</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (!args[1]-&gt;IsString()) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ç±»å‹è½¬æ¢ä¸”ä¿è¯ä¸º 255 ä»¥å†…çš„æ•°å­—(1 byteä¹‹å†…)</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â int value = args[1]-&gt;Uint32Value() &amp; 255;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // å¼€å§‹è®¾ç½®</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memset(ts_obj_data + start, value, fill_length);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">. . .</font></div><div><br/></div><div>====&gt;</div><div><br/></div><div>// è¿™ä¸ªå®ä¿è¯ä» js å±‚çº§ç©¿å…¥çš„ obj å¯¹è±¡æ˜¯ä¸€ä¸ª Buffer å®ä¾‹</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#define THROW_AND_RETURN_UNLESS_BUFFER(env, obj)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â do {Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (!HasInstance(obj))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â return env-&gt;ThrowTypeError("argument should be a Buffer");Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â } while (0)</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">====&gt;</font></div><div>// arg[0], ts_obj(ä½œä¸ºå‰ç¼€)</div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#define SPREAD_ARG(val, name)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // ä¿è¯ç±»å‹</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â CHECK((val)-&gt;IsUint8Array());Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Local&lt;Uint8Array&gt; name = (val).As&lt;Uint8Array&gt;();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â ArrayBuffer::Contents name##_c = name-&gt;Buffer()-&gt;GetContents();Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // ts_obj_offset</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const size_t name##_offset = name-&gt;ByteOffset();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // ts_obj_length</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â const size_t name##_length = name-&gt;ByteLength();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  // ts_obj_data ä¸€ä¸ªæŒ‡å‘ char ç±»å‹çš„æŒ‡é’ˆ</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â char* const name##_data =Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â static_cast&lt;char*&gt;(name##_c.Data()) + name##_offset;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (name##_length &gt; 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â CHECK_NE(name##_data, nullptr);</font><br/></div><div><br/></div><div>====&gt;</div><div><span>Â  // ArrayBuffer::Contents æ˜¯ v8 å¯¹å¤–çš„ API ç±»å‹</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â /**</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â * The contents of an |ArrayBuffer|. Externalization of |ArrayBuffer|</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â * returns an instance of this class, populated, with a pointer to data</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â * and byte length.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â *</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â * The Data pointer of ArrayBuffer::Contents is always allocated with</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â * Allocator::Allocate that is set via Isolate::CreateParams.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â *</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â * This API is experimental and may change significantly.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â */</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â class V8_EXPORT Contents { // NOLINT</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â public:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Contents() : data_(NULL), byte_length_(0) {}</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â void* Data() const { return data_; }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â size_t ByteLength() const { return byte_length_; }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â private:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â void* data_;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â size_t byte_length_;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â friend class ArrayBuffer;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â };</font><br/></div><div><br/></div></div><div><br/></div><div>æœ‰å…³ memset å‡½æ•°è§£æï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">void *memset( void *dest, int ch, size_t count );</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Copies the value ch (after conversion to unsigned char as if by (unsigned char)ch) into each of the first count characters of the object pointed to by dest.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The behavior is undefined if access occurs beyond the end of the dest array. The behavior is undefined if dest is a null pointer.</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"/></div></div><div><br/></div><div>æœ€ç»ˆ Buffer.alloc( 20, 1 ) æ‰§è¡Œå®Œæ¯•ã€‚</div><div><br/></div><div><hr/></div><div><br/></div><div>å†æ¥çœ‹çœ‹ fill å­—ç¬¦ä¸²çš„æƒ…å†µï¼Œç¤ºä¾‹ä»£ç ï¼š</div><div><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Menlo';font-size:13.5pt;"><span style="color:#cc7832;font-weight:bold;">const </span>buf2a1 = Buffer.<span style="color:#ffc66d;">alloc</span>( <span style="color:#6897bb;">20</span><span style="color:#cc7832;">, </span><span style="color:#6a8759;">'He'</span><span style="color:#cc7832;">, </span><span style="color:#6a8759;">'utf8' </span>)<span style="color:#cc7832;">;<br/></span><span style="color:#9876aa;">console</span>.<span style="color:#ffc66d;">log</span>( <span style="color:#6a8759;">'buf2a1: '</span><span style="color:#cc7832;">, </span>buf2a1 )<span style="color:#cc7832;">;</span>
</pre></div><div>æ ¹æ®ä¹‹å‰çš„åˆ†æï¼Œalloc åœ¨å‰åŠéƒ¨åˆ†åšçš„å·¥ä½œéƒ½æ˜¯ä¸€æ ·çš„ï¼šcreateUnsafeBuffer( size ) ï¼Œä¸ä¸€æ ·çš„åœ°æ–¹åœ¨ fill å‡½æ•°çš„ç»†èŠ‚å¤„ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">// Usage:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â buffer.fill(number[, offset[, end]])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â buffer.fill(buffer[, offset[, end]])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â buffer.fill(string[, offset[, end]][, encoding])</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Buffer.prototype.fill = function fill(val, start, end, encoding) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ä»¥ä¸‹æ˜¯å¤„ç†å­—ç¬¦ä¸²çš„æƒ…å½¢ï¼Œä¸å†èµ˜è¿°</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Handle string cases:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (typeof val === 'string') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (typeof start === 'string') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â encoding = start;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â start = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â end = this.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â } else if (typeof end === 'string') {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â encoding = end;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â end = this.length;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (val.length === 1) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â var code = val.charCodeAt(0);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â if (code &lt; 256)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â val = code;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â if (val.length === 0) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // Previously, if val === '', the Buffer would not fill,</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â // which is rather surprising.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â val = 0;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  . . .</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span>Â  Â Â <font style="font-size: 12px; color: rgb(51, 51, 51);">binding.fill(this, val, start, end, encoding);</font></span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  . . .</span><br/></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">. . .</font></div></div><div><br/></div><div>æœ€ç»ˆè¿›å…¥ binding.fill å‡½æ•°ï¼Œé¦–å…ˆçœ‹è¿›å…¥æ—¶çš„å‚æ•°æˆªå›¾ï¼š</div><div><br/></div><div><img src="buffer%20%E6%A8%A1%E5%9D%97%E6%B7%B1%E7%A9%B6%20-%202.resources/DDDBF4AF-B381-4C6D-819A-16551391BFF8.png" height="auto" width="100%"/><br/></div><div><br/></div><div>è¿›å…¥ fill:</div><div><br/></div><div/><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">void Fill(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  // ä¸Šé¢æ— å…³ç´§è¦çš„éƒ½å…ˆä¸ç”¨çœ‹</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">str_objÂ Â Â Â Â v8::Local&lt;v8::String&gt; Â  Â Â </font></span><br/></span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â str_obj = args[1]-&gt;ToString(env-&gt;isolate());</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">encÂ Â Â Â Â node::encodingÂ Â Â Â Â UTF8</font></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â enc = ParseEncoding(env-&gt;isolate(), args[4], UTF8);</font></div><div><font><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span style="font-size: 12px;">Â  //Â </span></font><font><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span style="font-size: 12px;">str_lengthÂ Â Â Â Â size_tÂ Â Â Â Â 2 ã€å› ä¸ºç©¿å…¥çš„ str_obj æ˜¯Â â€˜He'</span></font><font face="Monaco, Menlo, Consolas, Courier New, monospace" color="#333333"><span style="font-size: 12px;">ã€‘</span></font></font><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â str_length =</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â enc == UTF8 ? str_obj-&gt;Utf8Length() :</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â enc == UCS2 ? str_obj-&gt;Length() * sizeof(uint16_t) : str_obj-&gt;Length();</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â  . . .</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // Can't use StringBytes::Write() in all cases. For example if attempting</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â // to write a two byte character into a one byte Buffer.</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (enc == UTF8) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  //Â <font style="font-size: 12px; color: rgb(51, 51, 51);">strÂ Â Â Â Â node::Utf8Value Â  Â  Â ç±»å‹è½¬æ¢ä¸º c++ å±‚çº§çš„å­—ç¬¦ä¸²å¯¹è±¡</font></span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  //Â <span>Â Â  Â <font style="font-size: 12px; color: rgb(51, 51, 51);">buf_st_ char [1024] "He"Â Â </font></span></span><br/></font></span></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â node::Utf8Value str(env-&gt;isolate(), args[1]);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // å…ˆå¾€ ts_obj_data ä¸­ copy å…¥ 1 ä¸ª He</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memcpy(ts_obj_data + start, *str, MIN(str_length, fill_length));</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }Â </font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  . . .</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">// ä¸‹é¢çš„ goto ç«¯æ¯”è¾ƒæœ‰è¶£</div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"> start_fill:</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (str_length &gt;= fill_length)</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â return;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  // å…·ä½“è¦ copy å¤šå°‘ size_t é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå®æ—¶å˜åŒ–</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â size_t in_there = str_length; // 2</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ç›®å‰å‡†å¤‡ copy çš„èµ·ç‚¹æŒ‡é’ˆ</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â char* ptr = ts_obj_data + start + str_length;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // âœ¨ä¸‹é¢çš„å¾ªç¯å¾ˆæœ‰æ„æ€âœ¨</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  // ç¬¬ä¸€æ¬¡ï¼šin_there:2 | fill_length:20 | ptr: start + 2 | ptr += 2 ==&gt; start + 4 | in_there *= 2 ==&gt; 4 | copy count: 2</span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span><span>Â  // ç¬¬äºŒæ¬¡ï¼šin_there:4 |Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">fill_length:20 | ptr: start + 4 | ptr += 4 ==&gt; start + 8 | in_there *= 2 ==&gt; 8 | copy count: 4</font></span><br/></span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  // ç¬¬ä¸‰æ¬¡ï¼šin_there:8 |Â <font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51);">fill_length:20 | ptr: start + 8 | ptr += 8 ==&gt; start + 16 | in_there *= 2 ==&gt; 16 | copy count: 8</font></span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // åˆ°ç¬¬ä¸‰æ¬¡ç»“æŸä¹‹æ—¶ï¼Œå·²ç» copy äº†ï¼š2ï¼ˆä¸€å¼€å§‹çš„copyï¼‰ + 2 + 4 + 8 = 16 ä¸ªå­—èŠ‚å¤§å°</span><br/></font></span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span><font style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51);"><span>Â  // ç¬¬å››æ¬¡ï¼š16 &lt; ( 20 - 16 = 4 ) å¾ªç¯ç»“æŸ</span><br/></font></span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â while (in_there &lt; fill_length - in_there) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memcpy(ptr, ts_obj_data + start, in_there);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â ptr += in_there;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â in_there *= 2;</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span>Â  // æ­¤æ—¶è¿˜æœ‰ 4 ä¸ª byte ç©ºä½™</span><br/></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><span><span>Â  // in_there: 16 | fill_length: 20 | diff: 4</span><br/></span></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â if (in_there &lt; fill_length) {</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);"><span>Â  Â  // ç›´æ¥æŠŠå‰©ä¸‹çš„ 4 ä¸ª byte copy å®Œæ¯•</span><br/></font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memcpy(ptr, ts_obj_data + start, fill_length - in_there);</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â }</font></div><div style="color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>æœ€ç»ˆå®Œæˆä¸€æ¬¡ string ç±»å‹çš„ fill å·¥ä½œã€‚</div><div><br/></div><div>å…³äº memcpy å‡½æ•°ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">void* memcpy( void *dest, const void *src, size_t count );</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Copies count characters from the object pointed to by src to the object pointed to by dest. Both objects are interpreted as arrays of unsigned char.</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">The behavior is undefined if access occurs beyond the end of the dest array. If the objects overlap (which is a violation of the restrict contract) (since C99), the behavior is undefined. The behavior is undefined if either dest or src is a null pointer.</font><br/></div></div><div><br/></div><div>ç›¸å…³ä¾‹ç¨‹ï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#define __STDC_WANT_LIB_EXT1__ 1</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#include &lt;stdio.h&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#include &lt;stdint.h&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#include &lt;inttypes.h&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#include &lt;string.h&gt;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#include &lt;stdlib.h&gt;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">int main(void)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">{</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // simple usage</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â char source[] = "once upon a midnight dreary...", dest[4];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memcpy(dest, source, sizeof dest);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â for(size_t n = 0; n &lt; sizeof dest; ++n)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â putchar(dest[n]);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // setting effective type of allocated memory to be int</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â int *p = malloc(3*sizeof(int));Â Â Â // allocated memory has no effective type</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â int arr[3] = {1,2,3};</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memcpy(p,arr,3*sizeof(int));Â Â Â Â Â Â // allocated memory now has an effective type</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â // reinterpreting data</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â double d = 0.1;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">//Â Â Â Â int64_t n = *(int64_t*)(&amp;d); // strict aliasing violation</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â int64_t n;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â memcpy(&amp;n, &amp;d, sizeof d); // OK</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â printf("\n%a is %" PRIx64 " as an int64_t\n", d, n);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#ifdef __STDC_LIB_EXT1__</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â set_constraint_handler_s(ignore_handler_s);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â char src[] = "aaaaaaaaaa";</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â char dst[] = "xyxyxyxyxy";</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â int r = memcpy_s(dst,sizeof dst,src,5);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â printf("dst = \"%s\", r = %d\n", dst,r);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â r = memcpy_s(dst,5,src,10);Â Â Â Â Â Â Â Â Â Â Â Â //Â Â count is greater than destszÂ Â </font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â printf("dst = \"");</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â for(size_t ndx=0; ndx&lt;sizeof dst; ++ndx) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â char c = dst[ndx];</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â Â Â Â Â c ? printf("%c", c) : printf("\\0");</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">Â Â Â Â printf("\", r = %d\n", r);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">#endif</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">}</font><br/></div></div><div><br/></div><div>å¯¹åº”è¾“å‡ºï¼š</div><div><br/></div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51);">once</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">0x1.999999999999ap-4 is 3fb999999999999a as an int64_t</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">dst = "aaaaayxyxy", r = 0</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51);">dst = "\0\0\0\0\0yxyxy", r = 22</font><br/></div></div><div><br/></div><div>ä¾‹ç¨‹ä¾¿äºç†è§£ memcpy å‡½æ•°çš„ä½¿ç”¨ã€‚ä¸‹èŠ‚ç»§ç»­åˆ†æ buffer çš„å…¶ä»–ç”¨æ³•ã€‚</div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²å(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>)</p>
<p>æ–‡ç« ä½œè€…ï¼šPooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>æ›´æ–°æ—¥æœŸï¼šMon Dec 26 2016 15:08:52 GMT+0800 (CST)</p>
</div></body></html>