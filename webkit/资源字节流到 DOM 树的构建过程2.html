<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-10-21 09:58:46 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-24 07:28:41 +0000"/><title>资源字节流到 DOM 树的构建过程2</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>资源字节流到 DOM 树的构建过程2</h2>
<p class="title-p">版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p class="title-p">文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>请求的URL：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>http://localhost:8111/sample.html?100</div></div><div><br/></div><div>断点位置：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x00000001070965eb in WebCore::DocumentLoader::dataReceived(WebCore::CachedResource*, char const*, int) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/DocumentLoader.cpp:920</div></div><div><br/></div><div>我们从 DocumentLoader::dataReceived 方法作为入手点来分析，看看此时的调用栈：</div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%AD%97%E8%8A%82%E6%B5%81%E5%88%B0%20DOM%20%E6%A0%91%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B2.resources/EA0928A4-72AB-44DB-9808-A283E082D428.png" height="auto" width="100%"/><br/></div><div><br/></div><div>为了更进一步追寻细节，把断点提前至：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000108b9c382 in WebCore::SubresourceLoader::didReceiveDataOrBuffer(char const*, int, WTF::PassRefPtr&lt;WebCore::SharedBuffer&gt;, long long, WebCore::DataPayloadType) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/SubresourceLoader.cpp:308</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void SubresourceLoader::didReceiveDataOrBuffer(const char* data, int length, PassRefPtr&lt;SharedBuffer&gt; prpBuffer, long long encodedDataLength, DataPayloadType dataPayloadType)</div><div>{</div><div>    // 看下此时的参数切面</div><div>    // this    WebCore::SubresourceLoader *    0x115ff7680    0x0000000115ff7680</div><div>    //     m_resource    WebCore::CachedRawResource *    0x115f53680    0x0000000115f53680</div><div>    // prpBuffer    WTF::PassRefPtr&lt;WebCore::SharedBuffer&gt;  </div><div>    // encodedDataLength    long long    -1</div><div>    // dataPayloadType    WebCore::DataPayloadType    DataPayloadBytes </div><div>    if (m_resource-&gt;response().httpStatusCode() &gt;= 400 &amp;&amp; !m_resource-&gt;shouldIgnoreHTTPStatusCodeErrors())</div><div>        return;</div><div>...</div></div><div><br/></div><div>打印一下 m_resource-&gt;response() ：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>// http://localhost:8111/sample.html?100</div><div>(lldb) print m_resource-&gt;response()</div><div><div>(const WebCore::ResourceResponse) $0 = {</div><div>  WebCore::ResourceResponseBase = {</div><div>    m_isNull = false</div><div>    m_url = {</div><div>      m_string = {</div><div>        m_impl = {</div><div>          m_ptr = 0x0000000122789680</div><div>        }</div><div>      }</div><div>      m_isValid = true</div><div>      m_protocolIsInHTTPFamily = true</div><div>      m_schemeEnd = 4</div><div>      m_userStart = 7</div><div>      m_userEnd = 7</div><div>      m_passwordEnd = 7</div><div>      m_hostEnd = 16</div><div>      m_portEnd = 21</div><div>      m_pathAfterLastSlash = 22</div><div>      m_pathEnd = 33</div><div>      m_queryEnd = 37</div><div>      m_fragmentEnd = 37</div><div>    }</div><div>    m_mimeType = {</div><div>      m_string = {</div><div>        m_impl = {</div><div>          m_ptr = 0x00000001153cc5c0</div><div>        }</div><div>      }</div><div>    }</div><div>    m_expectedContentLength = 605</div><div>    m_textEncodingName = {</div><div>      m_string = {</div><div>        m_impl = {</div><div>          m_ptr = 0x00000001153574e0</div><div>        }</div><div>      }</div><div>    }</div><div>    m_httpStatusText = {</div><div>      m_string = {</div><div>        m_impl = {</div><div>          m_ptr = 0x00000001153a73a8</div><div>        }</div><div>      }</div><div>    }</div><div>    m_httpVersion = {</div><div>      m_string = {</div><div>        m_impl = {</div><div>          m_ptr = 0x0000000115389ac0</div><div>        }</div><div>      }</div><div>    }</div><div>    m_httpHeaderFields = {</div><div>      m_commonHeaders = {</div><div>        m_impl = {</div><div>          m_table = 0x00000001227fe800</div><div>          m_tableSize = 16</div><div>          m_tableSizeMask = 15</div><div>          m_keyCount = 4</div><div>          m_deletedCount = 0</div><div>          m_iterators = 0x0000000000000000</div><div>          m_mutex = {</div><div>            __ptr_ = {</div><div>              std::__1::__libcpp_compressed_pair_imp&lt;WTF::Lock *, std::__1::default_delete&lt;WTF::Lock&gt;, 2&gt; = {</div><div>                __first_ = 0x00000001152b1838</div><div>              }</div><div>            }</div><div>          }</div><div>        }</div><div>      }</div><div>      m_uncommonHeaders = {</div><div>        m_impl = {</div><div>          m_table = 0x0000000000000000</div><div>          m_tableSize = 0</div><div>          m_tableSizeMask = 0</div><div>          m_keyCount = 0</div><div>          m_deletedCount = 0</div><div>          m_iterators = 0x0000000000000000</div><div>          m_mutex = {</div><div>            __ptr_ = {</div><div>              std::__1::__libcpp_compressed_pair_imp&lt;WTF::Lock *, std::__1::default_delete&lt;WTF::Lock&gt;, 2&gt; = {</div><div>                __first_ = 0x00000001152b1840</div><div>              }</div><div>            }</div><div>          }</div><div>        }</div><div>      }</div><div>    }</div><div>    m_resourceLoadTiming = {</div><div>      domainLookupStart = 0</div><div>      domainLookupEnd = 0</div><div>      connectStart = 0</div><div>      connectEnd = 0</div><div>      requestStart = 0</div><div>      responseStart = 1</div><div>      secureConnectionStart = -1</div><div>    }</div><div>    m_includesCertificateInfo = true</div><div>    m_certificateInfo = {</div><div>      m_certificateChain = (m_ptr = 0x0000000000000000)</div></div><div>    }</div><div>    // 状态码</div><div><div>    m_httpStatusCode = 200</div><div>    m_age = {</div><div>      m_isEngaged = false</div><div>      m_value = (__lx = unsigned char [8] @ 0x00007ff202a70660)</div><div>    }</div><div>    m_date = {</div><div>      m_isEngaged = false</div><div>      m_value = (__lx = unsigned char [8] @ 0x00007ff202a70670)</div><div>    }</div><div>    m_expires = {</div><div>      m_isEngaged = false</div><div>      m_value = (__lx = unsigned char [8] @ 0x00007ff202a70680)</div><div>    }</div><div>    m_lastModified = {</div><div>      m_isEngaged = false</div><div>      m_value = (__lx = unsigned char [8] @ 0x00007ff202a70690)</div><div>    }</div><div>    m_contentRange = {</div><div>      m_isValid = false</div><div>      m_firstBytePosition = 0</div><div>      m_lastBytePosition = 0</div><div>      m_instanceLength = 9223372036854775807</div><div>    }</div><div>    m_cacheControlDirectives = {</div><div>      maxAge = {</div><div>        m_isEngaged = false</div><div>        m_value = (__lx = unsigned char [8] @ 0x00007ff202a706c0)</div><div>      }</div><div>      maxStale = {</div><div>        m_isEngaged = false</div><div>        m_value = (__lx = unsigned char [8] @ 0x00007ff202a706d0)</div><div>      }</div><div>      noCache = false</div><div>      noStore = false</div><div>      mustRevalidate = false</div><div>    }</div><div>    m_haveParsedCacheControlHeader = false</div><div>    m_haveParsedAgeHeader = false</div><div>    m_haveParsedDateHeader = false</div><div>    m_haveParsedExpiresHeader = false</div><div>    m_haveParsedLastModifiedHeader = false</div><div>    m_haveParsedContentRangeHeader = false</div><div>    m_source = Network</div><div>  }</div><div>  m_initLevel = 2</div><div>  m_platformResponseIsUpToDate = true</div><div>  m_nsResponse = (m_ptr = 0x0000608000224b80)</div><div>}</div></div></div><div><br/></div><div>
<hr/></div><div><br/></div><div>抓住重点的话，还是从： DocumentLoader::dataReceived 开始：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x00000001070965eb in WebCore::DocumentLoader::dataReceived(WebCore::CachedResource*, char const*, int) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/DocumentLoader.cpp:920</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void DocumentLoader::dataReceived(CachedResource* resource, const char* data, int length)</div><div>{</div><div>    // this    WebDocumentLoaderMac *    0x1165b8d00    0x00000001165b8d00</div><div>    // resource    WebCore::CachedRawResource *    0x115f53680    0x0000000115f53680</div><div>    // data    const char *    "&lt;!DOCTYPE html&gt;\n&lt;html lang=\"en\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;title&gt;Document&lt;/title&gt;\n    &lt;style&gt;\n        .special {\n            width: 100px;\n            height: 100px;\n            background-color: green;\n        }\n        .container {\n            font-size: 20px;\n        }\n    &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;div class=\"special\"&gt;&lt;/div&gt;\n    &lt;div class=\"container\"&gt;\n        &lt;p&gt;我是一个测试的段落&lt;/p&gt;\n    &lt;/div&gt;\n    &lt;script&gt;\n        var special = document.querySelector( '.special' );\n        special.innerHTML = '123';\n        special.style.color = 'white';\n    &lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"    0x000000010f663910</div><div>    // length    int    605</div><div><br/></div><div>// 这里的 context_filtering 究竟是什么含义？不过貌似一般这里都不会直接返回</div><div>// TODO</div><div><div>#if ENABLE(CONTENT_FILTERING)</div><div>    if (m_contentFilter &amp;&amp; !m_contentFilter-&gt;continueAfterDataReceived(resource, data, length))</div><div>        return;</div><div>#endif</div><div><br/></div><div>    ASSERT(data);</div><div>    ASSERT(length);</div></div><div>    ASSERT_UNUSED(resource, resource == m_mainResource);</div><div>    ASSERT(!m_response.isNull());</div><div>...</div><div>    // 记录时间点精确到纳秒</div><div>    // m_timeOfLastDataReceived    double    151448.293205147</div><div>    m_timeOfLastDataReceived = monotonicallyIncreasingTime();</div><div>    </div><div>    // 这个判断是什么？</div><div>    if (!isMultipartReplacingLoad())</div><div>        // 最终走入这里</div><div><div>        commitLoad(data, length);</div><div>}</div></div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x00000001070962eb in WebCore::DocumentLoader::commitLoad(char const*, int) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/DocumentLoader.cpp:819</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void DocumentLoader::commitLoad(const char* data, int length)</div><div>{</div><div>    // this    WebDocumentLoaderMac *    0x1165b8d00    0x00000001165b8d00</div><div>    // data    const char *    "&lt;!DOCTYPE html&gt;\n&lt;html lang=\"en\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;title&gt;Document&lt;/title&gt;\n    &lt;style&gt;\n        .special {\n            width: 100px;\n            height: 100px;\n            background-color: green;\n        }\n        .container {\n            font-size: 20px;\n        }\n    &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;div class=\"special\"&gt;&lt;/div&gt;\n    &lt;div class=\"container\"&gt;\n        &lt;p&gt;我是一个测试的段落&lt;/p&gt;\n    &lt;/div&gt;\n    &lt;script&gt;\n        var special = document.querySelector( '.special' );\n        special.innerHTML = '123';\n        special.style.color = 'white';\n    &lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"    0x000000010f663910</div><div>    // length    int    605</div><div><div>    // Both unloading the old page and parsing the new page may execute JavaScript which destroys the datasource</div><div>    // by starting a new load, so retain temporarily.</div><div>    RefPtr&lt;Frame&gt; protectFrame(m_frame);</div></div><div>    Ref&lt;DocumentLoader&gt; protectLoader(*this);</div><div>    </div><div>    // 在 commitIfReady 函数中，做了关于 PageCache 的工作</div><div><div>    commitIfReady();</div><div>    FrameLoader* frameLoader = DocumentLoader::frameLoader();</div><div>    if (!frameLoader)</div><div>        return;</div><div>#if ENABLE(WEB_ARCHIVE) || ENABLE(MHTML)</div><div>    if (ArchiveFactory::isArchiveMimeType(response().mimeType()))</div><div>        return;</div><div>#endif</div><div>    frameLoader-&gt;client().committedLoad(this, data, length);</div><div><br/></div><div>    if (isMultipartReplacingLoad())</div><div>        frameLoader-&gt;client().didReplaceMultipartContent();</div><div>}</div></div></div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>更新日期：Sat Dec 24 2016 16:00:43 GMT+0800 (CST)</p>
</div></body></html>