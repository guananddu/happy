<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-10-27 10:46:36 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-24 07:40:44 +0000"/><title>资源字节流到 DOM 树的构建过程5 - m_tokenizer.nextToken - 收尾</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>资源字节流到 DOM 树的构建过程5 - m_tokenizer.nextToken - 收尾</h2>
<p class="title-p">版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p class="title-p">文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>
<div>此节分析，从 processEndOfFile 开始：</div>
<div><br/></div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000107685ffb in WebCore::HTMLTreeBuilder::processToken(WebCore::AtomicHTMLToken&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLTreeBuilder.cpp:394</div><div>===</div><div>★ 跳出loop循环：</div><div>#0    0x000000010756e588 in WebCore::HTMLDocumentParser::pumpTokenizer(WebCore::HTMLDocumentParser::SynchronousMode) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLDocumentParser.cpp:282</div><div>...</div><div>    // shouldResume    bool    false 【解析到文件末尾】</div><div>    bool shouldResume = pumpTokenizerLoop(mode, isParsingFragment(), session);</div><div>...</div><div>===</div><div>★ 跳出pumpTokenizer函数：</div><div>#0    0x000000010756eb6f in WebCore::HTMLDocumentParser::resumeParsingAfterYield() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLDocumentParser.cpp:186</div><div>===</div><div>★ 进入prepareToStopParsing：</div><div>#0    0x000000010756ebf8 in WebCore::HTMLDocumentParser::endIfDelayed() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLDocumentParser.cpp:439</div><div>===</div><div>★ 开始准备解析结束：</div><div>#0    0x000000010756df44 in WebCore::HTMLDocumentParser::prepareToStopParsing() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLDocumentParser.cpp:110</div><div>     -&gt;</div><div style="margin-left:40px;">// This kicks off "Once the user agent stops parsing" as described by:</div><div style="margin-left:40px;">// <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-end">https://html.spec.whatwg.org/multipage/syntax.html#the-end</a>【标准】</div><div style="margin-left:40px;">void HTMLDocumentParser::prepareToStopParsing()</div><div style="margin-left:40px;">{</div><div style="margin-left:40px;">    ASSERT(!hasInsertionPoint());</div><div style="margin-left:40px;">    // this    WebCore::HTMLDocumentParser *    0x116592700    0x0000000116592700</div><div style="margin-left:40px;">    // protect    WTF::Ref&lt;WebCore::HTMLDocumentParser&gt;   </div><div style="margin-left:40px;">    // pumpTokenizer can cause this parser to be detached from the Document,</div><div style="margin-left:40px;">    // but we need to ensure it isn't deleted yet.</div><div style="margin-left:40px;">    Ref&lt;HTMLDocumentParser&gt; protect(*this);</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">    // NOTE: This pump should only ever emit buffered character tokens,</div><div style="margin-left:40px;">    // so ForceSynchronous vs. AllowYield should be meaningless.</div><div style="margin-left:40px;">    pumpTokenizerIfPossible(ForceSynchronous);</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">    if (isStopped())</div><div style="margin-left:40px;">        return;</div><div style="margin-left:40px;">    // 标记自身状态为StoppingState</div><div style="margin-left:40px;">    DocumentParser::prepareToStopParsing();</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">    // We will not have a scriptRunner when parsing a DocumentFragment.</div><div style="margin-left:40px;">    if (m_scriptRunner)</div><div style="margin-left:40px;">        // 看下面分析</div><div style="margin-left:40px;">        document()-&gt;setReadyState(Document::Interactive);</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">    // Setting the ready state above can fire mutation event and detach us</div><div style="margin-left:40px;">    // from underneath. In that case, just bail out.</div><div style="margin-left:40px;">    if (isDetached())</div><div style="margin-left:40px;">        return;</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">    attemptToRunDeferredScriptsAndEnd();</div><div style="margin-left:40px;">}</div><div>===</div><div>★ 关于设置readystate状态以及timing时间点记录和相关时间触发：</div><div>#0    0x000000010701593e in WebCore::Document::setReadyState(WebCore::Document::ReadyState) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:1204</div><div><div>void Document::setReadyState(ReadyState readyState)</div><div>{</div><div>    if (readyState == m_readyState)</div><div>        return;</div><div><br/></div><div>#if ENABLE(WEB_TIMING)</div><div>    switch (readyState) {</div><div>    case Loading:</div><div>        if (!m_documentTiming.domLoading)</div><div>            m_documentTiming.domLoading = monotonicallyIncreasingTime();</div><div>        break;</div></div><div>    case Interactive:</div><div>        // readyState    ReadyState    Interactive【设置为Interactive状态】</div><div>        if (!m_documentTiming.domInteractive)</div><div>            // 并且记录时间点</div><div><div>            m_documentTiming.domInteractive = monotonicallyIncreasingTime();</div><div>        break;</div><div>    case Complete:</div><div>        if (!m_documentTiming.domComplete)</div><div>            m_documentTiming.domComplete = monotonicallyIncreasingTime();</div><div>        break;</div><div>    }</div></div><div>#endif     </div><div>    // 设置状态</div><div>    m_readyState = readyState;    </div><div>    // 触发 readystatechange 事件，此事件的触发时机：</div><div>    // The readystatechange event is fired when the readyState attribute of a document has changed. 【附录1】</div><div>    // ★★★【关键节点之一】</div><div>    dispatchEvent(Event::create(eventNames().readystatechangeEvent, false, false));</div><div><br/></div><div>    // 未进入此分支</div><div><div>    if (settings() &amp;&amp; settings()-&gt;suppressesIncrementalRendering())</div><div>        setVisualUpdatesAllowed(readyState);</div><div>}</div></div><div>===</div><div>★ 继续结束逻辑：</div><div>#0    0x0000000107570264 in WebCore::HTMLDocumentParser::end() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLDocumentParser.cpp:401</div><div>#0    0x00000001076908a4 in WebCore::HTMLTreeBuilder::finished() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLTreeBuilder.cpp:2879</div><div>#0    0x0000000107541c10 in WebCore::HTMLConstructionSite::finishedParsing() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/html/parser/HTMLConstructionSite.cpp:403</div><div>#0    0x00000001070294d4 in WebCore::Document::finishedParsing() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:5017【最终走入这里的finishedParsing】</div><div>Document::finishedParsing的函数体见下段：</div><div>===</div></div>
</div><div><br/></div><div>最后进入重头戏部分：WebCore::Document::finishedParsing 函数：</div><div><br/></div><div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000107029597 in WebCore::Document::finishedParsing() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:5022</div><div>===</div><div>★ 设置时间点：</div><div>#if ENABLE(WEB_TIMING)</div><div>    // ★ 关键时间点</div><div><div>    if (!m_documentTiming.domContentLoadedEventStart)</div><div>        m_documentTiming.domContentLoadedEventStart = monotonicallyIncreasingTime();</div><div>#endif</div></div><div>===</div><div>★ 触发 DOMContentLoaded 事件：</div><div>    dispatchEvent(Event::create(eventNames().DOMContentLoadedEvent, true, false));</div><div>===</div><div>★ 设置事件结束时间点：</div><div>#if ENABLE(WEB_TIMING)</div><div>    // ★ 关键时间点</div><div><div>    if (!m_documentTiming.domContentLoadedEventEnd)</div><div>        m_documentTiming.domContentLoadedEventEnd = monotonicallyIncreasingTime();</div><div>#endif</div></div><div>===</div><div>★ 计算Style信息相关：</div><div>...</div><div><div>    if (RefPtr&lt;Frame&gt; f = frame()) {</div><div>        // FrameLoader::finishedParsing() might end up calling Document::implicitClose() if all</div><div>        // resource loads are complete. HTMLObjectElements can start loading their resources from</div><div>        // post attach callbacks triggered by recalcStyle().  This means if we parse out an &lt;object&gt;</div><div>        // tag and then reach the end of the document without updating styles, we might not have yet</div><div>        // started the resource load and might fire the window load event too early.  To avoid this</div><div>        // we force the styles to be up to date before calling FrameLoader::finishedParsing().</div></div><div>        // See https://bugs.webkit.org/show_bug.cgi?id=36864 starting around comment 35.</div><div>        // ★★此函数为TODO；在样式相关章节阐述深究</div><div>        updateStyleIfNeeded();</div><div>        // 进入 WebCore::FrameLoader::finishedParsing</div><div>        // 在此函数的深处会更改Document的ReadyState状态：</div><div>        // m_frame.document()-&gt;setReadyState(Document::Complete)</div><div>        // 当然也会记录domComplete的时间点以及触发ReadyStateChange事件</div><div>        // 主要需要关注的函数</div><div><div>        f-&gt;loader().finishedParsing();</div><div><br/></div><div>        InspectorInstrumentation::domContentLoadedEventFired(*f);</div><div>    }</div></div><div>...</div><div>===</div></div>
</div><div><br/></div><div>有关 FrameLoader::finishedParsing 函数，来看下某一节点的调用栈截图：</div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%AD%97%E8%8A%82%E6%B5%81%E5%88%B0%20DOM%20%E6%A0%91%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B5%20-%20m_tokenizer.nextToken%20-%20%E6%94%B6%E5%B0%BE.resources/C09D9548-2680-4309-AB93-87B3A012EF6F.png" height="auto" width="100%"/><br/></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div/><div>★ 有趣的是 页面的icon实在什么环节开始请求的：</div><div>#0    0x0000000107019de1 in WebCore::Document::implicitClose() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:2716</div><div>...</div><div><div>    // FIXME: We kick off the icon loader when the Document is done parsing.</div><div>    // There are earlier opportunities we could start it:</div><div>    //  -When the &lt;head&gt; finishes parsing</div><div>    //  -When any new HTMLLinkElement is inserted into the document</div><div>    // But those add a dynamic component to the favicon that has UI</div><div>    // ramifications, and we need to decide what is the Right Thing To Do(tm)</div><div>    Frame* f = frame();</div><div>    if (f) {</div><div>        f-&gt;loader().icon().startLoader();</div></div><div>...</div><div>===</div><div>★ 各种pending的dispatching，什么作用呢？</div><div>...</div><div><div>        // FIXME: We shouldn't be dispatching pending events globally on all Documents here.</div><div>        // For now, only do this when there is a Frame, otherwise this could cause JS reentrancy</div><div>        // below SVG font parsing, for example. &lt;https://webkit.org/b/136269</div><div>        ImageLoader::dispatchPendingBeforeLoadEvents();</div><div>        ImageLoader::dispatchPendingLoadEvents();</div><div>        ImageLoader::dispatchPendingErrorEvents();</div><div>        HTMLLinkElement::dispatchPendingLoadEvents();</div><div>        HTMLStyleElement::dispatchPendingLoadEvents();</div></div><div>...</div><div>===</div><div>★ 触发 Load 事件【还需要深究】：</div><div>#2    0x0000000107019e61 in WebCore::Document::implicitClose() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:2735</div><div>#1    0x000000010701e70d in WebCore::Document::dispatchWindowLoadEvent() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:4117</div><div>#0    0x000000010717130d in WebCore::DOMWindow::dispatchLoadEvent() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/page/DOMWindow.cpp:1873</div><div>...</div><div>        DocumentLoadTiming&amp; timing = documentLoader-&gt;timing();</div><div>        timing.markLoadEventStart(); // m_loadEventStart</div><div>        // 触发事件【真的实在这里触发的吗？】</div><div>        dispatchEvent(loadEvent, document());</div><div>        timing.markLoadEventEnd(); // m_loadEventEnd</div><div>...</div><div>===</div><div>★ 与layout相关的逻辑：【专有章节去分析】</div><div>#0    0x000000010701a0d1 in WebCore::Document::implicitClose() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/dom/Document.cpp:2777</div><div>...</div><div><div>    if (!ownerElement() || (ownerElement()-&gt;renderer() &amp;&amp; !ownerElement()-&gt;renderer()-&gt;needsLayout())) {</div><div>        updateStyleIfNeeded();</div><div><br/></div><div>        // Always do a layout after loading if needed.</div><div>        if (view() &amp;&amp; renderView() &amp;&amp; (!renderView()-&gt;firstChild() || renderView()-&gt;needsLayout()))</div><div>            view()-&gt;layout();</div><div>    }</div></div><div>...</div><div>===</div></div><div><br/></div><div>有关DOM树构建结束的细节秒数比较草率，结束时候的细节确实很冗杂，以后逐一分析吧。</div><div><br/></div><div>DOM树的构建到此结束！</div><div><br/></div><div>
<div>
<hr/></div>
<div><br/></div><div>【附录1】</div><div><br/></div>
<div>
<div>★ Example：</div><div><br/></div><div/>
</div>
<div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>// alternative to DOMContentLoaded<br/>
document.onreadystatechange = function () {<br/>
    if (document.readyState == "interactive") {<br/>
        initApplication();<br/>
    }</div><div><div/></div><div>}<br/></div></div></div><div><br/></div><div><br/></div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>更新日期：Sat Dec 24 2016 16:09:09 GMT+0800 (CST)</p>
</div></body></html>