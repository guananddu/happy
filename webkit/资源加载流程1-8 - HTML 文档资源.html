<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-09-19 06:55:19 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-24 07:26:47 +0000"/><title>资源加载流程1-8 - HTML 文档资源</title></head><body><style>
    a { color: #43B0D6 !important; }
    a:visited { color: #7b7ed2 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>资源加载流程1-8 - HTML 文档资源</h2>
<p class="title-p">版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p class="title-p">文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000106bd2d48 in WebCore::CachedResourceLoader::requestResource(WebCore::CachedResource::Type, WebCore::CachedResourceRequest&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/cache/CachedResourceLoader.cpp:609</div></div><div><br/></div><div>走完了这个 case 分支：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>    case Load:</div><div>        if (resource)</div><div>            logMemoryCacheResourceRequest(frame(), DiagnosticLoggingKeys::inMemoryCacheKey(), DiagnosticLoggingKeys::unusedKey());</div><div>        resource = loadResource(type, request);</div><div>        break;</div></div></div><div><br/></div><div>此时 resource 对象已经构建完毕，并且其缓存配置也已经设置好，继续往下，会进入设置 load 的优先级的函数：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void CachedResource::setLoadPriority(const Optional&lt;ResourceLoadPriority&gt;&amp; loadPriority)</div><div>{</div><div>    // this    WebCore::CachedRawResource *    0x115fe9000    0x0000000115fe9000</div><div>    // loadPriority    const WTF::Optional&lt;WebCore::ResourceLoadPriority&gt; &amp;    0x00007fff5fbfaf30</div><div>    //      m_isEngaged    bool    false</div><div>    if (loadPriority)</div><div>        m_loadPriority = loadPriority.value();</div><div>    else</div><div>        // 走入此分支，来设置默认优先级</div><div>        // 因为是文档资源，所以是最高的优先级</div><div>        // m_loadPriority    WebCore::ResourceLoadPriority    VeryHigh</div><div><div>        m_loadPriority = defaultPriorityForResourceType(type());</div><div>}</div></div></div><div><br/></div><div>来看一下整个函数体，从中可以发现，不同的资源，会有不同的加载优先级：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>namespace WebCore {</div><div><br/></div><div>ResourceLoadPriority CachedResource::defaultPriorityForResourceType(Type type)</div></div><div>{</div><div>    // type    Type    MainResource</div><div>    switch (type) {</div><div>    case CachedResource::MainResource:</div><div>        // 所以走入此分支</div><div><div>        return ResourceLoadPriority::VeryHigh;</div><div>    case CachedResource::CSSStyleSheet:</div><div>        return ResourceLoadPriority::High;</div><div>    case CachedResource::Script:</div><div>#if ENABLE(SVG_FONTS)</div><div>    case CachedResource::SVGFontResource:</div><div>#endif</div><div>    case CachedResource::MediaResource:</div><div>    case CachedResource::FontResource:</div><div>    case CachedResource::RawResource:</div><div>        return ResourceLoadPriority::Medium;</div><div>    case CachedResource::ImageResource:</div><div>        return ResourceLoadPriority::Low;</div><div>#if ENABLE(XSLT)</div><div>    case CachedResource::XSLStyleSheet:</div><div>        return ResourceLoadPriority::High;</div><div>#endif</div><div>    case CachedResource::SVGDocumentResource:</div><div>        return ResourceLoadPriority::Low;</div><div>    case CachedResource::LinkPreload:</div><div>        return ResourceLoadPriority::Low;</div><div>#if ENABLE(LINK_PREFETCH)</div><div>    case CachedResource::LinkPrefetch:</div><div>        return ResourceLoadPriority::VeryLow;</div><div>    case CachedResource::LinkSubresource:</div><div>        return ResourceLoadPriority::VeryLow;</div><div>#endif</div><div>#if ENABLE(VIDEO_TRACK)</div><div>    case CachedResource::TextTrackResource:</div><div>        return ResourceLoadPriority::Low;</div><div>#endif</div><div>    }</div><div>    ASSERT_NOT_REACHED();</div><div>    return ResourceLoadPriority::Low;</div><div>}</div></div></div><div><br/></div><div>接下来走入此分支：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    if ((policy != Use || resource-&gt;stillNeedsLoad()) &amp;&amp; CachedResourceRequest::NoDefer == request.defer()) {</div><div>        // request.defer() =&gt; CachedResourceRequest::NoDefer</div><div>        // 走入这个巨长无比的函数见下方</div><div><div>        resource-&gt;load(*this, request.options());</div><div><br/></div><div>        // We don't support immediate loads, but we do support immediate failure.</div><div>        if (resource-&gt;errorOccurred()) {</div><div>            if (resource-&gt;allowsCaching() &amp;&amp; resource-&gt;inCache())</div><div>                memoryCache.remove(*resource);</div><div>            return nullptr;</div><div>        }</div><div>    }</div></div></div><div><br/></div><div>进入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000106bc29fb in WebCore::CachedResource::load(WebCore::CachedResourceLoader&amp;, WebCore::ResourceLoaderOptions const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/cache/CachedResource.cpp:214</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void CachedResource::load(CachedResourceLoader&amp; cachedResourceLoader, const ResourceLoaderOptions&amp; options)</div><div>{</div><div>    // this    WebCore::CachedRawResource *    0x115fe9000    0x0000000115fe9000</div><div>    // cachedResourceLoader    WebCore::CachedResourceLoader &amp;    0x00000001155e78c0</div><div>    // options    const WebCore::ResourceLoaderOptions &amp;    0x00007fff5fbfaf28</div><div>    //      m_cachingPolicy    WebCore::CachingPolicy    AllowCaching</div><div>    //      m_defersLoadingPolicy    WebCore::DefersLoadingPolicy    AllowDefersLoading</div><div>    //      ...</div><div>    // frameLoader    WebCore::FrameLoader &amp;    0x00007fff5fbfa640</div><div>    // request    WebCore::ResourceRequest   </div><div><div>    if (!cachedResourceLoader.frame()) {</div><div>        failBeforeStarting();</div><div>        return;</div></div><div>    }</div><div>...</div></div><div><br/></div><div>options 截图：</div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B1-8%20-%20HTML%20%E6%96%87%E6%A1%A3%E8%B5%84%E6%BA%90.resources/26CCA349-4179-4B47-92B0-6219ACEA1BB5.png" height="auto" width="100%"/><br/></div><div><br/></div><div>设置好 CachedResource 的 m_options，以及 标识 m_loading == true，然后设置优先级：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>m_resourceRequest.setPriority(loadPriority()); // 仍旧是之前设置好的 VeryHigh</div></div><div><br/></div><div>最终走入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    // this    WebCore::CachedRawResource *    0x115fe9000    0x0000000115fe9000 </div><div>    m_loader = platformStrategies()-&gt;loaderStrategy()-&gt;loadResource(cachedResourceLoader.frame(), this, request, options);</div><div><div>    if (!m_loader) {</div><div>        failBeforeStarting();</div><div>        return;</div></div><div>    }</div><div>    // 设置自己的状态为 Pending</div><div>    m_status = Pending;</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>class CachedResource {</div><div>...</div><div>    // 状态枚举类</div><div>    enum Status {</div><div><div>        Unknown,      // let cache decide what to do with it</div><div>        Pending,      // only partially loaded</div><div>        Cached,       // regular case</div><div>        LoadError,</div><div>        DecodeError</div></div><div>    };</div><div>...</div></div><div><br/></div><hr/><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>namespace WebCore {</div><div><br/></div><div>// 静态类</div><div><div>static PlatformStrategies* s_platformStrategies;</div><div><br/></div><div>PlatformStrategies* platformStrategies()</div><div>{</div><div>    ASSERT(s_platformStrategies);</div><div><br/></div><div>    return s_platformStrategies;</div></div><div>}</div><div>...</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000106bc6004 in WebCore::PlatformStrategies::loaderStrategy() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/platform/PlatformStrategies.h:50</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    LoaderStrategy* loaderStrategy()</div><div>    {</div><div>        // this    WebPlatformStrategies *    0x600000089650    0x0000600000089650</div><div>        // m_cookiesStrategy    WebCore::CookiesStrategy *    NULL    0x0000000000000000</div><div>        // m_loaderStrategy    WebResourceLoadScheduler *    0x1155ef300    0x00000001155ef300</div><div>        // m_pasteboardStrategy    WebCore::PasteboardStrategy *    NULL    0x0000000000000000</div><div>        // m_pluginStrategy    WebPlatformStrategies *    0x600000089650    0x0000600000089650</div><div>        // m_blobRegistry    WebCore::BlobRegistry *    NULL    0x0000000000000000</div><div><div>        if (!m_loaderStrategy)</div><div>            m_loaderStrategy = createLoaderStrategy();</div><div>        return m_loaderStrategy;</div><div>    }</div></div></div><div><br/></div><div>接下来，最终走入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000102e80763 in WebResourceLoadScheduler::loadResource(WebCore::Frame*, WebCore::CachedResource*, WebCore::ResourceRequest const&amp;, WebCore::ResourceLoaderOptions const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebKit/WebCoreSupport/WebResourceLoadScheduler.cpp:97</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>RefPtr&lt;SubresourceLoader&gt; WebResourceLoadScheduler::loadResource(Frame* frame, CachedResource* resource, const ResourceRequest&amp; request, const ResourceLoaderOptions&amp; options)</div><div>{</div><div>    // this    WebResourceLoadScheduler *    0x1155ef300    0x00000001155ef300</div><div>    // frame    WebCore::MainFrame *    0x1155dfc00    0x00000001155dfc00</div><div>    // resource    WebCore::CachedRawResource *    0x115fe9000    0x0000000115fe9000</div><div>    // request    const WebCore::ResourceRequest &amp;    0x00007fff5fbfa4d0</div><div>    // options    const WebCore::ResourceLoaderOptions &amp;    0x00007fff5fbfaf28</div><div>    // loader    WTF::RefPtr&lt;WebCore::SubresourceLoader&gt;   </div><div><div>    RefPtr&lt;SubresourceLoader&gt; loader = SubresourceLoader::create(frame, resource, request, options);</div><div>    if (loader)</div><div>        scheduleLoad(loader.get());</div><div>#if PLATFORM(IOS)</div><div>    // Since we defer loader initialization until scheduling on iOS, the frame</div><div>    // load delegate that would be called in SubresourceLoader::create() on</div><div>    // other ports might be called in scheduleLoad() instead. Our contract to</div><div>    // callers of this method is that a null loader is returned if the load was</div><div>    // cancelled by a frame load delegate.</div><div>    if (!loader || loader-&gt;reachedTerminalState())</div><div>        return nullptr;</div><div>#endif</div><div>    return loader;</div></div><div>}</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000108b9afa4 in WebCore::SubresourceLoader::create(WebCore::Frame*, WebCore::CachedResource*, WebCore::ResourceRequest const&amp;, WebCore::ResourceLoaderOptions const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/SubresourceLoader.cpp:102</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>RefPtr&lt;SubresourceLoader&gt; SubresourceLoader::create(Frame* frame, CachedResource* resource, const ResourceRequest&amp; request, const ResourceLoaderOptions&amp; options)</div><div>{</div><div>    // frame    WebCore::MainFrame *    0x1155dfc00    0x00000001155dfc00</div><div>    // resource    WebCore::CachedRawResource *    0x115fe9000    0x0000000115fe9000</div><div>    // request    const WebCore::ResourceRequest &amp;    0x00007fff5fbfa4d0</div><div>    // options    const WebCore::ResourceLoaderOptions &amp;    0x00007fff5fbfaf28</div><div>    // subloader    WTF::RefPtr&lt;WebCore::SubresourceLoader&gt;  </div><div>    // 创建好 SubresourceLoader 对象 </div><div><div>    RefPtr&lt;SubresourceLoader&gt; subloader(adoptRef(new SubresourceLoader(frame, resource, options)));</div><div>#if PLATFORM(IOS)</div><div>    if (!IOSApplication::isWebProcess()) {</div><div>        // On iOS, do not invoke synchronous resource load delegates while resource load scheduling</div><div>        // is disabled to avoid re-entering style selection from a different thread (see &lt;rdar://problem/9121719&gt;).</div><div>        // FIXME: This should be fixed for all ports in &lt;https://bugs.webkit.org/show_bug.cgi?id=56647&gt;.</div><div>        subloader-&gt;m_iOSOriginalRequest = request;</div><div>        return subloader.release();</div><div>    }</div><div>#endif</div><div>    if (!subloader-&gt;init(request))</div><div>        return nullptr;</div><div>    return subloader;</div></div><div>}</div></div><div><br/></div><div>调入其构造函数，创建一个 SubresourceLoader：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000108b9ad7d in WebCore::SubresourceLoader::SubresourceLoader(WebCore::Frame*, WebCore::CachedResource*, WebCore::ResourceLoaderOptions const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/SubresourceLoader.cpp:89</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>SubresourceLoader::SubresourceLoader(Frame* frame, CachedResource* resource, const ResourceLoaderOptions&amp; options)</div><div>    : ResourceLoader(frame, options)</div><div>    , m_resource(resource)</div><div>    , m_loadingMultipartContent(false)</div><div>    , m_state(Uninitialized)</div><div>    , m_requestCountTracker(std::make_unique&lt;RequestCountTracker&gt;(frame-&gt;document()-&gt;cachedResourceLoader(), resource))</div><div>{</div><div>#ifndef NDEBUG</div><div>    subresourceLoaderCounter.increment();</div><div>#endif</div><div>#if ENABLE(CONTENT_EXTENSIONS)</div><div>    m_resourceType = toResourceType(resource-&gt;type());</div><div>#endif</div><div>}</div></div></div><div><br/></div><div>使用 ResourceRequest 来初始化：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000108b9b064 in WebCore::SubresourceLoader::init(WebCore::ResourceRequest const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/SubresourceLoader.cpp:144</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>bool SubresourceLoader::init(const ResourceRequest&amp; request)</div><div>{    </div><div>    // this    WebCore::SubresourceLoader *    0x115ff5580    0x0000000115ff5580</div><div>    // request    const WebCore::ResourceRequest &amp;    0x00007fff5fbfa4d0</div><div>    // 操！调不到尽头了！</div><div><div>    if (!ResourceLoader::init(request))</div><div>        return false;</div><div><br/></div><div>    ASSERT(!reachedTerminalState());</div><div>    m_state = Initialized;</div><div>    m_documentLoader-&gt;addSubresourceLoader(this);</div><div><br/></div><div>    // FIXME: https://bugs.webkit.org/show_bug.cgi?id=155633.</div><div>    // SubresourceLoader could use the document origin as a default and set PotentiallyCrossOriginEnabled requests accordingly.</div><div>    // This would simplify resource loader users as they would only need to set the policy to PotentiallyCrossOriginEnabled.</div><div>    if (options().requestOriginPolicy() == PotentiallyCrossOriginEnabled)</div><div>        m_origin = SecurityOrigin::createFromString(request.httpOrigin());</div><div><br/></div><div>    return true;</div></div><div>}</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x000000010881d86f in WebCore::ResourceLoader::init(WebCore::ResourceRequest const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/ResourceLoader.cpp:137</div></div><div><br/></div><div>进入上述 WebCore::ResourceLoader::init 函数的细节：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>this    WebCore::SubresourceLoader *    0x115ff5580    0x0000000115ff5580</div><div>     m_defersLoading    bool    false</div><div>r    const WebCore::ResourceRequest &amp;    0x00007fff5fbfa4d0</div><div>clientRequest    WebCore::ResourceRequest    </div></div><div><br/></div><div>进入 willSendRequest 函数：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000108b9b21b in WebCore::SubresourceLoader::willSendRequestInternal(WebCore::ResourceRequest&amp;, WebCore::ResourceResponse const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/SubresourceLoader.cpp:168</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void SubresourceLoader::willSendRequestInternal(ResourceRequest&amp; newRequest, const ResourceResponse&amp; redirectResponse)</div><div>{</div><div>    // this    WebCore::SubresourceLoader *    0x115ff5580    0x0000000115ff5580</div><div>    // newRequest    WebCore::ResourceRequest &amp;    0x00007fff5fbfa008</div><div>    // redirectResponse    const WebCore::ResourceResponse &amp;    0x00007fff5fbfa130</div><div>    // previousURL    WebCore::URL  </div><div>    //      m_ptr    WTF::StringImpl *    NULL    0x0000000000000000 </div><div>    // protect    WTF::Ref&lt;WebCore::SubresourceLoader&gt;     </div><div>    // Store the previous URL because the call to ResourceLoader::willSendRequest will modify it.</div><div>    URL previousURL = request().url();</div><div>    Ref&lt;SubresourceLoader&gt; protect(*this);</div><div>...</div></div><div><br/></div><div>最后又调入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x000000010881e6ff in WebCore::ResourceLoader::willSendRequestInternal(WebCore::ResourceRequest&amp;, WebCore::ResourceResponse const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/ResourceLoader.cpp:331</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>void ResourceLoader::willSendRequestInternal(ResourceRequest&amp; request, const ResourceResponse&amp; redirectResponse)</div><div>{</div><div>    // Protect this in this delegate method since the additional processing can do</div><div>    // anything including possibly derefing this; one example of this is Radar 3266216.</div><div>    Ref&lt;ResourceLoader&gt; protect(*this);</div><div><br/></div><div>    ASSERT(!m_reachedTerminalState);</div><div>#if ENABLE(CONTENT_EXTENSIONS)</div><div>    ASSERT(m_resourceType != ResourceType::Invalid);</div><div>#endif</div><div><br/></div><div>    // We need a resource identifier for all requests, even if FrameLoader is never going to see it (such as with CORS preflight requests).</div><div>    bool createdResourceIdentifier = false;</div></div><div>    if (!m_identifier) {</div><div>        // 创建一个标识符</div><div>        // 创建完毕后：m_identifier    unsigned long    1</div><div><div>        m_identifier = m_frame-&gt;page()-&gt;progress().createUniqueIdentifier();</div><div>        createdResourceIdentifier = true;</div></div><div>    }</div><div>...</div></div><div><br/></div><div>在此方法体内，会向上游（client）发送各种通知事件，并且会通知 inspector：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>    if (m_options.sendLoadCallbacks() == SendCallbacks) {</div><div>        if (createdResourceIdentifier)</div><div>            frameLoader()-&gt;notifier().assignIdentifierToInitialRequest(m_identifier, documentLoader(), request);</div><div><br/></div><div>#if PLATFORM(IOS)</div><div>        // If this ResourceLoader was stopped as a result of assignIdentifierToInitialRequest, bail out</div><div>        if (m_reachedTerminalState)</div><div>            return;</div><div>#endif</div><div><br/></div><div>        frameLoader()-&gt;notifier().willSendRequest(this, request, redirectResponse);</div><div>    }</div></div></div><div><br/></div><div>在此方法体内，也会处理 redirect ？TODO</div><div>记录调用栈截图：</div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B1-8%20-%20HTML%20%E6%96%87%E6%A1%A3%E8%B5%84%E6%BA%90.resources/B24A2496-FCC0-4873-8D6A-2D78DDDE450D.png" height="auto" width="100%"/><br/></div><div><br/></div><hr/><div><br/></div><div>直至回退至：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#1    0x0000000108b9b0fd in WebCore::SubresourceLoader::init(WebCore::ResourceRequest const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/SubresourceLoader.cpp:149</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>m_documentLoader-&gt;addSubresourceLoader(this);</div><div>// 此句将初始化成功的 subresourceloader 对象，添加至对应的 documentloader</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000107098454 in WebCore::DocumentLoader::addSubresourceLoader(WebCore::ResourceLoader*) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/DocumentLoader.cpp:1390</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void DocumentLoader::addSubresourceLoader(ResourceLoader* loader)</div><div>{   </div><div>    // this    WebDocumentLoaderMac *    0x1165f0a00    0x00000001165f0a00</div><div>    // loader    WebCore::SubresourceLoader *    0x115ff5580    0x0000000115ff5580</div><div>    // m_gotFirstByte    bool    false</div><div><div>    // The main resource's underlying ResourceLoader will ask to be added here.</div><div>    // It is much simpler to handle special casing of main resource loads if we don't</div><div>    // let it be added. In the main resource load case, mainResourceLoader()</div><div>    // will still be null at this point, but m_gotFirstByte should be false here if and only</div><div>    // if we are just starting the main resource load.</div></div><div>    if (!m_gotFirstByte)</div><div>        // 从这里跳出了！！！因为这是 Main resource的加载！！！</div><div><div>        return;</div><div>    ASSERT(loader-&gt;identifier());</div><div>    ASSERT(!m_subresourceLoaders.contains(loader-&gt;identifier()));</div><div>    ASSERT(!mainResourceLoader() || mainResourceLoader() != loader);</div><div><br/></div><div>    // A page in the PageCache should not be able to start loads.</div><div>    ASSERT_WITH_SECURITY_IMPLICATION(!document() || !document()-&gt;inPageCache());</div><div><br/></div><div>    m_subresourceLoaders.add(loader-&gt;identifier(), loader);</div><div>}</div></div></div><div><br/></div><hr/><div><br/></div><div>最终回退至：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000102e807ae in WebResourceLoadScheduler::loadResource(WebCore::Frame*, WebCore::CachedResource*, WebCore::ResourceRequest const&amp;, WebCore::ResourceLoaderOptions const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebKit/WebCoreSupport/WebResourceLoadScheduler.cpp:99</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>RefPtr&lt;SubresourceLoader&gt; WebResourceLoadScheduler::loadResource(Frame* frame, CachedResource* resource, const ResourceRequest&amp; request, const ResourceLoaderOptions&amp; options)</div><div>{</div><div>    RefPtr&lt;SubresourceLoader&gt; loader = SubresourceLoader::create(frame, resource, request, options);</div></div><div>    if (loader)</div><div>        // 重点函数</div><div>        scheduleLoad(loader.get());</div><div>...</div></div><div><br/></div><div>scheduleLoad 函数体很长，调重点说明：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>this    WebResourceLoadScheduler *    0x1155ef300    0x00000001155ef300</div><div>resourceLoader    WebCore::SubresourceLoader *    0x115ff5580    0x0000000115ff5580</div><div>host    WebResourceLoadScheduler::HostInformation *    NULL    0x0000000000000000</div><div>priority    WebCore::ResourceLoadPriority    VeryHigh</div><div>hadRequests    bool    false</div></div><div><br/></div><div>通过 hostForUrl 初始化 host 信息：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000102e802ca in WebResourceLoadScheduler::hostForURL(WebCore::URL const&amp;, WebResourceLoadScheduler::CreateHostPolicy) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebKit/WebCoreSupport/WebResourceLoadScheduler.cpp:69</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>WebResourceLoadScheduler::HostInformation* WebResourceLoadScheduler::hostForURL(const URL&amp; url, CreateHostPolicy createHostPolicy)</div><div>{</div><div>    // this    WebResourceLoadScheduler *    0x1155ef300    0x00000001155ef300</div><div>    // url    const WebCore::URL &amp;    0x0000000115f95cb0</div><div>    // createHostPolicy    CreateHostPolicy    CreateIfNotFound</div><div>    // hostName    WTF::String  </div><div>    //      m_data8    const LChar *    "localhost"    0x000000012285db54</div><div>    // host    WebResourceLoadScheduler::HostInformation *    0x11553f300    0x000000011553f300 </div><div>    if (!url.protocolIsInHTTPFamily())</div><div>        return m_nonHTTPProtocolHost;</div><div>    // 字面翻译的话，就是检查一致性，m_hosts 是一个</div><div>    // this    const WTF::HashMap&lt;WTF::String, WebResourceLoadScheduler::HostInformation *, WTF::StringHash, WTF::HashTraits&lt;WTF::String&gt;, WTF::HashTraits&lt;WebResourceLoadScheduler::HostInformation *&gt; &gt; *    0x1155ef308    0x00000001155ef308</div><div><div>    m_hosts.checkConsistency();</div><div>    String hostName = url.host();</div><div>    HostInformation* host = m_hosts.get(hostName);</div></div><div>    if (!host &amp;&amp; createHostPolicy == CreateIfNotFound) {</div><div>        // 会进入此分支，创建一个新的 HostInformation 对象</div><div>        // Match the parallel connection count used by the networking layer.</div><div>        // static unsigned maxRequestsInFlightPerHost; 10000</div><div>        host = new HostInformation(hostName, maxRequestsInFlightPerHost);</div><div>        // 放入 HashMap</div><div><div>        m_hosts.add(hostName, host);</div><div>    }</div><div>    return host;</div><div>}</div></div></div><div><br/></div><div>新创建的 HostInformation 信息截图（进入构造函数以后的截图）：</div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B1-8%20-%20HTML%20%E6%96%87%E6%A1%A3%E8%B5%84%E6%BA%90.resources/870894CC-1735-4FDE-8289-A60951AD81A9.png" height="auto" width="100%"/><br/></div><div><br/></div><div>相关类型定义：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>    typedef HashMap&lt;String, HostInformation*, StringHash&gt; HostMap;</div><div>    HostMap m_hosts;</div></div></div><div><br/></div><hr/><div><br/></div><div>进入 host-&gt;schedule(resourceLoader, priority); 的逻辑：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000102e80c77 in WebResourceLoadScheduler::HostInformation::schedule(WebCore::ResourceLoader*, WebCore::ResourceLoadPriority) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebKit/WebCoreSupport/WebResourceLoadScheduler.cpp:336</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void WebResourceLoadScheduler::HostInformation::schedule(ResourceLoader* resourceLoader, ResourceLoadPriority priority)</div><div>{    </div><div>    // this    WebResourceLoadScheduler::HostInformation *    0x115549a00    0x0000000115549a00</div><div>    // resourceLoader    WebCore::SubresourceLoader *    0x115ff5b00    0x0000000115ff5b00</div><div>    // priority    WebCore::ResourceLoadPriority    VeryHigh</div><div>    // m_requestsPending    std::__1::array&lt;WTF::Deque&lt;WTF::RefPtr&lt;WebCore::ResourceLoader&gt;, 0&gt;, 5&gt;   数组？</div><div>    // 根据优先级获得 priorityToIndex(priority) 值为 4，并且将 loader append 进入</div><div>    m_requestsPending[priorityToIndex(priority)].append(resourceLoader);</div><div>}</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>unsigned WebResourceLoadScheduler::HostInformation::priorityToIndex(ResourceLoadPriority priority)</div><div>{</div><div>    // priority    WebCore::ResourceLoadPriority    VeryHigh</div><div>    // 通过请求的优先级，来确定 index</div><div><div>    switch (priority) {</div><div>    case ResourceLoadPriority::VeryLow:</div><div>        return 0;</div><div>    case ResourceLoadPriority::Low:</div><div>        return 1;</div><div>    case ResourceLoadPriority::Medium:</div><div>        return 2;</div><div>    case ResourceLoadPriority::High:</div></div><div>        return 3;</div><div>    // here</div><div><div>    case ResourceLoadPriority::VeryHigh:</div><div>        return 4;</div><div>    }</div><div>    ASSERT_NOT_REACHED();</div><div>    return 0;</div><div>}</div></div></div><div><br/></div><hr/><div><br/></div><div>走入分支，开始发球！：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#if PLATFORM(COCOA) || USE(CFNETWORK)</div><div>    // Mac 平台下第一个条件默认返回 true</div><div>     /*</div><div style="margin-left:40px;">bool isSuspendingPendingRequests() const { </div><div style="margin-left:40px;">    // 刚开始 m_suspendPendingRequestsCount == 0</div><div style="margin-left:40px;">    return !!m_suspendPendingRequestsCount; </div><div style="margin-left:40px;">}</div><div style="margin-left:40px;">*/</div><div>    if (ResourceRequest::resourcePrioritiesEnabled() &amp;&amp; !isSuspendingPendingRequests()) {</div><div>        // 走入分支</div><div>        // Serve all requests at once to keep the pipeline full at the network layer.</div><div>        // FIXME: Does this code do anything useful, given that we also set maxRequestsInFlightPerHost to effectively unlimited on these platforms?</div><div>        // 见下</div><div><div>        servePendingRequests(host, ResourceLoadPriority::VeryLow);</div><div>        return;</div><div>    }</div><div>#endif</div></div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000102e80cd6 in WebResourceLoadScheduler::servePendingRequests(WebResourceLoadScheduler::HostInformation*, WebCore::ResourceLoadPriority) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebKit/WebCoreSupport/WebResourceLoadScheduler.cpp:245</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>void WebResourceLoadScheduler::servePendingRequests(HostInformation* host, ResourceLoadPriority minimumPriority)</div><div>{</div></div><div>    LOG(ResourceLoading, "WebResourceLoadScheduler::servePendingRequests HostInformation.m_name='%s'", host-&gt;name().latin1().data());</div><div>    // this    WebResourceLoadScheduler *    0x1155ef300    0x00000001155ef300</div><div>    // host    WebResourceLoadScheduler::HostInformation *    0x115549a00    0x0000000115549a00</div><div>    //      m_name    const WTF::String  </div><div>    //      m_data8    const LChar *    "localhost"    0x00000001155166f4</div><div>    // minimumPriority    WebCore::ResourceLoadPriority    VeryLow</div><div>    // priority    WebCore::ResourceLoadPriority    VeryHigh</div><div>    // requestsPending    WTF::Deque&lt;WTF::RefPtr&lt;WebCore::ResourceLoader&gt;, 0&gt; &amp;    0x0000000102e80cae </div><div>    auto priority = ResourceLoadPriority::Highest;</div><div>    while (true) {</div><div>        // requestsPending    WTF::Deque&lt;WTF::RefPtr&lt;WebCore::ResourceLoader&gt;, 0&gt; &amp;    0x0000000115549aa0</div><div>        auto&amp; requestsPending = host-&gt;requestsPending(priority);</div><div>        // 之前已经 append 一个 host 了</div><div>        while (!requestsPending.isEmpty()) {</div><div>            // 获取 resourceLoader</div><div><div>            RefPtr&lt;ResourceLoader&gt; resourceLoader = requestsPending.first();</div><div><br/></div><div>            // For named hosts - which are only http(s) hosts - we should always enforce the connection limit.</div><div>            // For non-named hosts - everything but http(s) - we should only enforce the limit if the document isn't done parsing</div></div><div>            // and we don't know all stylesheets yet.</div><div>            // document    WebCore::HTMLDocument *    0x1165f7600    0x00000001165f7600</div><div>            Document* document = resourceLoader-&gt;frameLoader() ? resourceLoader-&gt;frameLoader()-&gt;frame().document() : 0;</div><div>            // host-&gt;name() === "localhost"</div><div>            // shouldLimitRequests    bool    true</div><div>            bool shouldLimitRequests = !host-&gt;name().isNull() || (document &amp;&amp; (document-&gt;parsing() || !document-&gt;haveStylesheetsLoaded()));</div><div>            // 返回 false，后者判断应该是确定是不是超限</div><div>            if (shouldLimitRequests &amp;&amp; host-&gt;limitRequests(priority))</div><div>                return;</div><div>            // 移除掉当前的处理项</div><div>            requestsPending.removeFirst();</div><div>            // 从 Pending -&gt; Loading 的转变</div><div>            // m_requestsLoading.add(resourceLoader);</div><div>            // 下面的函数内：</div><div>            // this    WebResourceLoadScheduler::HostInformation * 0x115549a00 0x0000000115549a00</div><div>            // resourceLoader    WebCore::SubresourceLoader *    0x115ff5b00    0x0000000115ff5b00</div><div>            // m_requestsLoading    WebResourceLoadScheduler::HostInformation::RequestMap   </div><div><div>            host-&gt;addLoadInProgress(resourceLoader.get());</div><div>#if PLATFORM(IOS)</div><div>            if (!IOSApplication::isWebProcess()) {</div><div>                resourceLoader-&gt;startLoading();</div><div>                return;</div><div>            }</div></div><div>#endif</div><div>            // 最终调入这里</div><div><div>            resourceLoader-&gt;start();</div><div>        }</div><div>        if (priority == minimumPriority)</div><div>            return;</div><div>        --priority;</div><div>    }</div><div>}</div></div></div><div><br/></div><div>
<hr/></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x000000010881dce4 in WebCore::ResourceLoader::start() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/ResourceLoader.cpp:192</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>void ResourceLoader::start()</div><div>{</div><div>    // this    WebCore::SubresourceLoader *    0x115ff5b00    0x0000000115ff5b00</div><div>    //      m_state    WebCore::SubresourceLoader::SubresourceLoaderState    Initialized</div><div><div>    ASSERT(!m_handle);</div><div>    ASSERT(!m_request.isNull());</div><div>    ASSERT(m_deferredRequest.isNull());</div></div><div>    ASSERT(frameLoader());</div><div>...</div></div><div><br/></div><div>ResourceLoader::start() 函数中有一系列的判断，其中下面的语句，判断是不是一个 data url：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>    if (m_request.url().protocolIsData()) {</div><div>        loadDataURL();</div><div>        return;</div></div><div>    }</div></div><div><br/></div><div>最终进入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    m_handle = ResourceHandle::create(frameLoader()-&gt;networkingContext(), m_request, this, m_defersLoading, m_options.sniffContent() == SniffContent);</div><div>    // m_handle    WTF::RefPtr&lt;WebCore::ResourceHandle&gt;   </div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x00000001088102cb in WebCore::ResourceHandle::create(WebCore::NetworkingContext*, WebCore::ResourceRequest const&amp;, WebCore::ResourceHandleClient*, bool, bool) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/platform/network/ResourceHandle.cpp:90</div></div><div><br/></div><div>查看下此时的调用栈：</div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B1-8%20-%20HTML%20%E6%96%87%E6%A1%A3%E8%B5%84%E6%BA%90.resources/D2E19DF5-7A31-4214-8272-0202BC6BBBCA.png" height="auto" width="100%"/><br/></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>PassRefPtr&lt;ResourceHandle&gt; ResourceHandle::create(NetworkingContext* context, const ResourceRequest&amp; request, ResourceHandleClient* client, bool defersLoading, bool shouldContentSniff)</div><div>{</div><div>    // context    WebFrameNetworkingContext *    0x1155a71c8    0x00000001155a71c8</div><div>    // request    const WebCore::ResourceRequest &amp;    0x0000000115ff5cb0</div><div>    // client    WebCore::SubresourceLoader *    0x115ff5b00    0x0000000115ff5b00</div><div>    // defersLoading    bool    false</div><div>    // shouldContentSniff    bool    true</div><div>    // protocolMapItem    WTF::HashMap&lt;WTF::AtomicString, WTF::RefPtr&lt;WebCore::ResourceHandle&gt; (*)(const WebCore::ResourceRequest &amp;, WebCore::ResourceHandleClient *), WTF::AtomicStringHash, WTF::HashTraits&lt;WTF::AtomicString&gt;, WTF::HashTraits&lt;WTF::RefPtr&lt;WebCore::ResourceHandle&gt; (*)(const WebCore::ResourceRequest &amp;, WebCore::ResourceHandleClient *)&gt; &gt;::iterator  </div><div>    // newHandle    WTF::RefPtr&lt;WebCore::ResourceHandle&gt;    </div><div> </div><div>    BuiltinResourceHandleConstructorMap::iterator protocolMapItem = builtinResourceHandleConstructorMap().find(request.url().protocol());</div><div>    // 此判断跳过</div><div>    if (protocolMapItem != builtinResourceHandleConstructorMap().end())</div><div>        return protocolMapItem-&gt;value(request, client);</div><div>    // 根据已有参数，再次创建 newHandle</div><div>    RefPtr&lt;ResourceHandle&gt; newHandle(adoptRef(new ResourceHandle(context, request, client, defersLoading, shouldContentSniff)));</div><div>    </div><div>    // newHandle    WTF::RefPtr&lt;WebCore::ResourceHandle&gt;  </div><div>    // d    std::__1::unique_ptr&lt;WebCore::ResourceHandleInternal, std::__1::default_delete&lt;WebCore::ResourceHandleInternal&gt; &gt;    </div><div>    // m_scheduledFailureType    FailureType    NoFailure </div><div>    if (newHandle-&gt;d-&gt;m_scheduledFailureType != NoFailure)</div><div>        return newHandle.release();</div><div>    // 最终调入这里</div><div><div>    if (newHandle-&gt;start())</div><div>        return newHandle.release();</div><div><br/></div><div>    return 0;</div><div>}</div></div></div><div><br/></div><div><br/></div><div><img src="%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B1-8%20-%20HTML%20%E6%96%87%E6%A1%A3%E8%B5%84%E6%BA%90.resources/69E7E286-E302-438F-A64C-A466DFCCC9A9.png" height="auto" width="100%"/><br/></div><div><br/></div><div>
<hr/></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000108817dc7 in WebCore::ResourceHandle::start() at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/platform/network/mac/ResourceHandleMac.mm:234</div></div><div><br/></div><div>此函数太长，列举重点：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#if !PLATFORM(IOS)</div><div>    // 创建平台相关的连接</div><div><div>    createNSURLConnection(</div><div>        ResourceHandle::makeDelegate(shouldUseCredentialStorage),</div><div>        shouldUseCredentialStorage,</div><div>        d-&gt;m_shouldContentSniff || d-&gt;m_context-&gt;localFileContentSniffingEnabled(),</div></div><div>        schedulingBehavior);</div><div>...</div></div><div><br/></div><div>在上述平台（Mac）相关代码中，创建连接，并且处理认证相关细节，不再赘述。</div><div><br/></div><div>启动 runloop:</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>    bool scheduled = false;</div><div>    if (SchedulePairHashSet* scheduledPairs = d-&gt;m_context-&gt;scheduledRunLoopPairs()) {</div><div>        SchedulePairHashSet::iterator end = scheduledPairs-&gt;end();</div><div>        for (SchedulePairHashSet::iterator it = scheduledPairs-&gt;begin(); it != end; ++it) {</div><div>            if (NSRunLoop *runLoop = (*it)-&gt;nsRunLoop()) {</div><div>                [connection() scheduleInRunLoop:runLoop forMode:(NSString *)(*it)-&gt;mode()];</div><div>                scheduled = true;</div><div>            }</div><div>        }</div><div>    }</div></div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>    // Start the connection if we did schedule with at least one runloop.</div><div>    // We can't start the connection until we have one runloop scheduled.</div></div><div>    if (scheduled)</div><div>        // 调用至这里</div><div><div>        [connection() start];</div><div>    else</div><div>        d-&gt;m_startWhenScheduled = true;</div></div></div><div><br/></div><div>
<hr/></div><div><br/></div><div>回退至 WebResourceLoadScheduler::servePendingRequests：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000102e81048 in WebResourceLoadScheduler::servePendingRequests(WebResourceLoadScheduler::HostInformation*, WebCore::ResourceLoadPriority) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebKit/WebCoreSupport/WebResourceLoadScheduler.cpp:275</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><div>void WebResourceLoadScheduler::servePendingRequests(HostInformation* host, ResourceLoadPriority minimumPriority)</div><div>{</div><div>    LOG(ResourceLoading, "WebResourceLoadScheduler::servePendingRequests HostInformation.m_name='%s'", host-&gt;name().latin1().data());</div><div><br/></div></div><div>    auto priority = ResourceLoadPriority::Highest;</div><div>    // 此 while 循环，会按照最高优先级依次启动所有的 resourceLoader</div><div><div>    while (true) {</div><div>        auto&amp; requestsPending = host-&gt;requestsPending(priority);</div></div><div>        while (!requestsPending.isEmpty()) {</div><div><br/></div><div>          ...</div><div><br/></div><div>            resourceLoader-&gt;start();</div><div>        }</div><div>        // 直至遍历完成 返回</div><div><div>        if (priority == minimumPriority)</div><div>            return;</div><div>        --priority;</div><div>    }</div><div>}</div></div></div><div><br/></div><div>
<hr/></div><div><br/></div><div>再回退至：WebCore::CachedResource::load</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000106bc2fee in WebCore::CachedResource::load(WebCore::CachedResourceLoader&amp;, WebCore::ResourceLoaderOptions const&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/cache/CachedResource.cpp:289</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div><div>    m_loader = platformStrategies()-&gt;loaderStrategy()-&gt;loadResource(cachedResourceLoader.frame(), this, request, options);</div><div>    if (!m_loader) {</div><div>        failBeforeStarting();</div><div>        return;</div></div><div>    }</div><div>    // this    WebCore::CachedRawResource *    0x115f93a00    0x0000000115f93a00</div><div>    // m_status    unsigned int    1</div><div>    // 更新状态为 Pending</div><div><div>    m_status = Pending;</div><div>}</div></div></div><div><br/></div><div>
<hr/></div><div><br/></div><div>回退至 WebCore::CachedResourceLoader::requestResource：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#0    0x0000000106bd3222 in WebCore::CachedResourceLoader::requestResource(WebCore::CachedResource::Type, WebCore::CachedResourceRequest&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/loader/cache/CachedResourceLoader.cpp:645</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>    // this    WebCore::CachedResourceLoader *    0x122571dc0    0x0000000122571dc0</div><div>    // m_documentResources    WebCore::CachedResourceLoader::DocumentResourceMap   </div><div>    m_documentResources.set(resource-&gt;url(), resource);</div><div><div>    return resource;</div><div>}</div></div></div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>更新日期：Sat Dec 24 2016 16:00:43 GMT+0800 (CST)</p>
</div></body></html>