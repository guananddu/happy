<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="author" content="管伟"/><meta name="created" content="2016-12-19 07:01:14 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-12-21 09:03:27 +0000"/><title>RenderTree 的构建过程 - 3 - updater.commit(WTFMove(styleUpdate)) 样式应用点 - 1</title></head><body><style>
    a { color: #43B0D6 !important; }
    .title-p { font-size:12px; color:gray; }
    .title-hr { margin-bottom: 20px; }
    .tail-hr { margin-top: 20px; }
    .tail-licenses { border:1px dashed lightgray; margin:20px 0 20px 0; padding:20px; font-size:14px; }
</style>
<h2>RenderTree 的构建过程 - 3 - updater.commit(WTFMove(styleUpdate)) 样式应用点 - 1</h2>
<p class="title-p">版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p class="title-p">文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<hr class="title-hr"><div>进入此步骤的上一步，已经把相关的用户 css 定义解析好，此步骤开始根据 css 样式来给 element 应用样式信息，创建对应的 renderer 等步骤：</div><div>代码最终进入：</div><div/><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x000000010886f35c in WebCore::RenderTreeUpdater::updateRenderTree(WebCore::ContainerNode&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/style/RenderTreeUpdater.cpp:115</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void RenderTreeUpdater::updateRenderTree(ContainerNode&amp; root)</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::RenderTreeUpdater *     0x7fff5fbfce60     0x00007fff5fbfce60</font></span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    m_parentStack 是一个栈数据结构</span></span><br/></font></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_parentStack     WTF::Vector&lt;WebCore::RenderTreeUpdater::Parent, 0, WTF::CrashOnOverflow, 16&gt;     </font></span></span><br/></font></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">root     WebCore::HTMLDocument &amp;     0x0000000116f6d000 【root 即为 HTMLDocument 文档根元素】</font></span><br/></font></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 首先确保 root 元素，是有自己的对应的 renderer 的，即与之对应的 RenderElement 对象</span><br/></font></span></font></span></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(root.renderer());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 再次确保 m_parentStack 这个栈结构是空的</span><br/></font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT(m_parentStack.isEmpty());</font></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span>    // 将 root 元素包装成 Parent 实例对象之后，推入 m_parentStack 栈中</span><br/></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span><span>    // <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_size     unsigned int     1</font></span></span><br/></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    目前里面只有一个 Parent(root) 对象作为栈内容</span></span><br/></font></span></span></span></div><div style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    m_parentStack.append(Parent(root));</font><br/></div><div><font face="Monaco">. . .</font></div><div><font face="Monaco"><span>    // 开始将 root 包装出迭代器</span><br/></font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto descendants = composedTreeDescendants(root);</font></font></div><div><font face="Monaco"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">it     WebCore::ComposedTreeIterator     </font></span><br/></font></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto it = descendants.begin();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto end = descendants.end();</font><font face="Monaco"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">. . .</font></div></div><div><br/></div><div>下面开始进入整体的 while 循环，我们将一个迭代一个迭代地分析其构建细节：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">while (it != end) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // 此句作用是什么？</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    // it.depth() 返回值为 1，应该和 m_parentStack 有关系</span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span>    // 第一次执行 popParentsToDepth 并没有做什么工作，直接跳出了：</span><br/></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/97D9C242-BAB3-48CD-A6C6-C591DFDDE742.png" height="auto" width="100%"/><br/></span><br/></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><span>    // 因为 m_parentStack.size 为 1，depth 也为 1【先不予深究】</span><br/></span></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">popParentsToDepth(it.depth());</font></span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 通过 * 获取到当前节点元素</span><br/></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">node     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span><br/></span></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 看下 it 是什么：</span><br/></font></span></span></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/220B400E-42FD-4003-9C48-1205A5948F71.png" height="auto" width="100%"/><br/></span></font></span></span></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">node     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span><br/></span></font></span></span></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 即第一个开始被处理的即是 HTMLHtmlElement 元素</span><br/></font></span></span></font></span></span></font></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">auto&amp; node = *it;</font></span></font></span></span></font></div><div><span>    // 尝试获取当前节点的 renderer:</span><br/></div><div><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">renderer     WebCore::RenderObject *     NULL     </font></span><br/></span></div><div><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 但是为空！也就是目前 HTMLHtmlElement 元素还没有 renderer</span><br/></font></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (auto* renderer = node.renderer())</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        renderTreePosition().invalidateNextSibling(*renderer);</font></div><div><span>    // 判断是不是文本节点【这里是 HTMLHtmlElement 节点，所以肯定不是文本节点】</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (is&lt;Text&gt;(node)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">element     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 类型转换</span><br/></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto&amp; element = downcast&lt;Element&gt;(node);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::RenderTreeUpdater *     0x7fff5fbfd1d0     0x00007fff5fbfd1d0</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_styleUpdate     std::__1::unique_ptr&lt;WebCore::Style::Update, std::__1::default_delete&lt;WebCore::Style::Update&gt; &gt;     </font></span></span><br/></font></span></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 此一步，来判断新近的 css 样式定义，有没有符合当前元素的样式变化定义【略复杂】</span><br/></font></span></span></font></span></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/647F2747-7C83-4512-B03B-96249F903B41.png" height="auto" width="100%"/><br/></span><br/></span></font></span></span></font></span></div><div><span>    [[</span></div><div><span><span>    <span>    来看下上述截图函数体内的变量分布：</span></span><br/></span></div><div><span><span><span><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::Style::Update *     0x1153f9900     0x00000001153f9900</font></span></span><br/></span></span></span></div><div><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>   <span>    </span> <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_elements     WTF::HashMap&lt;const WebCore::Element *, WebCore::Style::ElementUpdate, WTF::PtrHash&lt;const WebCore::Element *&gt;, WTF::HashTraits&lt;const WebCore::Element *&gt;, WTF::HashTraits&lt;WebCore::Style::ElementUpdate&gt; &gt;     </font></span></span><br/></font></span></span></span></span></span></div><div><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <span>    </span>// m_elements 是一个 HashMap，存储了 element 和 与其对应的 ElementUpdate 信息</span></span><br/></font></span></span></font></span></span></span></span></span></div><div><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    // 此函数整体来说，就是找到当前元素的 css 样式变更信息</span></span><br/></span></span></font></span></span></font></span></span></span></span></span></div><div><span><span>    </span>]]</span><br/></div><div><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">elementUpdate     WebCore::Style::ElementUpdate *     0x1257c2158     0x00000001257c2158</font></span><br/></span></div><div><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 最终的 HTMLHtmlElement 是有变更信息的：</span><br/></font></span></span></div><div><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // 可以看到其最终对应一个 RenderStyle 对象</span><br/></span></font></span></span></div><div><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/96AC6E60-77DA-4B0B-95BC-F3E3466946AF.png" height="auto" width="100%"/><br/></span><br/></span></font></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto* elementUpdate = m_styleUpdate-&gt;elementUpdate(element);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!elementUpdate) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 如果没有直接跳走</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        it.traverseNextSkippingChildren();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        continue;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><span>    // 此函数具体分析见下</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    updateElementRenderer(element, *elementUpdate);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    bool mayHaveRenderedDescendants = element.renderer() || (element.hasDisplayContents() &amp;&amp; shouldCreateRenderer(element, renderTreePosition().parent()));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!mayHaveRenderedDescendants) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        it.traverseNextSkippingChildren();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        continue;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><span>    // 最后将当前元素 push 入栈；同时在这里更新 before 和 after 为元素</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    pushParent(element, elementUpdate ? elementUpdate-&gt;change : Style::NoChange);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    it.traverseNext();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div></div><div><br/></div><div>进入 updateElementRenderer 函数细节：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001087d5a3b in WebCore::RenderTreeUpdater::updateElementRenderer(WebCore::Element&amp;, WebCore::Style::ElementUpdate&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/style/RenderTreeUpdater.cpp:243</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void RenderTreeUpdater::updateElementRenderer(Element&amp; element, Style::ElementUpdate&amp; update)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::RenderTreeUpdater *     0x7fff5fbfd1d0     0x00007fff5fbfd1d0</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">element     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">update     WebCore::Style::ElementUpdate &amp;     0x00000001257c2158</font></span><br/></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/96AC6E60-77DA-4B0B-95BC-F3E3466946AF.png" height="auto" width="100%"/><br/></span><br/></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // 先判断是不是应该“卸掉”renderer；在 Style::Detach 状态且没有 renderer 的状态下会进行 teardown</span><br/></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">shouldTearDownRenderers     bool     false</font></span><br/></span></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    bool shouldTearDownRenderers = update.change == Style::Detach &amp;&amp; (element.renderer() || element.isNamedFlowContentNode());</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (shouldTearDownRenderers)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        tearDownRenderers(element, TeardownType::KeepHoverAndActive);</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">hasDisplayContest     bool     false</font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // display:contents 是什么意思呢？看标准：</span><br/></font></span></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/599DD547-D7A5-4113-B002-31DE85203923.png" height="auto" width="100%"/><br/></span><br/></span></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    bool hasDisplayContest = update.style &amp;&amp; update.style-&gt;display() == CONTENTS;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    element.setHasDisplayContents(hasDisplayContest);</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">shouldCreateNewRenderer     bool     true 应该创建 renderer 的条件</font></span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    bool shouldCreateNewRenderer = !element.renderer() &amp;&amp; update.style &amp;&amp; !hasDisplayContest;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (shouldCreateNewRenderer) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 走入创建分支</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        if (element.hasCustomStyleResolveCallbacks())</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">            element.willAttachRenderers(); // 没有走入这里</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 大函数分析见下</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        createRenderer(element, WTFMove(*update.style));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        invalidateWhitespaceOnlyTextSiblingsAfterAttachIfNeeded(element);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><br/></div><div><span>    // 下面是不用创建 renderer 的逻辑分支，之后再分析</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    . . .</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div></div><div><br/></div><div>进入 createRenderer 函数细节：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001087d68c7 in WebCore::RenderTreeUpdater::createRenderer(WebCore::Element&amp;, WebCore::RenderStyle&amp;&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/style/RenderTreeUpdater.cpp:294</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">void RenderTreeUpdater::createRenderer(Element&amp; element, RenderStyle&amp;&amp; style)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::RenderTreeUpdater *     0x7fff5fbfd1d0     0x00007fff5fbfd1d0</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">element     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">style     WebCore::RenderStyle &amp;&amp;     0x0000000115250780</font></span><br/></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 这个判断是最后一步是否创建 renderer 的逻辑判断:</span><br/></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/B3F077DF-3C76-4EE2-8D80-0D99C640F021.png" height="auto" width="100%"/><br/></span><br/></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    [[</span></span></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">element     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span></span></span></span></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">parentRenderer     WebCore::RenderView &amp;     0x00000001173aba00</font></span></span><br/></font></span></span></span></span></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    element 就是当前正要处理的元素节点</span></span><br/></font></span></span></font></span></span></span></span></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    而 parentRenderer 正如其名，就是 element 父元素对应的 renderer 【推测是没有创建的】</span></span><br/></span></span></font></span></span></font></span></span></span></span></span></font></span></font></span></font></span></font></div><div><span>    <span>    通过 m_parentStack 栈来维护</span></span><br/></div><div><span><span><span>    <span>    // 此处的逻辑还需要进一步分析【TODO】</span></span><br/></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span>    </span>]]</span><br/></span></span></font></span></font></span></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!shouldCreateRenderer(element, renderTreePosition().parent()))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    RenderNamedFlowThread* parentFlowRenderer = nullptr;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#if ENABLE(CSS_REGIONS)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 实验属性先不考虑</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    parentFlowRenderer = moveToFlowThreadIfNeeded(element, style);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#endif</font></div><div><span>    // 这里再次判断是不是需要创建 renderer</span><br/></div><div><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/02740FD4-7901-43AE-86BC-84ECBE010FE2.png" height="auto" width="100%"/><br/></span><br/></span></div><div><span><span><span>    // 在此确保 display 不为 none 和 contents</span><br/></span></span></div><div><span><span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/0109B2A5-3574-43AC-9C79-1D97D0EB600B.png" height="auto" width="100%"/><br/></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!element.rendererIsNeeded(style))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div><span>    // <font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);">renderTreePosition 返回 <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">WebCore::RenderTreeUpdater 的 <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_parentStack 中最后一个拥有 renderTreePosition 的 Parent 元素</font></font></font></span><br/></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 即当前正在处理的 element 元素的父元素的 Parent 包裹对象</span><br/></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    // 第一次 HTMLHtmlElement 运行 computeNextSibling 时：</span></span></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    [[</span></span></span></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">this     WebCore::RenderTreePosition *     0x1257c2318     0x00000001257c2318</font></span></span><br/></span></span></span></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_nextSibling     WebCore::RenderObject *     NULL     0x0000000000000000 </font></span></span><br/></font></span></span></span></span></span></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_hasValidNextSibling     bool     true</font></span></span><br/></font></span></span></font></span></span></span></span></span></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/B6704A1C-AF1E-4FD5-B28C-1D68464D552A.png" height="auto" width="100%"/><br/></span></span></font></span></span></font></span></span></font></span></span></span></span></span></font></font></font></span></div><div><span><font style="font-family: Monaco; font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51);"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    ]]</span><br/></span></span></font></font></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    renderTreePosition().computeNextSibling(element);</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">insertionPosition     WebCore::RenderTreePosition     </font></span><br/></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_parent     WebCore::RenderView &amp;     0x00000001173aba00</font></span></span><br/></font></span></div><div><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    //<span>     <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">m_nextSibling     WebCore::RenderObject *     NULL     0x0000000000000000</font></span></span><br/></font></span></span></font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    RenderTreePosition insertionPosition = parentFlowRenderer</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        ? RenderTreePosition(*parentFlowRenderer, parentFlowRenderer-&gt;nextRendererForElement(element))</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        : renderTreePosition();</font></div><div><span>    // 这里又是比较重要的一个步骤，见下分析</span><br/></div><div><span><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">newRenderer     WebCore::RenderBlockFlow *     0x1257a2348     0x00000001257a2348</font></span><br/></span></div><div><span><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 创建成功</span><br/></font></span></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    RenderElement* newRenderer = element.createElementRenderer(WTFMove(style), insertionPosition).leakPtr();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!newRenderer)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (!insertionPosition.canInsert(*newRenderer)) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        newRenderer-&gt;destroy();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Make sure the RenderObject already knows it is going to be added to a RenderFlowThread before we set the style</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // for the first time. Otherwise code using inRenderFlowThread() in the styleWillChange and styleDidChange will fail.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    newRenderer-&gt;setFlowThreadState(insertionPosition.parent().flowThreadState());</font></div><div><span>    // 设置自己的 renderer 对象</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    element.setRenderer(newRenderer);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    auto&amp; initialStyle = newRenderer-&gt;style();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    std::unique_ptr&lt;RenderStyle&gt; animatedStyle;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    newRenderer-&gt;animation().updateAnimations(*newRenderer, initialStyle, animatedStyle);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (animatedStyle)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        newRenderer-&gt;setStyleInternal(WTFMove(*animatedStyle));</font></div><div><span>    // 【TODO】这的逻辑比较复杂／之后单独分析</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    newRenderer-&gt;initializeStyle();</font></div><div><br/></div><div><span>    . . .</span><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Note: Adding newRenderer instead of renderer(). renderer() may be a child of newRenderer.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 最终将 renderer 插入 rendertree</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    [[</span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001084c8462 in WebCore::RenderBlockFlow::addChild(WebCore::RenderObject*, WebCore::RenderObject*) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/rendering/RenderBlockFlow.cpp:3859</font></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/F610B8A3-FB50-4C98-B654-47C9ECDEFDB1.png" height="auto" width="100%"/><br/></span></span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>    <span>    【TODO】这里的逻辑也很复杂</span></span><br/></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    ]]</span><br/></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    insertionPosition.insert(*newRenderer);</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (AXObjectCache* cache = m_document.axObjectCache())</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        cache-&gt;updateCacheAfterNodeIsAttached(&amp;element);</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font><br/></div></div><div><br/></div><div>真正开始创建 RenderElement 对象：</div><div/><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x000000010854b4a6 in WebCore::RenderElement::createFor(WebCore::Element&amp;, WebCore::RenderStyle&amp;&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/rendering/RenderElement.cpp:155</font></div><div><br/></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">RenderPtr&lt;RenderElement&gt; RenderElement::createFor(Element&amp; element, RenderStyle&amp;&amp; style)</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">{</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">element     WebCore::HTMLHtmlElement &amp;     0x00000001152ae680</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">style     WebCore::RenderStyle &amp;&amp;     0x0000000115250780</font></span><br/></font></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Minimal support for content properties replacing an entire element.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Works only if we have exactly one piece of content and it's a URL.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    // Otherwise acts as if we didn't support this feature.</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">contentData     const WebCore::ContentData *     NULL     0x0000000000000000</font></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    const ContentData* contentData = style.contentData();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    if (contentData &amp;&amp; !contentData-&gt;next() &amp;&amp; is&lt;ImageContentData&gt;(*contentData) &amp;&amp; !element.isPseudoElement()) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        . . . // 先不考虑</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><span>    // <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">(lldb) print style.display()</font></span></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // </span>(WebCore::EDisplay) $44 = BLOCK</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    // 即 HTMLHtmlElement 节点应该是 BLOCK 类型节点</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    switch (style.display()) {</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    case NONE:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    case CONTENTS:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return nullptr;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    case INLINE:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return createRenderer&lt;RenderInline&gt;(element, WTFMove(style));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    case BLOCK:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    case INLINE_BLOCK:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    case COMPACT:</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    <span>    // 走入此分支，上面三种，创建 RenderBlockFlow 对象</span></span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    <span>    [[</span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>    <span>    <span>    <font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">#0     0x00000001084ad2f5 in WebCore::RenderBlockFlow::RenderBlockFlow(WebCore::Element&amp;, WebCore::RenderStyle&amp;&amp;) at /Users/mrguan/work/svn/Webkit/WebKit/Source/WebCore/rendering/RenderBlockFlow.cpp:106</font></span></span></span></span></span></span></span></font></div><div><br/><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span><span><span/></span></span><span>    <span>    <span>    <img src="RenderTree%20%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%20-%203%20-%20updater.commit(WTFMove(styleUpdate))%20%E6%A0%B7%E5%BC%8F%E5%BA%94%E7%94%A8%E7%82%B9%20-%201.resources/19C7BF74-6A39-4674-8F2C-3C950565936E.png" height="auto" width="100%"/><br/></span></span></span><br/></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>    <span>    </span></span>]]</span></span><br/></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span><span><span>    <span>    // 最终返回 RenderBlockFlow</span></span><br/></span></span></span></span></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">        return createRenderer&lt;RenderBlockFlow&gt;(element, WTFMove(style));</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><span>    . . .</span><br/></font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    }</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ASSERT_NOT_REACHED();</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    return nullptr;</font></div><div><font style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">}</font></div></div><div><br/></div><div>关于 newRenderer-&gt;initializeStyle() 的具体逻辑见下节</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div>

<hr class="tail-hr">
<div class="tail-licenses">
<p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>文章作者：Pooky (<a href="mailto:guananddu@icloud.com">guananddu@icloud.com</a>)</p>
<p>更新日期：Thu Dec 22 2016 14:39:19 GMT+0800 (CST)</p>
</div></body></html>